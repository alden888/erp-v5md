<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç³»ç»Ÿè¯Šæ–­ - V14.2 PRO</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: system-ui, sans-serif; background: #030712; }
.status-ok { color: #10b981; }
.status-error { color: #ef4444; }
.status-warning { color: #f59e0b; }
</style>
</head>
<body class="text-white p-8">
<div class="max-w-4xl mx-auto">
<h1 class="text-3xl font-bold mb-8 text-red-500">ğŸ” ç³»ç»Ÿè¯Šæ–­å·¥å…·</h1>

<div id="results" class="space-y-4">
<div class="bg-gray-900 p-4 rounded-lg">
<p class="text-gray-400">æ­£åœ¨æ£€æµ‹...</p>
</div>
</div>

<button onclick="location.reload()" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold transition-colors mr-4">
é‡æ–°æ£€æµ‹
</button>
<a href="/workbench/index.html" class="inline-block mt-6 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold transition-colors">
è¿”å›ä¸»é¡µé¢
</a>

<div class="mt-8 p-4 bg-gray-900 rounded-lg">
<h3 class="font-bold mb-2">å»ºè®®æ“ä½œï¼š</h3>
<ol id="suggestions" class="list-decimal list-inside space-y-1 text-sm text-gray-400">
<li>ç­‰å¾…è¯Šæ–­å®Œæˆ...</li>
</ol>
</div>
</div>

<!-- ğŸ”¥ åŠ è½½æ¨¡å—ä»¥ä¾¿æ£€æµ‹ - ä½¿ç”¨ç»å¯¹è·¯å¾„ -->
<script src="/workbench/js/workbench-config.js"></script>
<script src="/workbench/js/workbench-utils.js"></script>
<script src="/workbench/js/workbench-modal.js"></script>
<script src="/workbench/js/workbench-state.js"></script>
<script src="/workbench/js/workbench-storage.js"></script>
<script src="/workbench/js/workbench-auth.js"></script>
<script src="/workbench/js/workbench-dashboard.js"></script>
<script src="/workbench/js/workbench-orders.js"></script>
<script src="/workbench/js/workbench-suppliers.js"></script>
<script src="/workbench/js/workbench-finance.js"></script>
<script src="/workbench/js/workbench-expenses.js"></script>
<script src="/workbench/js/workbench-crm.js"></script>

<script>
const results = document.getElementById('results');
const suggestions = document.getElementById('suggestions');

function addResult(title, status, message) {
const statusClass = status === 'ok' ? 'status-ok' : status === 'error' ? 'status-error' : 'status-warning';
const icon = status === 'ok' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸';
const div = document.createElement('div');
div.className = 'bg-gray-900 p-4 rounded-lg';
div.innerHTML = `
<div class="flex items-start gap-3">
<span class="text-2xl">${icon}</span>
<div class="flex-1">
<h3 class="font-bold ${statusClass}">${title}</h3>
<p class="text-sm text-gray-400 mt-1">${message}</p>
</div>
</div>
`;
results.appendChild(div);
}

async function diagnose() {
results.innerHTML = '';
const issues = [];

// 1. æ£€æŸ¥å½“å‰ URL
const currentUrl = window.location.href;
addResult(
'å½“å‰ URL',
'ok',
`è®¿é—®åœ°å€: ${currentUrl}`
);

// 2. æ£€æŸ¥è·¯å¾„æ ¼å¼
const basePath = window.location.pathname;
const isInWorkbench = basePath.includes('/workbench');
addResult(
'è·¯å¾„æ£€æµ‹',
isInWorkbench ? 'ok' : 'warning',
`å½“å‰è·¯å¾„: ${basePath}<br>æ£€æµ‹åˆ°å­ç›®å½•: ${isInWorkbench ? 'æ˜¯ (/workbench)' : 'å¦'}`
);

// 3. æ£€æŸ¥ JS æ¨¡å—
const modules = [
'WorkbenchConfig',
'WorkbenchUtils',
'WorkbenchModal',
'WorkbenchState',
'WorkbenchStorage',
'WorkbenchAuth',
'WorkbenchDashboard',
'WorkbenchOrders',
'WorkbenchSuppliers',
'WorkbenchFinance',
'WorkbenchExpenses',
'WorkbenchCRM'
];

let loadedCount = 0;
const loadedList = [];
const missingList = [];

modules.forEach(mod => {
if (typeof window[mod] !== 'undefined') {
loadedCount++;
loadedList.push(mod);
} else {
missingList.push(mod);
}
});

if (loadedCount === modules.length) {
addResult(
'JavaScript æ¨¡å—',
'ok',
`æ‰€æœ‰æ¨¡å—å·²åŠ è½½ (${loadedCount}/${modules.length})`
);
} else if (loadedCount > 0) {
addResult(
'JavaScript æ¨¡å—',
'warning',
`éƒ¨åˆ†æ¨¡å—å·²åŠ è½½ (${loadedCount}/${modules.length})<br>
<span class="text-green-400">å·²åŠ è½½: ${loadedList.join(', ')}</span><br>
<span class="text-red-400">ç¼ºå¤±: ${missingList.join(', ')}</span>`
);
issues.push('æ£€æŸ¥ç¼ºå¤±æ¨¡å—çš„ JS æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
} else {
addResult(
'JavaScript æ¨¡å—',
'error',
`æ‰€æœ‰æ¨¡å—æœªåŠ è½½ (${loadedCount}/${modules.length})<br>ç¼ºå¤±: ${missingList.join(', ')}`
);
issues.push('æ£€æŸ¥ /workbench/js/ æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æ˜¯å¦å®Œæ•´');
issues.push('æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ 404 é”™è¯¯');
issues.push('ç¡®è®¤ _headers å’Œ _redirects é…ç½®æ­£ç¡®');
}

// 4. æ£€æŸ¥ localStorage
try {
localStorage.setItem('test', 'test');
localStorage.removeItem('test');
addResult(
'localStorage',
'ok',
'æœ¬åœ°å­˜å‚¨å¯ç”¨'
);
} catch (e) {
addResult(
'localStorage',
'error',
`æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨: ${e.message}`
);
issues.push('æ£€æŸ¥æµè§ˆå™¨éšç§è®¾ç½®ï¼Œç¡®ä¿å…è®¸æœ¬åœ°å­˜å‚¨');
}

// 5. æ£€æŸ¥ Firebase
if (typeof firebase !== 'undefined') {
addResult(
'Firebase SDK',
'ok',
'Firebase SDK å·²åŠ è½½'
);
} else {
addResult(
'Firebase SDK',
'warning',
'Firebase SDK æœªåŠ è½½ï¼ˆäº‘åŒæ­¥å°†ä¸å¯ç”¨ï¼‰'
);
}

// 6. æ£€æŸ¥ CSS
const cssLoaded = document.styleSheets.length > 0;
if (cssLoaded) {
addResult(
'CSS æ ·å¼',
'ok',
`å·²åŠ è½½ ${document.styleSheets.length} ä¸ªæ ·å¼è¡¨`
);
} else {
addResult(
'CSS æ ·å¼',
'warning',
'æœªæ£€æµ‹åˆ°æ ·å¼è¡¨'
);
issues.push('æ£€æŸ¥ /workbench/css/workbench-v14.css æ˜¯å¦å­˜åœ¨');
}

// 7. æµ‹è¯• JS æ–‡ä»¶å¯è®¿é—®æ€§
try {
const testUrl = '/workbench/js/workbench-config.js';
const response = await fetch(testUrl, { method: 'HEAD' });
const contentType = response.headers.get('content-type') || 'unknown';
    
if (response.ok) {
addResult(
'JS æ–‡ä»¶è®¿é—®',
contentType.includes('javascript') ? 'ok' : 'warning',
`${testUrl}<br>çŠ¶æ€: ${response.status}<br>Content-Type: ${contentType}`
);
        
if (!contentType.includes('javascript')) {
issues.push('JS æ–‡ä»¶çš„ Content-Type ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥ _headers é…ç½®');
}
} else {
addResult(
'JS æ–‡ä»¶è®¿é—®',
'error',
`${testUrl}<br>HTTP ${response.status} - ${response.statusText}`
);
issues.push('JS æ–‡ä»¶æ— æ³•è®¿é—®ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨');
}
} catch (e) {
addResult(
'JS æ–‡ä»¶è®¿é—®',
'error',
`æ— æ³•æµ‹è¯• JS æ–‡ä»¶: ${e.message}`
);
issues.push('ç½‘ç»œè¿æ¥é—®é¢˜');
}

// 8. æ£€æŸ¥ç½‘ç»œè¿æ¥
try {
const response = await fetch('/workbench/index.html', { method: 'HEAD' });
if (response.ok) {
addResult(
'ç½‘ç»œè¿æ¥',
'ok',
'å¯ä»¥è®¿é—®æœåŠ¡å™¨èµ„æº'
);
} else {
addResult(
'ç½‘ç»œè¿æ¥',
'error',
`HTTP ${response.status} - ${response.statusText}`
);
issues.push('æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
}
} catch (e) {
addResult(
'ç½‘ç»œè¿æ¥',
'error',
`æ— æ³•è¿æ¥æœåŠ¡å™¨: ${e.message}`
);
issues.push('æ£€æŸ¥ç½‘ç»œè¿æ¥');
}

// 9. æµè§ˆå™¨ä¿¡æ¯
addResult(
'æµè§ˆå™¨ä¿¡æ¯',
'ok',
`${navigator.userAgent.split('(')[1]?.split(')')[0] || 'Unknown'}`
);

// ç”Ÿæˆå»ºè®®
if (issues.length === 0) {
suggestions.innerHTML = '<li class="text-green-500">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼å¯ä»¥è¿”å›ä¸»é¡µé¢ä½¿ç”¨ã€‚</li>';
} else {
suggestions.innerHTML = issues.map(issue => `<li>${issue}</li>`).join('');
}
}

// é¡µé¢åŠ è½½åå»¶è¿Ÿæ‰§è¡Œè¯Šæ–­ï¼ˆç­‰å¾…è„šæœ¬åŠ è½½ï¼‰
window.addEventListener('load', function() {
setTimeout(diagnose, 1000);
});
</script>
</body>
</html>
