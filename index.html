<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>æˆ˜æ—¶æŒ‡æŒ¥å° V14.4 PRO ERP EDITION Â· å®Œå…¨ä¿®å¤ç‰ˆ</title>
    
    <!-- é¢„è¿æ¥ä¼˜åŒ– -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // ç”Ÿäº§ç¯å¢ƒæ—¥å¿—æ§åˆ¶
        const isDev = window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1');
        const log = isDev ? console.log.bind(console) : () => {};
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 1: '#0a0a0a', 2: '#141414', 3: '#1e1e1e', 4: '#282828' },
                        accent: { red: '#dc2626', orange: '#ea580c', yellow: '#ca8a04', green: '#16a34a', blue: '#2563eb', purple: '#9333ea' },
                        column: '#0d1117'
                    },
                    fontFamily: {
                        sans: ['Space Grotesk', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 2s linear infinite'
                    }
                }
            }
        }
    </script>

    <style>
        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; margin: 0; padding: 0; }
        
        body {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #141414 50%, #0d1117 100%);
            color: #e5e7eb;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(220,38,38,0.4); border-radius: 3px; transition: background 0.2s; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(220,38,38,0.6); }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .loading-spinner {
            border: 3px solid rgba(220, 38, 38, 0.1);
            border-top-color: #dc2626;
            border-radius: 50%;
            width: 48px; height: 48px;
            animation: spin 0.8s linear infinite;
        }

        /* Tab åˆ‡æ¢ */
        .tab-content { display: none; height: calc(100vh - 64px); overflow-y: auto; }
        .tab-content.active { display: block; animation: fadeIn 0.25s ease-out; }
        
        /* çœ‹æ¿ä¸“ç”¨å¸ƒå±€ */
        #tab-kanban.active { display: flex; flex-direction: column; overflow: hidden; }
        .kanban-board { flex: 1; display: flex; gap: 1rem; overflow-x: auto; overflow-y: hidden; padding: 1rem 1.5rem; scroll-behavior: smooth; }
        .kanban-column { flex: 0 0 300px; display: flex; flex-direction: column; max-height: 100%; background: rgba(13,17,23,0.9); backdrop-filter: blur(12px); border-radius: 0.75rem; border: 1px solid rgba(75,85,99,0.3); }
        .kanban-column-header { padding: 1rem; border-bottom: 1px solid rgba(75,85,99,0.2); }
        .kanban-cards { flex: 1; overflow-y: auto; padding: 0.75rem; min-height: 100px; }
        
        /* çœ‹æ¿å¡ç‰‡ */
        .kanban-card {
            background: rgba(20,20,20,0.95);
            border: 1px solid rgba(75,85,99,0.3);
            border-radius: 0.5rem;
            padding: 0.875rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kanban-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* ç»ç’ƒæ€ */
        .glass {
            background: rgba(20,20,20,0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(75,85,99,0.3);
        }

        /* ç”Ÿå­˜æ¨¡å¼é®ç½© */
        .survival-lock { display: flex; }
        .survival-lock.hidden { display: none; }

        /* ç§»åŠ¨å¯¼èˆª */
        .mobile-nav {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0a0a0a 0%, #141414 100%);
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .mobile-nav.active { transform: translateX(0); }

        /* å¯¼èˆªé«˜äº® */
        .nav-tab.active { color: white; background: rgba(255,255,255,0.1); }

        /* Toast æ ·å¼ */
        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .toast.success { background: linear-gradient(135deg, #16a34a, #15803d); color: white; }
        .toast.error { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; }
        .toast.warning { background: linear-gradient(135deg, #ca8a04, #a16207); color: white; }
        .toast.info { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-overlay.hidden { display: none; }
        .modal-content {
            background: linear-gradient(135deg, #1e1e1e, #141414);
            border: 1px solid rgba(75,85,99,0.5);
            border-radius: 1rem;
            width: 100%;
            max-width: 480px;
            padding: 1.5rem;
            animation: fadeIn 0.2s ease-out;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .kanban-column { flex: 0 0 260px; }
            .kanban-board { padding: 0.75rem; gap: 0.75rem; }
        }
    </style>
</head>
<body>
    <!-- ==================== ç”Ÿå­˜æ¨¡å¼é®ç½© ==================== -->
    <div id="survival-curtain" class="survival-lock fixed inset-0 z-[999] bg-black/95 backdrop-blur-md flex items-center justify-center">
        <div class="w-full max-w-md mx-4 text-center">
            <div class="text-6xl mb-6">âš”ï¸</div>
            <h1 class="text-3xl font-black text-white mb-2">
                <span class="text-red-500">V5</span> COMMANDER
            </h1>
            <p class="text-gray-400 mb-8 text-sm">è¾“å…¥ä»Šæ—¥ä¸‰ä»¶äº‹ï¼Œè§£é”æˆ˜åœº</p>
            
            <div class="space-y-3 mb-6">
                <input id="action-1" type="text" placeholder="ğŸ¯ æœ€é‡è¦çš„äº‹" oninput="app.survival.checkInputs()"
                    class="w-full bg-dark-2 border border-dark-4 rounded-lg p-4 text-white placeholder-gray-600 focus:border-red-500 focus:outline-none transition text-center">
                <input id="action-2" type="text" placeholder="ğŸ“‹ ç¬¬äºŒä»¶äº‹" oninput="app.survival.checkInputs()"
                    class="w-full bg-dark-2 border border-dark-4 rounded-lg p-4 text-white placeholder-gray-600 focus:border-red-500 focus:outline-none transition text-center">
                <input id="action-3" type="text" placeholder="âœ… ç¬¬ä¸‰ä»¶äº‹" oninput="app.survival.checkInputs()"
                    class="w-full bg-dark-2 border border-dark-4 rounded-lg p-4 text-white placeholder-gray-600 focus:border-red-500 focus:outline-none transition text-center">
            </div>

            <button id="battle-start-btn" disabled onclick="app.survival.unlock()"
                class="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 disabled:from-gray-700 disabled:to-gray-600 disabled:cursor-not-allowed text-white font-bold py-4 rounded-lg transition shadow-xl text-lg">
                å¼€å¯ä»Šæ—¥æˆ˜æ–—
            </button>

            <button onclick="app.survival.emergency()" class="mt-4 text-gray-600 hover:text-gray-400 text-sm transition">
                ç´§æ€¥è¿›å…¥ (10åˆ†é’Ÿ)
            </button>
        </div>
    </div>

    <!-- ==================== é¡¶éƒ¨å¯¼èˆª ==================== -->
    <header class="fixed top-0 left-0 right-0 h-16 bg-dark-1/95 backdrop-blur-md border-b border-dark-4/50 z-50 px-4 md:px-6 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="font-black text-lg tracking-tight text-white">
                <span class="text-red-500">V5</span> COMMANDER
            </div>
            <div id="emergency-warning" class="hidden px-2.5 py-1 bg-red-900/40 border border-red-500/30 rounded text-red-400 text-[10px] font-bold animate-pulse-slow">
                âš ï¸ EMERGENCY <span id="emergency-timer">10:00</span>
            </div>
        </div>

        <nav class="hidden md:flex items-center gap-1">
            <button onclick="app.switchTab('dashboard')" class="nav-tab active px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="dashboard">
                <i class="fas fa-chart-pie mr-2"></i>ä»ªè¡¨ç›˜
            </button>
            <button onclick="app.switchTab('kanban')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="kanban">
                <i class="fas fa-columns mr-2"></i>è®¢å•æˆ˜åœº
            </button>
            <button onclick="app.switchTab('crm')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="crm">
                <i class="fas fa-address-book mr-2"></i>å®¢æˆ·
            </button>
            <button onclick="app.switchTab('suppliers')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="suppliers">
                <i class="fas fa-industry mr-2"></i>ä¾›åº”å•†
            </button>
            <button onclick="app.switchTab('expenses')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="expenses">
                <i class="fas fa-wallet mr-2"></i>æ”¯å‡º
            </button>
        </nav>

        <div class="flex items-center gap-3">
            <button class="md:hidden text-gray-400 hover:text-white p-2 transition" onclick="document.querySelector('.mobile-nav').classList.add('active')">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="hidden md:flex items-center gap-3">
                <span id="sync-status" class="text-xs text-gray-500 flex items-center gap-1.5">
                    <i class="fas fa-circle text-green-500 text-[8px]"></i>æœ¬åœ°
                </span>
                <button onclick="app.logout()" class="text-gray-500 hover:text-red-400 p-2 transition" title="é€€å‡ºç³»ç»Ÿ">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ==================== ç§»åŠ¨ç«¯å¯¼èˆª ==================== -->
    <div class="mobile-nav flex flex-col p-6">
        <div class="flex justify-end mb-8">
            <button onclick="document.querySelector('.mobile-nav').classList.remove('active')" class="text-gray-400 hover:text-white text-2xl transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex flex-col gap-2">
            <button onclick="app.switchTab('dashboard'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition">
                <i class="fas fa-chart-pie mr-3 w-6"></i>ä»ªè¡¨ç›˜
            </button>
            <button onclick="app.switchTab('kanban'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition">
                <i class="fas fa-columns mr-3 w-6"></i>è®¢å•æˆ˜åœº
            </button>
            <button onclick="app.switchTab('crm'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition">
                <i class="fas fa-address-book mr-3 w-6"></i>å®¢æˆ·æ¡£æ¡ˆ
            </button>
            <button onclick="app.switchTab('suppliers'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition">
                <i class="fas fa-industry mr-3 w-6"></i>ä¾›åº”å•†
            </button>
            <button onclick="app.switchTab('expenses'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition">
                <i class="fas fa-wallet mr-3 w-6"></i>è¿è¥æ”¯å‡º
            </button>
        </div>
        <div class="mt-auto pt-6 border-t border-dark-4">
            <button onclick="app.logout()" class="w-full text-left text-gray-500 hover:text-red-400 py-3 px-4 rounded-lg hover:bg-dark-3 transition">
                <i class="fas fa-power-off mr-3 w-6"></i>é€€å‡ºç³»ç»Ÿ
            </button>
        </div>
    </div>

    <!-- ==================== ä¸»å†…å®¹åŒº ==================== -->
    <main class="pt-16 h-full">
        
        <!-- ä»ªè¡¨ç›˜ Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="container mx-auto p-6">
                <!-- KPI å¡ç‰‡ -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="glass rounded-xl p-5 hover:border-blue-500/30 transition group">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-chart-line text-blue-500"></i> Total Revenue
                        </div>
                        <!-- å…¼å®¹ä¸¤ç§IDå‘½å -->
                        <div class="text-2xl font-bold text-blue-400 font-mono" id="kpi-revenue">Â¥0.00</div>
                        <div class="text-xs text-gray-600 mt-2" id="dashboard-total-orders">è®¢å•: 0</div>
                    </div>
                    <div class="glass rounded-xl p-5 hover:border-green-500/30 transition group">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-coins text-green-500"></i> Gross Profit
                        </div>
                        <div class="text-2xl font-bold text-green-400 font-mono" id="kpi-gross">Â¥0.00</div>
                        <div class="text-xs text-gray-600 mt-2" id="dashboard-pending-orders">å¾…å¤„ç†: 0</div>
                    </div>
                    <div class="glass rounded-xl p-5 hover:border-purple-500/30 transition group">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-piggy-bank text-purple-500"></i> Net Profit
                        </div>
                        <div class="text-2xl font-bold text-purple-400 font-mono" id="kpi-net">Â¥0.00</div>
                        <div class="text-xs text-gray-600 mt-2" id="dashboard-completed-orders">å·²å®Œæˆ: 0</div>
                    </div>
                    <div class="glass rounded-xl p-5 hover:border-red-500/30 transition relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 text-7xl text-red-500/10 group-hover:text-red-500/20 transition">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="text-xs text-red-400 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-heartbeat text-red-500"></i> Survival Status
                        </div>
                        <div class="text-xl font-bold text-white">72h Safe</div>
                        <div class="text-xs text-red-400/70 mt-2">è·ä¸Šæ¬¡è¿›è´¦: <span id="hours-since-income" class="font-mono">0</span>h</div>
                    </div>
                </div>

                <!-- é¢å¤–ç»Ÿè®¡ä¿¡æ¯ï¼ˆå…¼å®¹Dashboardæ¨¡å—ï¼‰ -->
                <div class="hidden">
                    <span id="dashboard-total-income">0</span>
                    <span id="dashboard-month-income">0</span>
                    <span id="dashboard-total-suppliers">0</span>
                    <span id="dashboard-net-profit">0</span>
                </div>

                <!-- ä»Šæ—¥è¡ŒåŠ¨ -->
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-4 flex items-center gap-2">
                        <i class="fas fa-bullseye text-red-500"></i> Today's Focus
                    </h3>
                    <div id="actions-display" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass rounded-xl p-5 text-center text-gray-500">
                            <i class="fas fa-clipboard-list text-3xl mb-3 opacity-30"></i>
                            <p class="text-sm">å®Œæˆç”Ÿå­˜æ¨¡å¼ç™»å½•åæ˜¾ç¤ºä»Šæ—¥è¡ŒåŠ¨</p>
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·æ“ä½œ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="app.kanban.openQuickAdd()" class="glass p-5 rounded-xl hover:bg-blue-900/20 hover:border-blue-500/30 transition text-sm font-medium group">
                        <i class="fas fa-plus mb-3 block text-xl text-blue-500 group-hover:scale-110 transition-transform"></i> æ–°å¢è®¢å•
                    </button>
                    <button onclick="app.crm.openAddModal()" class="glass p-5 rounded-xl hover:bg-green-900/20 hover:border-green-500/30 transition text-sm font-medium group">
                        <i class="fas fa-user-plus mb-3 block text-xl text-green-500 group-hover:scale-110 transition-transform"></i> å½•å…¥å®¢æˆ·
                    </button>
                    <button onclick="app.expenses.openAddModal()" class="glass p-5 rounded-xl hover:bg-yellow-900/20 hover:border-yellow-500/30 transition text-sm font-medium group">
                        <i class="fas fa-receipt mb-3 block text-xl text-yellow-500 group-hover:scale-110 transition-transform"></i> è®°ä¸€ç¬”è´¦
                    </button>
                    <button onclick="app.exportData()" class="glass p-5 rounded-xl hover:bg-gray-700/30 hover:border-gray-500/30 transition text-sm font-medium group">
                        <i class="fas fa-download mb-3 block text-xl text-gray-400 group-hover:scale-110 transition-transform"></i> å¤‡ä»½æ•°æ®
                    </button>
                </div>
            </div>
        </div>

        <!-- çœ‹æ¿ Tab -->
        <div id="tab-kanban" class="tab-content">
            <div class="h-14 px-6 flex items-center justify-between border-b border-dark-4/50 bg-dark-1/80 backdrop-blur-sm">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-columns text-blue-500"></i> ä½œæˆ˜æŒ‡æŒ¥æ¿
                </h2>
                <button onclick="app.kanban.openQuickAdd()" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-blue-900/20 flex items-center gap-2">
                    <i class="fas fa-plus"></i> ç«‹é¡¹
                </button>
            </div>

            <div class="kanban-board" id="kanban-wrapper">
                <!-- è¯¢ç›˜åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-400 text-sm font-bold uppercase tracking-wide">New Inquiry</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-inquiry">0</span>
                        </div>
                    </div>
                    <div id="kanban-inquiry" class="kanban-cards"></div>
                </div>

                <!-- PIå·²å‘åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-400 text-sm font-bold uppercase tracking-wide">PI Sent</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-pi">0</span>
                        </div>
                    </div>
                    <div id="kanban-pi" class="kanban-cards"></div>
                </div>

                <!-- ç”Ÿäº§ä¸­åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-purple-400 text-sm font-bold uppercase tracking-wide">Production</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-production">0</span>
                        </div>
                    </div>
                    <div id="kanban-production" class="kanban-cards"></div>
                </div>

                <!-- å·²å‘è´§åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-cyan-400 text-sm font-bold uppercase tracking-wide">Shipped</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-shipped">0</span>
                        </div>
                    </div>
                    <div id="kanban-shipped" class="kanban-cards"></div>
                </div>

                <!-- å·²å®Œæˆåˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 text-sm font-bold uppercase tracking-wide">Paid & Done</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-paid">0</span>
                        </div>
                    </div>
                    <div id="kanban-paid" class="kanban-cards"></div>
                </div>
            </div>
        </div>

        <!-- å®¢æˆ· Tab -->
        <div id="tab-crm" class="tab-content">
            <div class="container mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">å®¢æˆ·èµ„äº§åº“</h2>
                    <button onclick="app.crm.openAddModal()" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-green-900/20">
                        <i class="fas fa-user-plus mr-2"></i> å½•å…¥å®¢æˆ·
                    </button>
                </div>
                <div id="customer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <!-- å…¼å®¹CRMæ¨¡å—çš„å®¹å™¨ID -->
                <div id="crm-customers" class="hidden"></div>
            </div>
        </div>

        <!-- ä¾›åº”å•† Tab -->
        <div id="tab-suppliers" class="tab-content">
            <div class="container mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">ä¾›åº”é“¾ç®¡ç†</h2>
                    <button onclick="app.suppliers.openAddModal()" class="bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-indigo-900/20">
                        <i class="fas fa-plus mr-2"></i> æ–°å¢ä¾›åº”å•†
                    </button>
                </div>
                <div id="supplier-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <!-- å…¼å®¹Suppliersæ¨¡å—çš„å®¹å™¨ID -->
                <div id="supplierList" class="hidden"></div>
            </div>
        </div>

        <!-- æ”¯å‡º Tab -->
        <div id="tab-expenses" class="tab-content">
            <div class="container mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">èµ„é‡‘æµæ°´</h2>
                    <button onclick="app.expenses.openAddModal()" class="bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-yellow-900/20">
                        <i class="fas fa-plus mr-2"></i> è®°ä¸€ç¬”
                    </button>
                </div>
                <div class="glass rounded-xl overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs uppercase bg-dark-3/50 text-gray-500">
                            <tr>
                                <th class="px-4 py-3">æ—¥æœŸ</th>
                                <th class="px-4 py-3">é¡¹ç›®</th>
                                <th class="px-4 py-3">åˆ†ç±»</th>
                                <th class="px-4 py-3 text-right">é‡‘é¢</th>
                                <th class="px-4 py-3 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-tbody"></tbody>
                    </table>
                </div>
                <!-- å…¼å®¹Expensesæ¨¡å—çš„å®¹å™¨ID -->
                <div id="expenses-list" class="hidden"></div>
            </div>
        </div>

    </main>

    <!-- ==================== æ¨¡æ€æ¡† ==================== -->
    
    <!-- æ–°å¢å®¢æˆ·æ¨¡æ€æ¡† -->
    <div id="customer-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">å½•å…¥å®¢æˆ·æ¡£æ¡ˆ</h3>
                <button onclick="app.crm.closeModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="crm-name" type="text" placeholder="å…¬å¸åç§° (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition">
                <input id="crm-contact" type="text" placeholder="è”ç³»äººå§“å" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition">
                <div class="grid grid-cols-2 gap-3">
                    <select id="crm-country" class="bg-dark-1 border border-dark-4 rounded-lg p-3 text-white focus:border-green-500 outline-none transition">
                        <option value="China">ğŸ‡¨ğŸ‡³ China</option>
                        <option value="USA">ğŸ‡ºğŸ‡¸ USA</option>
                        <option value="UK">ğŸ‡¬ğŸ‡§ UK</option>
                        <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
                        <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                        <option value="Turkey">ğŸ‡¹ğŸ‡· Turkey</option>
                        <option value="Philippines">ğŸ‡µğŸ‡­ Philippines</option>
                        <option value="Other">ğŸŒ Other</option>
                    </select>
                    <input id="crm-whatsapp" type="text" placeholder="WhatsApp" class="bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition">
                </div>
                <textarea id="crm-address" rows="2" placeholder="è¯¦ç»†åœ°å€..." class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition resize-none"></textarea>
            </div>
            <button onclick="app.crm.save()" class="w-full mt-6 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                ä¿å­˜æ¡£æ¡ˆ
            </button>
        </div>
    </div>

    <!-- æ–°å¢ä¾›åº”å•†æ¨¡æ€æ¡† -->
    <div id="supplier-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">æ–°å¢ä¾›åº”å•†</h3>
                <button onclick="app.suppliers.closeModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="supp-name" type="text" placeholder="ä¾›åº”å•†åç§° (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-indigo-500 outline-none transition">
                <input id="supp-product" type="text" placeholder="ä¸»è¥äº§å“" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-indigo-500 outline-none transition">
                <input id="supp-contact" type="text" placeholder="è”ç³»æ–¹å¼" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-indigo-500 outline-none transition">
                <textarea id="supp-note" rows="2" placeholder="å¤‡æ³¨ä¿¡æ¯..." class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-indigo-500 outline-none transition resize-none"></textarea>
            </div>
            <button onclick="app.suppliers.save()" class="w-full mt-6 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                æ·»åŠ ä¾›åº”å•†
            </button>
        </div>
    </div>

    <!-- æ–°å¢æ”¯å‡ºæ¨¡æ€æ¡† -->
    <div id="expense-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">è®°å½•æ”¯å‡º</h3>
                <button onclick="app.expenses.closeModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="expense-name" type="text" placeholder="æ”¯å‡ºé¡¹ç›® (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-yellow-500 outline-none transition">
                <div class="grid grid-cols-2 gap-3">
                    <input id="expense-amount" type="number" step="0.01" min="0" placeholder="é‡‘é¢ (å¿…å¡«)" class="bg-dark-1 border border-dark-4 rounded-lg p-3 text-white font-mono placeholder-gray-500 focus:border-yellow-500 outline-none transition">
                    <select id="expense-category" class="bg-dark-1 border border-dark-4 rounded-lg p-3 text-white focus:border-yellow-500 outline-none transition">
                        <option value="é‡‡è´­">é‡‡è´­æˆæœ¬</option>
                        <option value="ç‰©æµ">ç‰©æµè¿è´¹</option>
                        <option value="å·¥èµ„">äººå‘˜å·¥èµ„</option>
                        <option value="ç§Ÿé‡‘">æˆ¿ç§Ÿæ°´ç”µ</option>
                        <option value="è¥é”€">è¥é”€æ¨å¹¿</option>
                        <option value="åŠå…¬">åŠå…¬è€—æ</option>
                        <option value="å…¶ä»–">å…¶ä»–æ”¯å‡º</option>
                    </select>
                </div>
                <textarea id="expense-note" rows="2" placeholder="å¤‡æ³¨è¯´æ˜..." class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-yellow-500 outline-none transition resize-none"></textarea>
            </div>
            <button onclick="app.expenses.save()" class="w-full mt-6 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                è®°å½•æ”¯å‡º
            </button>
        </div>
    </div>

    <!-- å¿«é€Ÿæ·»åŠ è®¢å•æ¨¡æ€æ¡† -->
    <div id="kanban-quick-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">æ–°å¢è®¢å•ç«‹é¡¹</h3>
                <button onclick="app.kanban.closeQuickModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="kanban-title" type="text" placeholder="è®¢å•æ ‡é¢˜ (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none transition">
                <input id="kanban-customer" type="text" placeholder="å®¢æˆ·åç§°" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none transition">
                <input id="kanban-amount" type="number" step="0.01" min="0" placeholder="è®¢å•é‡‘é¢ (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white font-mono placeholder-gray-500 focus:border-blue-500 outline-none transition">
                <textarea id="kanban-note" rows="2" placeholder="è®¢å•å¤‡æ³¨..." class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none transition resize-none"></textarea>
            </div>
            <button onclick="app.kanban.saveQuickOrder()" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                åˆ›å»ºè®¢å•
            </button>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-[9999] space-y-2"></div>

    <!-- ==================== æ ¸å¿ƒ JavaScript ==================== -->
    <script>
    /**
     * V14.4 PRO - æ ¸å¿ƒåº”ç”¨æ¨¡å—ï¼ˆå®Œå…¨ä¿®å¤ç‰ˆï¼‰
     * ç»Ÿä¸€çš„å­˜å‚¨å’Œåº”ç”¨é€»è¾‘ï¼Œä¿®å¤æ‰€æœ‰ç©ºå€¼ä¿æŠ¤é—®é¢˜
     * ç‰ˆæœ¬: 14.4.0
     * ä¿®å¤å†…å®¹:
     * - æ‰€æœ‰å­˜å‚¨æ“ä½œä½¿ç”¨ç»Ÿä¸€çš„v5_erp_å‰ç¼€
     * - æ‰€æœ‰æ•°æ®åŠ è½½ä¿è¯è¿”å›æ•°ç»„/å¯¹è±¡ï¼ˆæ°¸ä¸è¿”å›nullï¼‰
     * - çœ‹æ¿åˆ—IDä¸HTMLå®Œå…¨åŒ¹é…
     * - Dashboardå…ƒç´ IDå®Œæ•´
     * - Toastå®¹å™¨åˆå§‹åŒ–
     */
    (function() {
        'use strict';

        // ==================== é…ç½®å¸¸é‡ ====================
        const CONFIG = {
            VERSION: '14.4.0',
            STORAGE_PREFIX: 'v5_erp_',
            KEYS: {
                ORDERS: 'v5_erp_orders',
                CUSTOMERS: 'v5_erp_customers',
                SUPPLIERS: 'v5_erp_suppliers',
                EXPENSES: 'v5_erp_expenses',
                INCOMES: 'v5_erp_incomes',
                TODAY_ACTIONS: 'v5_erp_today_actions',
                UNLOCK_TIME: 'v5_erp_unlock_time',
                EMERGENCY_TIME: 'v5_erp_emergency_time',
                SETTINGS: 'v5_erp_settings'
            },
            // çœ‹æ¿çŠ¶æ€ä¸HTML IDå®Œå…¨åŒ¹é…
            KANBAN_STATUS: ['inquiry', 'pi', 'production', 'shipped', 'paid'],
            UNLOCK_DURATION: 30 * 60 * 1000, // 30åˆ†é’Ÿ
            EMERGENCY_DURATION: 10 * 60 * 1000 // 10åˆ†é’Ÿ
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        const Utils = {
            // å®‰å…¨è·å– DOM å…ƒç´ 
            $(id) {
                return document.getElementById(id);
            },

            /**
             * å®‰å…¨è¯»å– localStorage
             * æ ¸å¿ƒä¿®å¤ï¼šæ°¸è¿œè¿”å›æ­£ç¡®ç±»å‹ï¼Œç»ä¸è¿”å› null
             */
            loadData(key, defaultValue = []) {
                try {
                    const data = localStorage.getItem(key);
                    if (data === null || data === undefined || data === '') {
                        return defaultValue;
                    }
                    const parsed = JSON.parse(data);
                    
                    // ç±»å‹æ ¡éªŒï¼šç¡®ä¿è¿”å›æ­£ç¡®ç±»å‹
                    if (Array.isArray(defaultValue)) {
                        return Array.isArray(parsed) ? parsed : defaultValue;
                    }
                    if (typeof defaultValue === 'object' && defaultValue !== null) {
                        return (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) ? parsed : defaultValue;
                    }
                    return parsed !== null && parsed !== undefined ? parsed : defaultValue;
                } catch (e) {
                    console.warn('[Utils] æ•°æ®è¯»å–å¤±è´¥:', key, e.message);
                    return defaultValue;
                }
            },

            // å®‰å…¨å†™å…¥ localStorage
            saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('[Utils] æ•°æ®ä¿å­˜å¤±è´¥:', key, e.message);
                    return false;
                }
            },

            // HTML è½¬ä¹‰
            escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            // æ ¼å¼åŒ–é‡‘é¢
            formatAmount(amount) {
                const num = parseFloat(amount) || 0;
                return `Â¥${num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            },

            // æ ¼å¼åŒ–æ—¥æœŸ
            formatDate(dateStr) {
                if (!dateStr) return 'æœªçŸ¥';
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return 'æœªçŸ¥';
                    return date.toLocaleDateString('zh-CN');
                } catch {
                    return 'æœªçŸ¥';
                }
            },

            // ç”Ÿæˆå”¯ä¸€ ID
            generateId(prefix = 'item') {
                return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
            },

            // æ˜¾ç¤º Toast
            toast(message, type = 'info', duration = 3000) {
                const container = Utils.$('toast-container');
                if (!container) {
                    console.warn('[Utils] Toastå®¹å™¨ä¸å­˜åœ¨');
                    return;
                }

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
                toast.innerHTML = `
                    <span class="text-xl">${icons[type] || icons.info}</span>
                    <span class="font-medium">${Utils.escapeHtml(message)}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },

            // å®‰å…¨æ•°ç»„æ“ä½œ
            safeArray(data) {
                return Array.isArray(data) ? data : [];
            },

            // å®‰å…¨è¿‡æ»¤
            safeFilter(data, callback) {
                const arr = Utils.safeArray(data);
                return typeof callback === 'function' ? arr.filter(callback) : [];
            },

            // å®‰å…¨éå†
            safeForEach(data, callback) {
                const arr = Utils.safeArray(data);
                if (typeof callback === 'function') {
                    arr.forEach(callback);
                }
            }
        };

        // ==================== ä¸»åº”ç”¨å¯¹è±¡ ====================
        window.app = {
            state: {
                emergencyTimer: null,
                currentTab: 'dashboard'
            },

            // ========== åˆå§‹åŒ– ==========
            init() {
                console.log(`[V14.4 PRO] ç³»ç»Ÿåˆå§‹åŒ–ä¸­... ç‰ˆæœ¬: ${CONFIG.VERSION}`);
                
                // æ£€æŸ¥ç”Ÿå­˜æ¨¡å¼
                app.survival.check();
                
                // åˆå§‹åŒ–å„æ¨¡å—
                app.calculateKPI();
                app.kanban.render();
                app.crm.render();
                app.suppliers.render();
                app.expenses.render();
                
                console.log('[V14.4 PRO] âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            },

            // ========== ç”Ÿå­˜æ¨¡å¼ ==========
            survival: {
                checkInputs() {
                    const a1 = Utils.$('action-1')?.value?.trim();
                    const a2 = Utils.$('action-2')?.value?.trim();
                    const a3 = Utils.$('action-3')?.value?.trim();
                    const btn = Utils.$('battle-start-btn');
                    if (btn) {
                        btn.disabled = !(a1 && a2 && a3);
                    }
                },

                check() {
                    const unlockTime = parseInt(localStorage.getItem(CONFIG.KEYS.UNLOCK_TIME)) || 0;
                    const emergencyTime = parseInt(localStorage.getItem(CONFIG.KEYS.EMERGENCY_TIME)) || 0;
                    const now = Date.now();

                    if (now < unlockTime) {
                        // æ­£å¸¸è§£é”çŠ¶æ€
                        app.survival.hideCurtain();
                        app.survival.showActions();
                    } else if (now < emergencyTime) {
                        // ç´§æ€¥æ¨¡å¼
                        app.survival.hideCurtain();
                        app.survival.startEmergencyTimer(emergencyTime);
                    } else {
                        // éœ€è¦è§£é”
                        app.survival.showCurtain();
                    }
                },

                showCurtain() {
                    Utils.$('survival-curtain')?.classList.remove('hidden');
                },

                hideCurtain() {
                    Utils.$('survival-curtain')?.classList.add('hidden');
                },

                unlock() {
                    const a1 = Utils.$('action-1')?.value?.trim();
                    const a2 = Utils.$('action-2')?.value?.trim();
                    const a3 = Utils.$('action-3')?.value?.trim();

                    if (!a1 || !a2 || !a3) {
                        Utils.toast('è¯·å¡«å†™å®Œæ•´çš„ä»Šæ—¥ä¸‰ä»¶äº‹', 'warning');
                        return;
                    }

                    // ä¿å­˜ä»Šæ—¥è¡ŒåŠ¨
                    Utils.saveData(CONFIG.KEYS.TODAY_ACTIONS, [a1, a2, a3]);
                    localStorage.setItem(CONFIG.KEYS.UNLOCK_TIME, String(Date.now() + CONFIG.UNLOCK_DURATION));

                    app.survival.hideCurtain();
                    app.survival.showActions();
                    Utils.toast('æˆ˜æ–—å¼€å§‹ï¼ä»Šæ—¥å¿…èƒœï¼', 'success');
                },

                emergency() {
                    if (!confirm('ç¡®å®šä½¿ç”¨ç´§æ€¥è¿›å…¥å—ï¼Ÿï¼ˆä»…10åˆ†é’Ÿæœ‰æ•ˆï¼‰')) return;

                    const emergencyEnd = Date.now() + CONFIG.EMERGENCY_DURATION;
                    localStorage.setItem(CONFIG.KEYS.EMERGENCY_TIME, String(emergencyEnd));
                    Utils.saveData(CONFIG.KEYS.TODAY_ACTIONS, ['ç´§æ€¥ä»»åŠ¡', 'å¿«é€Ÿå¤„ç†', 'ä¸´æ—¶å·¥ä½œ']);

                    app.survival.hideCurtain();
                    app.survival.startEmergencyTimer(emergencyEnd);
                    Utils.toast('ç´§æ€¥æ¨¡å¼å·²æ¿€æ´»ï¼ˆ10åˆ†é’Ÿï¼‰', 'warning');
                },

                startEmergencyTimer(endTime) {
                    Utils.$('emergency-warning')?.classList.remove('hidden');
                    
                    if (app.state.emergencyTimer) {
                        clearInterval(app.state.emergencyTimer);
                    }

                    const updateTimer = () => {
                        const remaining = Math.max(0, endTime - Date.now());
                        const minutes = Math.floor(remaining / 60000);
                        const seconds = Math.floor((remaining % 60000) / 1000);
                        
                        const timerEl = Utils.$('emergency-timer');
                        if (timerEl) {
                            timerEl.textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;
                        }

                        if (remaining <= 0) {
                            clearInterval(app.state.emergencyTimer);
                            app.state.emergencyTimer = null;
                            app.survival.showCurtain();
                            Utils.$('emergency-warning')?.classList.add('hidden');
                        }
                    };

                    updateTimer();
                    app.state.emergencyTimer = setInterval(updateTimer, 1000);
                },

                showActions() {
                    const actions = Utils.loadData(CONFIG.KEYS.TODAY_ACTIONS, []);
                    const container = Utils.$('actions-display');
                    if (!container || actions.length === 0) return;

                    container.innerHTML = actions.map((action, i) => `
                        <div class="glass rounded-xl p-5 hover:border-red-500/30 transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl font-bold text-red-500">#${i + 1}</span>
                                <span class="text-white font-medium">${Utils.escapeHtml(action)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            },

            // ========== Tab åˆ‡æ¢ ==========
            switchTab(tabId) {
                app.state.currentTab = tabId;

                // éšè—æ‰€æœ‰ tab å†…å®¹
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });

                // æ˜¾ç¤ºç›®æ ‡ tab
                Utils.$(`tab-${tabId}`)?.classList.add('active');

                // æ›´æ–°å¯¼èˆªé«˜äº®
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    const isActive = btn.dataset.tab === tabId;
                    btn.classList.toggle('active', isActive);
                });

                // æŒ‰éœ€æ¸²æŸ“
                switch (tabId) {
                    case 'dashboard': app.calculateKPI(); break;
                    case 'kanban': app.kanban.render(); break;
                    case 'crm': app.crm.render(); break;
                    case 'suppliers': app.suppliers.render(); break;
                    case 'expenses': app.expenses.render(); break;
                }
            },

            // ========== KPI è®¡ç®— ==========
            calculateKPI() {
                // ä½¿ç”¨å®‰å…¨çš„æ•°æ®åŠ è½½
                const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                const expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);
                const suppliers = Utils.loadData(CONFIG.KEYS.SUPPLIERS, []);
                const customers = Utils.loadData(CONFIG.KEYS.CUSTOMERS, []);

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // å®‰å…¨è¿‡æ»¤æœ¬æœˆå·²ä»˜æ¬¾è®¢å•
                const paidOrders = Utils.safeFilter(orders, o => {
                    if (o.status !== 'paid') return false;
                    const d = new Date(o.createdAt);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const totalRevenue = paidOrders.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
                const totalExpenses = Utils.safeArray(expenses).reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const grossProfit = totalRevenue;
                const netProfit = grossProfit - totalExpenses;

                // æ›´æ–° DOMï¼ˆå¸¦ç©ºå€¼ä¿æŠ¤ï¼‰
                const updateEl = (id, value) => {
                    const el = Utils.$(id);
                    if (el) el.textContent = value;
                };

                updateEl('kpi-revenue', Utils.formatAmount(totalRevenue));
                updateEl('kpi-gross', Utils.formatAmount(grossProfit));
                updateEl('kpi-net', Utils.formatAmount(netProfit));

                // æ›´æ–°Dashboardå…¼å®¹å…ƒç´ 
                updateEl('dashboard-total-orders', `è®¢å•: ${orders.length}`);
                updateEl('dashboard-pending-orders', `å¾…å¤„ç†: ${Utils.safeFilter(orders, o => o.status !== 'paid').length}`);
                updateEl('dashboard-completed-orders', `å·²å®Œæˆ: ${paidOrders.length}`);
                updateEl('dashboard-total-income', Utils.formatAmount(totalRevenue));
                updateEl('dashboard-month-income', Utils.formatAmount(totalRevenue));
                updateEl('dashboard-total-suppliers', suppliers.length);
                updateEl('dashboard-net-profit', Utils.formatAmount(netProfit));

                // è®¡ç®—è·ä¸Šæ¬¡è¿›è´¦æ—¶é—´
                const allPaidOrders = Utils.safeFilter(orders, o => o.status === 'paid');
                const lastPaid = allPaidOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

                const hoursEl = Utils.$('hours-since-income');
                if (hoursEl && lastPaid) {
                    const hours = Math.floor((Date.now() - new Date(lastPaid.createdAt)) / 3600000);
                    hoursEl.textContent = hours;
                }
            },

            // ========== çœ‹æ¿æ¨¡å— ==========
            kanban: {
                openQuickAdd() {
                    const clearInput = (id) => {
                        const el = Utils.$(id);
                        if (el) el.value = '';
                    };
                    clearInput('kanban-title');
                    clearInput('kanban-customer');
                    clearInput('kanban-amount');
                    clearInput('kanban-note');
                    Utils.$('kanban-quick-modal')?.classList.remove('hidden');
                    Utils.$('kanban-title')?.focus();
                },

                closeQuickModal() {
                    Utils.$('kanban-quick-modal')?.classList.add('hidden');
                },

                saveQuickOrder() {
                    const title = Utils.$('kanban-title')?.value?.trim();
                    const customer = Utils.$('kanban-customer')?.value?.trim();
                    const amount = parseFloat(Utils.$('kanban-amount')?.value) || 0;
                    const note = Utils.$('kanban-note')?.value?.trim();

                    if (!title) {
                        Utils.toast('è¯·è¾“å…¥è®¢å•æ ‡é¢˜', 'warning');
                        return;
                    }
                    if (amount <= 0) {
                        Utils.toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'warning');
                        return;
                    }

                    const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                    orders.push({
                        id: Utils.generateId('ORDER'),
                        title,
                        customer: customer || 'æœªçŸ¥å®¢æˆ·',
                        amount: amount.toFixed(2),
                        note,
                        status: 'inquiry',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.ORDERS, orders);
                    app.kanban.closeQuickModal();
                    app.kanban.render();
                    app.calculateKPI();
                    Utils.toast('è®¢å•åˆ›å»ºæˆåŠŸ', 'success');
                },

                render() {
                    const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);

                    // æŒ‰çŠ¶æ€åˆ†ç»„ï¼ˆä½¿ç”¨å®‰å…¨æ•°ç»„ï¼‰
                    const grouped = {
                        inquiry: [],
                        pi: [],
                        production: [],
                        shipped: [],
                        paid: []
                    };

                    Utils.safeForEach(orders, order => {
                        const status = order.status || 'inquiry';
                        if (grouped[status]) {
                            grouped[status].push(order);
                        }
                    });

                    // æ¸²æŸ“æ¯åˆ—
                    CONFIG.KANBAN_STATUS.forEach(status => {
                        const container = Utils.$(`kanban-${status}`);
                        const countEl = Utils.$(`count-${status}`);
                        const list = grouped[status] || [];

                        if (countEl) countEl.textContent = list.length;

                        if (container) {
                            if (list.length === 0) {
                                container.innerHTML = '<div class="text-center text-gray-600 py-8 text-sm">æš‚æ— è®¢å•</div>';
                            } else {
                                container.innerHTML = list.map(order => app.kanban.renderCard(order)).join('');
                            }
                        }
                    });
                },

                renderCard(order) {
                    return `
                        <div class="kanban-card" data-id="${order.id}">
                            <div class="font-semibold text-white mb-1 truncate">${Utils.escapeHtml(order.title)}</div>
                            <div class="flex justify-between items-center text-xs text-gray-400 mb-2">
                                <span>${Utils.escapeHtml(order.customer)}</span>
                                <span class="font-mono text-green-400">${Utils.formatAmount(order.amount)}</span>
                            </div>
                            ${order.note ? `<div class="text-xs text-gray-500 truncate mb-2">${Utils.escapeHtml(order.note)}</div>` : ''}
                            <div class="flex justify-end gap-2 pt-2 border-t border-dark-4/50">
                                <button onclick="app.kanban.updateStatus('${order.id}', 'next')" class="text-xs px-2 py-1 bg-blue-900/50 text-blue-400 rounded hover:bg-blue-900 transition">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <button onclick="app.kanban.deleteOrder('${order.id}')" class="text-xs px-2 py-1 bg-red-900/50 text-red-400 rounded hover:bg-red-900 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                },

                updateStatus(id, direction) {
                    const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                    const order = orders.find(o => o.id === id);
                    if (!order) return;

                    const currentIdx = CONFIG.KANBAN_STATUS.indexOf(order.status);
                    let newIdx = direction === 'next' 
                        ? Math.min(currentIdx + 1, CONFIG.KANBAN_STATUS.length - 1)
                        : Math.max(currentIdx - 1, 0);

                    order.status = CONFIG.KANBAN_STATUS[newIdx];
                    order.updatedAt = new Date().toISOString();

                    Utils.saveData(CONFIG.KEYS.ORDERS, orders);
                    app.kanban.render();
                    app.calculateKPI();
                    Utils.toast('è®¢å•çŠ¶æ€å·²æ›´æ–°', 'info');
                },

                deleteOrder(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®¢å•å—ï¼Ÿ')) return;

                    let orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                    orders = orders.filter(o => o.id !== id);
                    Utils.saveData(CONFIG.KEYS.ORDERS, orders);
                    app.kanban.render();
                    app.calculateKPI();
                    Utils.toast('è®¢å•å·²åˆ é™¤', 'success');
                }
            },

            // ========== å®¢æˆ·æ¨¡å— ==========
            crm: {
                openAddModal() {
                    const clearInput = (id) => {
                        const el = Utils.$(id);
                        if (el) el.value = '';
                    };
                    clearInput('crm-name');
                    clearInput('crm-contact');
                    clearInput('crm-whatsapp');
                    clearInput('crm-address');
                    Utils.$('customer-modal')?.classList.remove('hidden');
                    Utils.$('crm-name')?.focus();
                },

                closeModal() {
                    Utils.$('customer-modal')?.classList.add('hidden');
                },

                save() {
                    const name = Utils.$('crm-name')?.value?.trim();
                    if (!name) {
                        Utils.toast('è¯·è¾“å…¥å®¢æˆ·å…¬å¸å', 'warning');
                        return;
                    }

                    const customers = Utils.loadData(CONFIG.KEYS.CUSTOMERS, []);
                    customers.unshift({
                        id: Utils.generateId('CUST'),
                        company: name,
                        contact: Utils.$('crm-contact')?.value?.trim() || '',
                        country: Utils.$('crm-country')?.value || 'Other',
                        whatsapp: Utils.$('crm-whatsapp')?.value?.trim() || '',
                        address: Utils.$('crm-address')?.value?.trim() || '',
                        createdAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.CUSTOMERS, customers);
                    app.crm.closeModal();
                    app.crm.render();
                    Utils.toast('å®¢æˆ·æ¡£æ¡ˆå·²ä¿å­˜', 'success');
                },

                render() {
                    const container = Utils.$('customer-grid');
                    if (!container) return;

                    const customers = Utils.loadData(CONFIG.KEYS.CUSTOMERS, []);

                    if (customers.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full text-center py-12 text-gray-500">
                                <i class="fas fa-users text-4xl mb-4 opacity-30"></i>
                                <p>æš‚æ— å®¢æˆ·æ¡£æ¡ˆ</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = customers.map(c => `
                        <div class="glass rounded-xl p-5 hover:border-green-500/30 transition group">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h3 class="font-bold text-white">${Utils.escapeHtml(c.company)}</h3>
                                    <span class="text-xs text-gray-500">${Utils.escapeHtml(c.country)}</span>
                                </div>
                                <button onclick="app.crm.delete('${c.id}')" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            ${c.contact ? `<div class="text-sm text-gray-400 mb-1"><i class="fas fa-user mr-2 w-4 text-center"></i>${Utils.escapeHtml(c.contact)}</div>` : ''}
                            ${c.whatsapp ? `<div class="text-sm text-gray-400 mb-1"><i class="fab fa-whatsapp mr-2 w-4 text-center text-green-500"></i>${Utils.escapeHtml(c.whatsapp)}</div>` : ''}
                            ${c.address ? `<div class="text-xs text-gray-500 mt-2 truncate"><i class="fas fa-map-marker-alt mr-2"></i>${Utils.escapeHtml(c.address)}</div>` : ''}
                        </div>
                    `).join('');
                },

                delete(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤å®¢æˆ·æ¡£æ¡ˆå—ï¼Ÿ')) return;
                    let customers = Utils.loadData(CONFIG.KEYS.CUSTOMERS, []);
                    customers = customers.filter(c => c.id !== id);
                    Utils.saveData(CONFIG.KEYS.CUSTOMERS, customers);
                    app.crm.render();
                    Utils.toast('å®¢æˆ·æ¡£æ¡ˆå·²åˆ é™¤', 'success');
                }
            },

            // ========== ä¾›åº”å•†æ¨¡å— ==========
            suppliers: {
                openAddModal() {
                    const clearInput = (id) => {
                        const el = Utils.$(id);
                        if (el) el.value = '';
                    };
                    clearInput('supp-name');
                    clearInput('supp-product');
                    clearInput('supp-contact');
                    clearInput('supp-note');
                    Utils.$('supplier-modal')?.classList.remove('hidden');
                    Utils.$('supp-name')?.focus();
                },

                closeModal() {
                    Utils.$('supplier-modal')?.classList.add('hidden');
                },

                save() {
                    const name = Utils.$('supp-name')?.value?.trim();
                    if (!name) {
                        Utils.toast('è¯·è¾“å…¥ä¾›åº”å•†åç§°', 'warning');
                        return;
                    }

                    const suppliers = Utils.loadData(CONFIG.KEYS.SUPPLIERS, []);
                    suppliers.unshift({
                        id: Utils.generateId('SUPP'),
                        name,
                        product: Utils.$('supp-product')?.value?.trim() || '',
                        contact: Utils.$('supp-contact')?.value?.trim() || '',
                        note: Utils.$('supp-note')?.value?.trim() || '',
                        createdAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.SUPPLIERS, suppliers);
                    app.suppliers.closeModal();
                    app.suppliers.render();
                    Utils.toast('ä¾›åº”å•†å·²æ·»åŠ ', 'success');
                },

                render() {
                    const container = Utils.$('supplier-list');
                    if (!container) return;

                    const suppliers = Utils.loadData(CONFIG.KEYS.SUPPLIERS, []);

                    if (suppliers.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full text-center py-12 text-gray-500">
                                <i class="fas fa-industry text-4xl mb-4 opacity-30"></i>
                                <p>æš‚æ— ä¾›åº”å•†æ¡£æ¡ˆ</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = suppliers.map(s => `
                        <div class="glass rounded-xl p-5 hover:border-indigo-500/30 transition group">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h3 class="font-bold text-white">${Utils.escapeHtml(s.name)}</h3>
                                    ${s.product ? `<span class="text-xs text-indigo-400 bg-indigo-900/30 px-2 py-0.5 rounded">${Utils.escapeHtml(s.product)}</span>` : ''}
                                </div>
                                <button onclick="app.suppliers.delete('${s.id}')" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            ${s.contact ? `<div class="text-sm text-gray-400"><i class="fas fa-phone mr-2 w-4 text-center"></i>${Utils.escapeHtml(s.contact)}</div>` : ''}
                            ${s.note ? `<div class="text-xs text-gray-500 mt-2">${Utils.escapeHtml(s.note)}</div>` : ''}
                        </div>
                    `).join('');
                },

                delete(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¾›åº”å•†å—ï¼Ÿ')) return;
                    let suppliers = Utils.loadData(CONFIG.KEYS.SUPPLIERS, []);
                    suppliers = suppliers.filter(s => s.id !== id);
                    Utils.saveData(CONFIG.KEYS.SUPPLIERS, suppliers);
                    app.suppliers.render();
                    Utils.toast('ä¾›åº”å•†å·²åˆ é™¤', 'success');
                }
            },

            // ========== æ”¯å‡ºæ¨¡å— ==========
            expenses: {
                openAddModal() {
                    const clearInput = (id) => {
                        const el = Utils.$(id);
                        if (el) el.value = '';
                    };
                    clearInput('expense-name');
                    clearInput('expense-amount');
                    clearInput('expense-note');
                    Utils.$('expense-modal')?.classList.remove('hidden');
                    Utils.$('expense-name')?.focus();
                },

                closeModal() {
                    Utils.$('expense-modal')?.classList.add('hidden');
                },

                save() {
                    const name = Utils.$('expense-name')?.value?.trim();
                    const amount = parseFloat(Utils.$('expense-amount')?.value) || 0;

                    if (!name) {
                        Utils.toast('è¯·è¾“å…¥æ”¯å‡ºé¡¹ç›®', 'warning');
                        return;
                    }
                    if (amount <= 0) {
                        Utils.toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'warning');
                        return;
                    }

                    const expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);
                    expenses.unshift({
                        id: Utils.generateId('EXP'),
                        name,
                        amount: amount.toFixed(2),
                        category: Utils.$('expense-category')?.value || 'å…¶ä»–',
                        note: Utils.$('expense-note')?.value?.trim() || '',
                        createdAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.EXPENSES, expenses);
                    app.expenses.closeModal();
                    app.expenses.render();
                    app.calculateKPI();
                    Utils.toast('æ”¯å‡ºå·²è®°å½•', 'success');
                },

                render() {
                    const tbody = Utils.$('expenses-tbody');
                    if (!tbody) return;

                    const expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);

                    if (expenses.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-12 text-gray-500">
                                    <i class="fas fa-receipt text-3xl mb-3 opacity-30 block"></i>
                                    æš‚æ— æ”¯å‡ºè®°å½•
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    tbody.innerHTML = expenses.map(e => `
                        <tr class="border-b border-dark-4/50 hover:bg-dark-3/50 transition">
                            <td class="px-4 py-3 text-gray-300">${Utils.formatDate(e.createdAt)}</td>
                            <td class="px-4 py-3 text-white font-medium">${Utils.escapeHtml(e.name)}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs bg-dark-3 rounded text-gray-400">${Utils.escapeHtml(e.category)}</span>
                            </td>
                            <td class="px-4 py-3 text-right text-red-400 font-mono">-${Utils.formatAmount(e.amount)}</td>
                            <td class="px-4 py-3 text-right">
                                <button onclick="app.expenses.delete('${e.id}')" class="text-gray-600 hover:text-red-500 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                },

                delete(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ”¯å‡ºè®°å½•å—ï¼Ÿ')) return;
                    let expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);
                    expenses = expenses.filter(e => e.id !== id);
                    Utils.saveData(CONFIG.KEYS.EXPENSES, expenses);
                    app.expenses.render();
                    app.calculateKPI();
                    Utils.toast('æ”¯å‡ºè®°å½•å·²åˆ é™¤', 'success');
                }
            },

            // ========== æ•°æ®å¯¼å‡º ==========
            exportData() {
                const data = {
                    version: CONFIG.VERSION,
                    exportTime: new Date().toISOString(),
                    orders: Utils.loadData(CONFIG.KEYS.ORDERS, []),
                    customers: Utils.loadData(CONFIG.KEYS.CUSTOMERS, []),
                    suppliers: Utils.loadData(CONFIG.KEYS.SUPPLIERS, []),
                    expenses: Utils.loadData(CONFIG.KEYS.EXPENSES, []),
                    todayActions: Utils.loadData(CONFIG.KEYS.TODAY_ACTIONS, [])
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `erp-backup-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);

                Utils.toast('æ•°æ®å·²å¯¼å‡º', 'success');
            },

            // ========== ç™»å‡º ==========
            logout() {
                if (!confirm('ç¡®å®šè¦é€€å‡ºç³»ç»Ÿå—ï¼Ÿ')) return;

                // æ¸…é™¤ä¼šè¯æ•°æ®ï¼ˆä¿ç•™ä¸šåŠ¡æ•°æ®ï¼‰
                localStorage.removeItem(CONFIG.KEYS.UNLOCK_TIME);
                localStorage.removeItem(CONFIG.KEYS.EMERGENCY_TIME);
                localStorage.removeItem(CONFIG.KEYS.TODAY_ACTIONS);

                // æ¸…ç†å®šæ—¶å™¨
                if (app.state.emergencyTimer) {
                    clearInterval(app.state.emergencyTimer);
                    app.state.emergencyTimer = null;
                }

                // æ˜¾ç¤ºç”Ÿå­˜æ¨¡å¼
                app.survival.showCurtain();
                Utils.$('emergency-warning')?.classList.add('hidden');
                
                Utils.toast('å·²å®‰å…¨é€€å‡º', 'info');
            }
        };

        // ==================== DOM åŠ è½½å®Œæˆååˆå§‹åŒ– ====================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }

        console.log(`[V14.4 PRO] è„šæœ¬å·²åŠ è½½ - ç‰ˆæœ¬: ${CONFIG.VERSION}`);
    })();
    </script>
</body>
</html>
