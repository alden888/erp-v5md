<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>æˆ˜æ—¶æŒ‡æŒ¥å° V14.2 PRO ERP EDITION Â· B2B ä¸“ç”¨</title>
    
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin>

    <script>
        const isProduction = !window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1');
        const log = isProduction ? () => {} : console.log;
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#1f2937',
                        darker: '#111827',
                        darkest: '#030712',
                        column: '#161b22' // Trello é£æ ¼åˆ—èƒŒæ™¯è‰²
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'toast-in': 'toastIn 0.3s ease-out forwards',
                        'toast-out': 'toastOut 0.3s ease-in forwards'
                    }
                }
            }
        }
    </script>

    <style>
        /* åŸºç¡€é‡ç½® */
        html, body { 
            height: 100%; 
            overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ï¼Œäº¤ç»™å†…éƒ¨å®¹å™¨ */
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #030712;
            /* æˆ˜æœ¯é£æ ¼èƒŒæ™¯ */
            background-image: 
                linear-gradient(rgba(17, 24, 39, 0.9), rgba(17, 24, 39, 0.9)),
                url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            color: #e5e7eb;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– (Trello é£æ ¼) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #ef4444;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 0.8s linear infinite;
        }

        /* Tab åˆ‡æ¢ä¸å¸ƒå±€ */
        .tab-content { 
            display: none; 
            height: calc(100vh - 64px); /* å‡å» Header é«˜åº¦ */
            overflow-y: auto; /* é»˜è®¤å‚ç›´æ»šåŠ¨ */
            padding: 1.5rem;
        }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }

        /* ğŸ”¥ çœ‹æ¿ä¸“ç”¨å¸ƒå±€ (Trello Style) */
        #tab-kanban.active {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* çœ‹æ¿é¡µç¦æ­¢å¤–å±‚æ»šåŠ¨ */
            padding: 0; /* çœ‹æ¿å…¨å±é“ºæ»¡ */
        }
        .kanban-board-container {
            flex: 1;
            overflow-x: auto; /* å…è®¸æ¨ªå‘æ»šåŠ¨ */
            overflow-y: hidden;
            white-space: nowrap;
            padding: 1rem 1.5rem;
        }
        .kanban-column {
            display: inline-flex;
            flex-direction: column;
            width: 300px; /* å›ºå®šåˆ—å®½ */
            height: 100%;
            max-height: 100%;
            vertical-align: top;
            margin-right: 1rem;
            white-space: normal; /* å†…éƒ¨æ–‡å­—æ­£å¸¸æ¢è¡Œ */
            background-color: rgba(22, 27, 34, 0.85); /* åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        .kanban-cards-area {
            flex: 1;
            overflow-y: auto; /* åˆ—å†…éƒ¨å‚ç›´æ»šåŠ¨ */
            padding: 0.5rem;
            min-height: 100px;
        }
        /* çœ‹æ¿å¡ç‰‡æ ·å¼ */
        .kanban-card {
            background-color: rgba(13, 17, 23, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #e5e7eb;
        }
        .kanban-card:hover {
            border-color: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .kanban-card__title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #fff;
        }
        .kanban-card__meta {
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-card__actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: flex-end;
        }
        .kanban-card__btn {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* ç§»åŠ¨ç«¯å¯¼èˆª */
        .mobile-nav {
            position: fixed; inset: 0; background: rgba(17, 24, 39, 0.98);
            z-index: 45; transform: translateX(100%); transition: transform 0.3s;
        }
        .mobile-nav.active { transform: translateX(0); }
        .nav-tab.active { color: #fff; border-bottom: 2px solid #ef4444; }
        
        /* Toast æç¤ºç»„ä»¶æ ·å¼ */
        #toast {
            animation: toastIn 0.3s ease-out forwards;
        }
        #toast.hiding {
            animation: toastOut 0.3s ease-in forwards;
        }
        #toast.success #toast-icon { color: #10b981; }
        #toast.error #toast-icon { color: #ef4444; }
        #toast.warning #toast-icon { color: #f59e0b; }
        #toast.info #toast-icon { color: #3b82f6; }

        @media (max-width: 768px) {
            .mobile-hide { display: none !important; }
            .tab-content { height: calc(100vh - 60px); padding: 1rem; }
            /* ç§»åŠ¨ç«¯çœ‹æ¿ä¼˜åŒ– */
            .kanban-column { width: 85vw; margin-right: 10px; } 
        }
    </style>

    <script>
        (function initBasePath() {
            window.WORKBENCH_BASE = window.location.pathname.includes('/workbench') ? '/workbench' : '';
            if (window.WORKBENCH_BASE) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = `${window.WORKBENCH_BASE}/css/workbench-v14.css`;
                link.onload = () => log('[Style] Local CSS loaded successfully');
                document.head.appendChild(link);
            }

            // åˆå§‹åŒ–å…¨å±€å·¥å…·å‡½æ•°ï¼ˆæå‰æŒ‚è½½ï¼Œæ–¹ä¾¿å„æ¨¡å—è°ƒç”¨ï¼‰
            window.WorkbenchUtils = window.WorkbenchUtils || {
                // æ ¼å¼åŒ–é‡‘é¢
                formatAmount: (amount) => {
                    if (!amount || isNaN(amount)) return 'Â¥0.00';
                    return `Â¥${parseFloat(amount).toFixed(2)}`;
                },
                // æ ¼å¼åŒ–æ—¥æœŸ
                formatDate: (dateStr) => {
                    if (!dateStr) return 'æœªçŸ¥æ—¥æœŸ';
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                },
                // Toast æç¤º
                toast: (message, type = 'info', duration = 3000) => {
                    const toastEl = document.getElementById('toast');
                    const iconEl = document.getElementById('toast-icon');
                    const msgEl = document.getElementById('toast-message');
                    if (!toastEl || !iconEl || !msgEl) return;

                    // è®¾ç½®Toastç±»å‹
                    toastEl.className = 'fixed top-4 right-4 bg-gray-800 border border-gray-700 text-white px-6 py-4 rounded-lg shadow-2xl transition-transform duration-300 z-[100] flex items-center gap-4';
                    toastEl.classList.add(type);

                    // è®¾ç½®å›¾æ ‡å’Œå†…å®¹
                    const iconMap = {
                        success: 'fa-check-circle',
                        error: 'fa-exclamation-circle',
                        warning: 'fa-exclamation-triangle',
                        info: 'fa-info-circle'
                    };
                    iconEl.className = `fas ${iconMap[type] || iconMap.info} text-xl`;
                    msgEl.textContent = message;

                    // æ˜¾ç¤ºå¹¶è‡ªåŠ¨éšè—
                    clearTimeout(window.toastTimer);
                    window.toastTimer = setTimeout(() => {
                        toastEl.classList.add('hiding');
                        setTimeout(() => {
                            toastEl.classList.remove('hiding');
                        }, 300);
                    }, duration);
                },
                // éªŒè¯éç©º
                isRequired: (value) => {
                    return value && value.trim() !== '';
                },
                // éªŒè¯æ•°å­—å¤§äº0
                isPositiveNumber: (value) => {
                    const num = parseFloat(value);
                    return !isNaN(num) && num > 0;
                }
            };

            // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨å·¥å…·ï¼ˆç®€åŒ–æŒä¹…åŒ–æ“ä½œï¼‰
            window.WorkbenchStorage = window.WorkbenchStorage || {
                load: async (key, defaultValue = []) => {
                    try {
                        const data = localStorage.getItem(key);
                        return data ? JSON.parse(data) : defaultValue;
                    } catch (error) {
                        log(`[Storage] Load ${key} failed`, error);
                        return defaultValue;
                    }
                },
                save: async (key, data) => {
                    try {
                        localStorage.setItem(key, JSON.stringify(data));
                        return true;
                    } catch (error) {
                        log(`[Storage] Save ${key} failed`, error);
                        window.WorkbenchUtils.toast('æ•°æ®å­˜å‚¨å¤±è´¥', 'error');
                        return false;
                    }
                },
                remove: async (key) => {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (error) {
                        log(`[Storage] Remove ${key} failed`, error);
                        return false;
                    }
                }
            };
        })();
    </script>
</head>

<body>
    <div id="system-loading" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center">
        <div class="text-center max-w-md px-6">
            <div class="loading-spinner mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold text-red-500 mb-3 tracking-widest">SYSTEM INITIALIZING</h2>
            <p class="text-gray-400 text-sm mb-4">è¿æ¥æˆ˜æ—¶æŒ‡æŒ¥ä¸­æ¢...</p>
            
            <div class="w-full bg-gray-800 rounded-full h-1.5 mb-2 overflow-hidden">
                <div id="loading-bar" class="bg-red-600 h-full w-0 transition-all duration-300"></div>
            </div>
            <div id="loading-progress" class="text-xs text-gray-500 font-mono">0%</div>
            
            <div id="loading-error" class="hidden mt-4 p-3 bg-red-900/30 border border-red-800 rounded text-red-300 text-xs text-left"></div>
            <button id="retry-loading" class="hidden mt-4 text-xs text-white underline" onclick="location.reload()">é‡æ–°å°è¯•</button>
        </div>
    </div>

    <div id="iron-curtain" class="fixed inset-0 z-50 bg-black/98 hidden flex items-center justify-center">
        <div class="w-full max-w-lg p-8 animate-fade-in">
            <div class="text-center mb-10">
                <div class="text-5xl mb-4">ğŸ›¡ï¸</div>
                <h1 class="text-3xl font-black text-red-600 tracking-tighter uppercase">Survival Mode</h1>
                <p class="text-gray-500 text-sm mt-2">ç°é‡‘æµä¿å«æˆ˜ Â· èšç„¦æ ¸å¿ƒç›®æ ‡</p>
            </div>

            <div class="space-y-4 mb-8">
                <div class="relative">
                    <span class="absolute left-3 top-3 text-red-500 font-bold">1.</span>
                    <input id="action-1" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg py-3 pl-8 pr-4 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="ä»Šæ—¥æé’±åŠ¨ä½œ (å¿…å¡«)" oninput="app.survival.checkInputs()">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-red-500 font-bold">2.</span>
                    <input id="action-2" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg py-3 pl-8 pr-4 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="æ ¸å¿ƒæ¨è¿›äº‹é¡¹" oninput="app.survival.checkInputs()">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-red-500 font-bold">3.</span>
                    <input id="action-3" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg py-3 pl-8 pr-4 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="å®¢æˆ·è·Ÿè¿›/ç»´æŠ¤" oninput="app.survival.checkInputs()">
                </div>
            </div>

            <button id="battle-start-btn" disabled onclick="app.survival.startBattle()" class="w-full bg-red-700 hover:bg-red-600 disabled:opacity-30 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-lg transition-all shadow-lg shadow-red-900/20 flex items-center justify-center gap-2">
                <i class="fas fa-power-off"></i> å¯åŠ¨ç³»ç»Ÿ
            </button>
            
            <div class="mt-6 text-center">
                <button onclick="app.survival.emergencyOverride()" class="text-xs text-gray-600 hover:text-red-400 transition underline">
                    âš¡ ç´§æ€¥æ¨¡å¼å…¥å£ (10min)
                </button>
            </div>
        </div>
    </div>

    <header class="h-16 bg-[#0d1117] border-b border-gray-800 flex items-center justify-between px-4 lg:px-6 fixed top-0 left-0 right-0 z-40">
        <div class="flex items-center gap-3">
            <div class="font-black text-lg tracking-tight text-white">
                <span class="text-red-600">V5</span> COMMANDER
            </div>
            <div id="emergency-mode-warning" class="hidden px-2 py-0.5 bg-red-900/40 border border-red-500/30 rounded text-red-400 text-[10px] font-bold animate-pulse">
                âš ï¸ EMERGENCY <span id="emergency-timer">10</span> MIN
            </div>
        </div>

        <nav class="hidden md:flex items-center gap-1">
            <button onclick="app.switchTab('dashboard')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md active" data-tab="dashboard">
                <i class="fas fa-chart-pie mr-2"></i>ä»ªè¡¨ç›˜
            </button>
            <button onclick="app.switchTab('kanban')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="kanban">
                <i class="fas fa-columns mr-2"></i>è®¢å•æˆ˜åœº
            </button>
            <button onclick="app.switchTab('crm')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="crm">
                <i class="fas fa-address-book mr-2"></i>å®¢æˆ·
            </button>
            <button onclick="app.switchTab('suppliers')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="suppliers">
                <i class="fas fa-industry mr-2"></i>ä¾›åº”å•†
            </button>
            <button onclick="app.switchTab('expenses')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="expenses">
                <i class="fas fa-wallet mr-2"></i>æ”¯å‡º
            </button>
        </nav>

        <div class="flex items-center gap-3">
            <button class="md:hidden text-gray-400 p-2" onclick="document.querySelector('.mobile-nav').classList.add('active')">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="hidden md:flex items-center gap-2">
                <span id="sync-status" class="text-xs text-gray-500"><i class="fas fa-circle text-green-500 text-[8px] mr-1"></i>åœ¨çº¿</span>
                <button onclick="app.logout()" class="text-gray-500 hover:text-white p-2"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
    </header>

    <div class="mobile-nav flex flex-col p-6">
        <div class="flex justify-end mb-8">
            <button onclick="document.querySelector('.mobile-nav').classList.remove('active')" class="text-gray-400 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex flex-col gap-4">
            <button onclick="app.switchTab('dashboard'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800" data-mobile-tab="dashboard">ä»ªè¡¨ç›˜</button>
            <button onclick="app.switchTab('kanban'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800" data-mobile-tab="kanban">è®¢å•æˆ˜åœº</button>
            <button onclick="app.switchTab('crm'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800" data-mobile-tab="crm">å®¢æˆ·æ¡£æ¡ˆ</button>
            <button onclick="app.switchTab('suppliers'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800" data-mobile-tab="suppliers">ä¾›åº”å•†</button>
            <button onclick="app.switchTab('expenses'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800" data-mobile-tab="expenses">è¿è¥æ”¯å‡º</button>
        </div>
    </div>

    <main class="pt-16 h-full">
        
        <div id="tab-dashboard" class="tab-content active container mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-900/50 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-blue-500/30 transition">
                    <div class="text-xs text-gray-500 uppercase mb-1">Total Revenue</div>
                    <div class="text-2xl font-bold text-blue-400 font-mono" id="kpiRevenue">Â¥0.00</div>
                    <div class="text-xs text-gray-600 mt-2">æœ¬æœˆç´¯è®¡è¥æ”¶</div>
                </div>
                <div class="bg-gray-900/50 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-green-500/30 transition">
                    <div class="text-xs text-gray-500 uppercase mb-1">Gross Profit</div>
                    <div class="text-2xl font-bold text-green-400 font-mono" id="kpiGross">Â¥0.00</div>
                    <div class="text-xs text-gray-600 mt-2">çœŸå®æ¯›åˆ© (æ‰£é™¤é‡‡è´­)</div>
                </div>
                <div class="bg-gray-900/50 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-purple-500/30 transition">
                    <div class="text-xs text-gray-500 uppercase mb-1">Net Profit</div>
                    <div class="text-2xl font-bold text-purple-400 font-mono" id="kpiNet">Â¥0.00</div>
                    <div class="text-xs text-gray-600 mt-2">å‡€åˆ©æ¶¦ (æ‰£é™¤è¿è¥)</div>
                </div>
                <div class="bg-red-900/10 backdrop-blur border border-red-900/30 rounded-xl p-5 hover:border-red-500/50 transition relative overflow-hidden">
                    <div class="absolute -right-2 -top-2 text-6xl text-red-500/10"><i class="fas fa-hourglass-half"></i></div>
                    <div class="text-xs text-red-400 uppercase mb-1">Survival Status</div>
                    <div class="text-xl font-bold text-white">72h Safe</div>
                    <div class="text-xs text-red-400/70 mt-2">è·ä¸Šæ¬¡è¿›è´¦: <span id="hours-since-income">0</span>h</div>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-sm font-bold text-gray-400 uppercase mb-4 flex items-center gap-2">
                    <i class="fas fa-bullseye text-red-500"></i> Today's Focus
                </h3>
                <div id="actions-display" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- ä»Šæ—¥è¡ŒåŠ¨å°†ä»LocalStorageæ¸²æŸ“ -->
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="app.kanban.openQuickAdd()" class="p-4 bg-gray-800/50 rounded-lg hover:bg-blue-900/20 hover:text-blue-400 transition text-sm font-medium border border-transparent hover:border-blue-500/30">
                    <i class="fas fa-plus mb-2 block text-lg"></i> æ–°å¢è®¢å•
                </button>
                <button onclick="app.crm.openAddModal()" class="p-4 bg-gray-800/50 rounded-lg hover:bg-green-900/20 hover:text-green-400 transition text-sm font-medium border border-transparent hover:border-green-500/30">
                    <i class="fas fa-user-plus mb-2 block text-lg"></i> å½•å…¥å®¢æˆ·
                </button>
                <button onclick="app.expenses.openAddModal()" class="p-4 bg-gray-800/50 rounded-lg hover:bg-yellow-900/20 hover:text-yellow-400 transition text-sm font-medium border border-transparent hover:border-yellow-500/30">
                    <i class="fas fa-receipt mb-2 block text-lg"></i> è®°ä¸€ç¬”è´¦
                </button>
                <button onclick="app.exportData()" class="p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700 transition text-sm font-medium border border-transparent hover:border-gray-600">
                    <i class="fas fa-download mb-2 block text-lg"></i> å¤‡ä»½æ•°æ®
                </button>
            </div>
        </div>

        <div id="tab-kanban" class="tab-content">
            <div class="h-14 px-6 flex items-center justify-between border-b border-gray-800 bg-[#0d1117]">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-columns text-blue-500"></i> ä½œæˆ˜æŒ‡æŒ¥æ¿
                </h2>
                <div class="flex gap-2">
                    <button onclick="app.kanban.openQuickAdd()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition shadow-lg shadow-blue-900/20">
                        <i class="fas fa-plus mr-1"></i> ç«‹é¡¹
                    </button>
                </div>
            </div>

            <div class="kanban-board-container" id="kanban-wrapper">
                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-blue-400 text-sm uppercase tracking-wide">New Inquiry</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="inquiry">0</span>
                    </div>
                    <div id="kanban-inquiry" class="kanban-cards-area custom-scrollbar space-y-2.5">
                        <!-- è¯¢ç›˜å¡ç‰‡å°†ä»LocalStorageæ¸²æŸ“ -->
                    </div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-yellow-400 text-sm uppercase tracking-wide">PI Sent</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="pi">0</span>
                    </div>
                    <div id="kanban-pi" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-purple-400 text-sm uppercase tracking-wide">Production</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="production">0</span>
                    </div>
                    <div id="kanban-production" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-cyan-400 text-sm uppercase tracking-wide">Shipped</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="shipped">0</span>
                    </div>
                    <div id="kanban-shipped" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-green-400 text-sm uppercase tracking-wide">Paid & Done</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="paid">0</span>
                    </div>
                    <div id="kanban-paid" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>
            </div>
        </div>

        <div id="tab-crm" class="tab-content container mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">å®¢æˆ·èµ„äº§åº“</h2>
                <button onclick="app.crm.openAddModal()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                    <i class="fas fa-user-plus mr-2"></i> å½•å…¥å®¢æˆ·
                </button>
            </div>
            <div id="customer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-suppliers" class="tab-content container mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">ä¾›åº”é“¾ç®¡ç†</h2>
                <button onclick="app.suppliers.openAddModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                    <i class="fas fa-plus mr-2"></i> æ–°å¢ä¾›åº”å•†
                </button>
            </div>
            <div id="supplierList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-expenses" class="tab-content container mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">èµ„é‡‘æµæ°´</h2>
                <button onclick="app.expenses.openAddModal()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                    <i class="fas fa-plus mr-2"></i> è®°ä¸€ç¬”
                </button>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="bg-gray-800 text-gray-200">
                        <tr>
                            <th class="px-6 py-4">æ—¥æœŸ</th>
                            <th class="px-6 py-4">ç±»åˆ«</th>
                            <th class="px-6 py-4">æ‘˜è¦</th>
                            <th class="px-6 py-4 text-right">é‡‘é¢ (CNY)</th>
                            <th class="px-6 py-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- ä¾›åº”å•†æ¨¡æ€æ¡† -->
    <div id="supplier-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">æ–°å¢ä¾›åº”å•†</h3>
                <button onclick="app.suppliers.closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input id="supp-name" type="text" placeholder="ä¾›åº”å•†åç§° (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none">
                <input id="supp-product" type="text" placeholder="ä¸»è¥äº§å“" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none">
                <input id="supp-contact" type="text" placeholder="è”ç³»äºº/ç”µè¯" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none">
            </div>
            <button onclick="app.suppliers.save()" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">ä¿å­˜æ¡£æ¡ˆ</button>
        </div>
    </div>

    <!-- æ”¯å‡ºæ¨¡æ€æ¡† -->
    <div id="expense-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">è®°å½•æ”¯å‡º</h3>
                <button onclick="app.expenses.closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input id="exp-date" type="date" class="w-full bg-black border border-gray-700 rounded p-3 text-white" value="">
                <select id="exp-category" class="w-full bg-black border border-gray-700 rounded p-3 text-white">
                    <option value="å·®æ—…">âœˆï¸ å·®æ—…/äº¤é€š</option>
                    <option value="æ‹›å¾…">ğŸ· å®¢æˆ·æ‹›å¾…</option>
                    <option value="æˆ¿ç§Ÿ">ğŸ¢ æˆ¿ç§Ÿ/æ°´ç”µ</option>
                    <option value="è¥é”€">ğŸ“¢ å¹¿å‘Š/æ ·å“</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–æ‚é¡¹</option>
                </select>
                <input id="exp-amount" type="number" step="0.01" placeholder="é‡‘é¢ (CNY)" class="w-full bg-black border border-gray-700 rounded p-3 text-white font-mono">
                <input id="exp-note" type="text" placeholder="å¤‡æ³¨ (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white">
            </div>
            <button onclick="app.expenses.save()" class="w-full mt-6 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg">ç¡®è®¤æ”¯å‡º</button>
        </div>
    </div>

    <!-- å®¢æˆ·æ¨¡æ€æ¡† -->
    <div id="customer-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">å½•å…¥å®¢æˆ·</h3>
                <button onclick="app.crm.closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input id="crm-name" type="text" placeholder="å®¢æˆ·å…¬å¸å (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                <input id="crm-contact" type="text" placeholder="è”ç³»äºº" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                <select id="crm-country" class="w-full bg-black border border-gray-700 rounded p-3 text-white">
                    <option value="Philippines">ğŸ‡µğŸ‡­ è²å¾‹å®¾</option>
                    <option value="Turkey">ğŸ‡¹ğŸ‡· åœŸè€³å…¶</option>
                    <option value="UK">ğŸ‡¬ğŸ‡§ è‹±å›½</option>
                    <option value="Netherlands">ğŸ‡³ğŸ‡± è·å…°</option>
                    <option value="USA">ğŸ‡ºğŸ‡¸ ç¾å›½</option>
                    <option value="Other">ğŸŒ å…¶ä»–</option>
                </select>
                <input id="crm-whatsapp" type="text" placeholder="WhatsApp" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                <textarea id="crm-address" rows="2" placeholder="å‘è´§åœ°å€..." class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none"></textarea>
            </div>
            <button onclick="app.crm.save()" class="w-full mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">ä¿å­˜æ¡£æ¡ˆ</button>
        </div>
    </div>

    <!-- çœ‹æ¿å¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡† -->
    <div id="kanban-quick-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">æ–°å¢è®¢å•ç«‹é¡¹</h3>
                <button onclick="app.kanban.closeQuickModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input id="kanban-title" type="text" placeholder="è®¢å•æ ‡é¢˜ (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-blue-500 outline-none">
                <input id="kanban-customer" type="text" placeholder="å®¢æˆ·åç§°" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-blue-500 outline-none">
                <input id="kanban-amount" type="number" step="0.01" placeholder="è®¢å•é‡‘é¢ (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white font-mono focus:border-blue-500 outline-none">
                <textarea id="kanban-note" rows="2" placeholder="è®¢å•å¤‡æ³¨..." class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-blue-500 outline-none"></textarea>
            </div>
            <button onclick="app.kanban.saveQuickOrder()" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg">åˆ›å»ºè®¢å•</button>
        </div>
    </div>

    <!-- Toast æç¤ºç»„ä»¶ -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 border border-gray-700 text-white px-6 py-4 rounded-lg shadow-2xl transform translate-x-full transition-transform duration-300 z-[100] flex items-center gap-4">
        <i id="toast-icon" class="fas fa-info-circle text-blue-500 text-xl"></i>
        <span id="toast-message" class="font-medium">Notification</span>
    </div>

    <script>
        (function loadCoreModules() {
            const moduleManifest = [
                // 1. Firebase SDK (Remote)
                { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js', type: 'remote' },
                { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js', type: 'remote' },
                { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js', type: 'remote' },
                
                // 2. æœ¬åœ°æ ¸å¿ƒ (Local) - å¿…é¡»æŒ‰é¡ºåº
                { src: '/js/workbench-config.js', type: 'local' },
                { src: '/js/workbench-utils.js', type: 'local' },
                { src: '/js/workbench-firebase.js', type: 'local' },
                { src: '/js/workbench-storage.js', type: 'local' },
                { src: '/js/workbench-auth.js', type: 'local' },
                
                // 3. ä¸šåŠ¡æ¨¡å— (Local)
                { src: '/js/workbench-dashboard.js', type: 'local' },
                { src: '/js/workbench-orders.js', type: 'local' },
                { src: '/js/workbench-suppliers.js', type: 'local' },
                { src: '/js/workbench-finance.js', type: 'local' },
                // CRM é€»è¾‘ç›®å‰é›†æˆåœ¨ HTML å†…ï¼Œæœªæ¥å¯æ‹†åˆ†
            ];

            let loadedCount = 0;
            const totalModules = moduleManifest.length;
            const loadingBar = document.getElementById('loading-bar');
            const loadingProgress = document.getElementById('loading-progress');

            function loadModule(module) {
                const fullSrc = module.type === 'local' ? `${window.WORKBENCH_BASE}${module.src}` : module.src;
                const script = document.createElement('script');
                script.src = fullSrc;
                script.async = false; // ä¿è¯é¡ºåºæ‰§è¡Œ
                script.crossOrigin = "anonymous";

                script.onload = () => {
                    loadedCount++;
                    const percent = Math.round((loadedCount / totalModules) * 100);
                    if (loadingBar) loadingBar.style.width = `${percent}%`;
                    if (loadingProgress) loadingProgress.innerText = `${percent}%`;
                    
                    if (loadedCount === totalModules) {
                        initApp();
                    }
                };

                script.onerror = () => {
                    console.error('Failed to load:', fullSrc);
                    document.getElementById('loading-error').classList.remove('hidden');
                    document.getElementById('loading-error').innerText = `åŠ è½½å¤±è´¥: ${module.src.split('/').pop()}`;
                    document.getElementById('retry-loading').classList.remove('hidden');
                };

                document.body.appendChild(script);
            }

            // åˆå§‹åŒ– APP é€»è¾‘
            function initApp() {
                // å»¶æ—¶ä¸€ç‚¹è®© JS æ‰§è¡Œå®Œæ¯•
                setTimeout(async () => {
                    log('[System] All modules loaded.');
                    
                    // åˆå§‹åŒ–å„æ¨¡å—
                    if(window.WorkbenchConfig?.init) window.WorkbenchConfig.init();
                    if(window.WorkbenchDashboard?.init) await window.WorkbenchDashboard.init();
                    if(window.WorkbenchOrders?.init) window.WorkbenchOrders.init();
                    if(window.WorkbenchSuppliers?.init) window.WorkbenchSuppliers.init();
                    if(window.WorkbenchFinance?.init) window.WorkbenchFinance.init();

                    // åˆå§‹åŒ–ä»Šæ—¥æ—¥æœŸï¼ˆæ”¯å‡ºæ¨¡æ€æ¡†é»˜è®¤å½“å‰æ—¥æœŸï¼‰
                    document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];

                    // æ„å»º App ä»£ç†
                    window.app = {
                        // ç”Ÿå­˜æ¨¡å¼æ ¸å¿ƒé€»è¾‘
                        survival: {
                            checkInputs: () => {
                                const a1 = document.getElementById('action-1').value;
                                const a2 = document.getElementById('action-2').value;
                                const a3 = document.getElementById('action-3').value;
                                const btn = document.getElementById('battle-start-btn');
                                if(btn) {
                                    const isComplete = a1 && a2 && a3;
                                    btn.disabled = !isComplete;
                                    btn.style.opacity = isComplete ? '1' : '0.3';
                                    btn.style.cursor = isComplete ? 'pointer' : 'not-allowed';
                                }
                            },
                            startBattle: () => {
                                const actions = [
                                    document.getElementById('action-1').value.trim(),
                                    document.getElementById('action-2').value.trim(),
                                    document.getElementById('action-3').value.trim()
                                ];
                                // ä¿å­˜ä»Šæ—¥è¡ŒåŠ¨å’Œè§£é”æ—¶é—´
                                localStorage.setItem('v5_erp_today_actions', JSON.stringify(actions));
                                localStorage.setItem('v5_erp_unlock_time', Date.now());
                                localStorage.removeItem('v5_erp_emergency_time'); // æ¸…é™¤ç´§æ€¥æ¨¡å¼æ ‡è®°
                                
                                // éšè—ç™»å½•é¢æ¿ï¼Œæ¸²æŸ“ä»Šæ—¥è¡ŒåŠ¨
                                document.getElementById('iron-curtain').classList.add('hidden');
                                app.renderTodayActions(actions);
                                window.WorkbenchUtils.toast('ç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼Œä»Šæ—¥èšç„¦æ ¸å¿ƒç›®æ ‡ï¼', 'success');
                            },
                            emergencyOverride: () => {
                                if(confirm("å¯ç”¨10åˆ†é’Ÿç´§æ€¥æ¨¡å¼ï¼Ÿè¶…æ—¶åå°†è‡ªåŠ¨é€€å‡ºï¼")) {
                                    const emergencyTime = Date.now();
                                    localStorage.setItem('v5_erp_emergency_time', emergencyTime);
                                    localStorage.setItem('v5_erp_unlock_time', emergencyTime);
                                    
                                    document.getElementById('iron-curtain').classList.add('hidden');
                                    document.getElementById('emergency-mode-warning').classList.remove('hidden');
                                    
                                    // å¯åŠ¨ç´§æ€¥æ¨¡å¼å€’è®¡æ—¶
                                    app.startEmergencyTimer();
                                    window.WorkbenchUtils.toast('ç´§æ€¥æ¨¡å¼å·²æ¿€æ´»ï¼Œå‰©ä½™10åˆ†é’Ÿ', 'warning');
                                }
                            },
                            initCheck: () => {
                                const lastUnlock = localStorage.getItem('v5_erp_unlock_time');
                                const emergencyTime = localStorage.getItem('v5_erp_emergency_time');
                                
                                // 30åˆ†é’Ÿè¶…æ—¶ï¼ˆéç´§æ€¥æ¨¡å¼ï¼‰
                                const isExpired = !lastUnlock || (Date.now() - lastUnlock > 30 * 60 * 1000);
                                
                                if (isExpired && !emergencyTime) {
                                    document.getElementById('iron-curtain').classList.remove('hidden');
                                } else {
                                    document.getElementById('iron-curtain').classList.add('hidden');
                                    
                                    // æ¸²æŸ“ä»Šæ—¥è¡ŒåŠ¨
                                    const actions = JSON.parse(localStorage.getItem('v5_erp_today_actions') || '[]');
                                    if (actions.length === 3) app.renderTodayActions(actions);
                                    
                                    // ç´§æ€¥æ¨¡å¼ç»­æœŸå€’è®¡æ—¶
                                    if (emergencyTime) {
                                        document.getElementById('emergency-mode-warning').classList.remove('hidden');
                                        app.startEmergencyTimer();
                                    }
                                }
                            }
                        },
                        
                        // ç´§æ€¥æ¨¡å¼å€’è®¡æ—¶
                        startEmergencyTimer: () => {
                            const updateTimer = () => {
                                const emergencyTime = parseInt(localStorage.getItem('v5_erp_emergency_time') || '0');
                                const remainingMs = 10 * 60 * 1000 - (Date.now() - emergencyTime);
                                const remainingMin = Math.floor(remainingMs / 60000);
                                const remainingSec = Math.floor((remainingMs % 60000) / 1000);
                                
                                if (remainingMs <= 0) {
                                    localStorage.removeItem('v5_erp_emergency_time');
                                    localStorage.removeItem('v5_erp_unlock_time');
                                    location.reload();
                                    return;
                                }
                                
                                document.getElementById('emergency-timer').textContent = `${remainingMin}:${String(remainingSec).padStart(2, '0')}`;
                            };
                            
                            updateTimer();
                            setInterval(updateTimer, 1000);
                        },
                        
                        // æ¸²æŸ“ä»Šæ—¥è¡ŒåŠ¨
                        renderTodayActions: (actions) => {
                            const container = document.getElementById('actions-display');
                            if (!container || actions.length !== 3) return;
                            
                            const actionTemplates = [
                                { icon: 'fa-bullseye', color: 'text-red-500' },
                                { icon: 'fa-rocket', color: 'text-blue-500' },
                                { icon: 'fa-shield-alt', color: 'text-green-500' }
                            ];
                            
                            container.innerHTML = actions.map((action, index) => {
                                const template = actionTemplates[index];
                                return `
                                    <div class="bg-gray-900/70 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-gray-700 transition">
                                        <div class="flex items-center gap-3 mb-3">
                                            <i class="fas ${template.icon} ${template.color} text-xl"></i>
                                            <h4 class="font-bold text-white">ç¬¬${index+1}ä¼˜å…ˆçº§</h4>
                                        </div>
                                        <p class="text-gray-300 text-sm">${action}</p>
                                    </div>
                                `;
                            }).join('');
                        },
                        
                        // Tab åˆ‡æ¢é€»è¾‘
                        switchTab: (tabId) => {
                            // éšè—æ‰€æœ‰ Tab
                            document.querySelectorAll('.tab-content').forEach(el => {
                                el.classList.remove('active');
                                el.style.display = 'none';
                            });
                            
                            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé«˜äº®ï¼ˆæ¡Œé¢ç«¯+ç§»åŠ¨ç«¯ï¼‰
                            document.querySelectorAll('.nav-tab, [data-mobile-tab]').forEach(btn => {
                                btn.classList.remove('text-white', 'border-b-2', 'border-red-600', 'text-red-500');
                                btn.classList.add('text-gray-400');
                            });

                            // æ¿€æ´»ç›®æ ‡ Tab
                            const target = document.getElementById('tab-' + tabId);
                            if (target) {
                                if (tabId === 'kanban') {
                                    target.style.display = 'flex';
                                    setTimeout(() => target.classList.add('active'), 10);
                                } else {
                                    target.style.display = 'block';
                                    setTimeout(() => target.classList.add('active'), 10);
                                }
                            }

                            // æ¿€æ´»å¯¼èˆªé«˜äº®ï¼ˆæ¡Œé¢ç«¯+ç§»åŠ¨ç«¯ï¼‰
                            const desktopBtn = document.querySelector(`button[data-tab="${tabId}"]`);
                            const mobileBtn = document.querySelector(`[data-mobile-tab="${tabId}"]`);
                            
                            if(desktopBtn) {
                                desktopBtn.classList.remove('text-gray-400');
                                desktopBtn.classList.add('text-white', 'border-b-2', 'border-red-600');
                            }
                            if(mobileBtn) {
                                mobileBtn.classList.remove('text-gray-400');
                                mobileBtn.classList.add('text-white', 'text-red-500');
                            }

                            // è§¦å‘æ¨¡å—æ¸²æŸ“
                            if(tabId === 'kanban' && window.WorkbenchOrders) app.kanban.render();
                            if(tabId === 'suppliers' && window.WorkbenchSuppliers) app.suppliers.render();
                            if(tabId === 'expenses' && window.WorkbenchFinance) app.expenses.render();
                            if(tabId === 'crm') app.crm.render();
                            if(tabId === 'dashboard') app.calculateKPI();
                        },

                        // è®¡ç®—KPIæ•°æ®
                        calculateKPI: async () => {
                            // åŠ è½½è®¢å•å’Œæ”¯å‡ºæ•°æ®
                            const orders = await window.WorkbenchStorage.load('v5_erp_orders', []);
                            const expenses = await window.WorkbenchStorage.load('v5_erp_expenses', []);
                            
                            // è®¡ç®—æœ¬æœˆè¥æ”¶ï¼ˆå·²ä»˜æ¬¾è®¢å•ï¼‰
                            const currentMonth = new Date().getMonth();
                            const currentYear = new Date().getFullYear();
                            
                            const monthlyOrders = orders.filter(order => {
                                if (order.status !== 'paid') return false;
                                const orderDate = new Date(order.createdAt);
                                return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                            });
                            
                            const totalRevenue = monthlyOrders.reduce((sum, order) => sum + parseFloat(order.amount || 0), 0);
                            const totalExpenses = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                            const grossProfit = totalRevenue; // ç®€åŒ–ï¼šæ¯›åˆ©æš‚ç­‰äºè¥æ”¶ï¼ˆåç»­å¯æ·»åŠ é‡‡è´­æˆæœ¬ï¼‰
                            const netProfit = grossProfit - totalExpenses;
                            
                            // æ›´æ–°DOM
                            document.getElementById('kpiRevenue').textContent = window.WorkbenchUtils.formatAmount(totalRevenue);
                            document.getElementById('kpiGross').textContent = window.WorkbenchUtils.formatAmount(grossProfit);
                            document.getElementById('kpiNet').textContent = window.WorkbenchUtils.formatAmount(netProfit);
                            
                            // è®¡ç®—è·ä¸Šæ¬¡è¿›è´¦æ—¶é—´ï¼ˆç®€åŒ–ï¼šå–æœ€æ–°ä»˜æ¬¾è®¢å•ï¼‰
                            const paidOrders = orders.filter(o => o.status === 'paid').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                            if (paidOrders.length > 0) {
                                const lastPaidDate = new Date(paidOrders[0].createdAt);
                                const hoursSince = Math.floor((Date.now() - lastPaidDate.getTime()) / (1000 * 60 * 60));
                                document.getElementById('hours-since-income').textContent = hoursSince;
                            }
                        },

                        // æ•°æ®å¯¼å‡ºå¤‡ä»½
                        exportData: async () => {
                            try {
                                const exportData = {
                                    timestamp: new Date().toISOString(),
                                    customers: await window.WorkbenchStorage.load('v5_erp_customers', []),
                                    suppliers: await window.WorkbenchStorage.load('v5_erp_suppliers', []),
                                    orders: await window.WorkbenchStorage.load('v5_erp_orders', []),
                                    expenses: await window.WorkbenchStorage.load('v5_erp_expenses', []),
                                    todayActions: JSON.parse(localStorage.getItem('v5_erp_today_actions') || '[]')
                                };
                                
                                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `V5_COMMANDER_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
                                a.click();
                                URL.revokeObjectURL(url);
                                
                                window.WorkbenchUtils.toast('æ•°æ®å¤‡ä»½æˆåŠŸ', 'success');
                            } catch (error) {
                                log('[Export] Data export failed', error);
                                window.WorkbenchUtils.toast('æ•°æ®å¤‡ä»½å¤±è´¥', 'error');
                            }
                        },

                        // ä¾›åº”å•†æ¨¡å—
                        suppliers: {
                            openAddModal: () => {
                                // æ¸…ç©ºè¡¨å•
                                document.getElementById('supp-name').value = '';
                                document.getElementById('supp-product').value = '';
                                document.getElementById('supp-contact').value = '';
                                document.getElementById('supplier-modal').classList.remove('hidden');
                            },
                            closeModal: () => {
                                document.getElementById('supplier-modal').classList.add('hidden');
                            },
                            save: async () => {
                                const name = document.getElementById('supp-name').value.trim();
                                if (!window.WorkbenchUtils.isRequired(name)) {
                                    window.WorkbenchUtils.toast('ä¾›åº”å•†åç§°ä¸èƒ½ä¸ºç©º', 'error');
                                    return;
                                }
                                
                                const newSupp = {
                                    id: 'SUPP-' + Date.now(),
                                    name: name,
                                    product: document.getElementById('supp-product').value.trim(),
                                    contact: document.getElementById('supp-contact').value.trim(),
                                    createdAt: new Date().toISOString()
                                };
                                
                                const key = 'v5_erp_suppliers';
                                const list = await window.WorkbenchStorage.load(key, []);
                                list.push(newSupp);
                                const saveResult = await window.WorkbenchStorage.save(key, list);
                                
                                if (saveResult) {
                                    app.suppliers.closeModal();
                                    app.suppliers.render();
                                    window.WorkbenchUtils.toast('ä¾›åº”å•†å·²ä¿å­˜', 'success');
                                }
                            },
                            render: async () => {
                                const container = document.getElementById('supplierList');
                                if(!container) return;
                                const list = await window.WorkbenchStorage.load('v5_erp_suppliers', []);
                                
                                if(list.length === 0) {
                                    container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i class="fas fa-industry text-4xl mb-4 opacity-50"></i><p>æš‚æ— ä¾›åº”å•†æ¡£æ¡ˆ</p></div>';
                                    return;
                                }
                                
                                container.innerHTML = list.map(s => `
                                    <div class="bg-gray-900 border border-gray-800 p-5 rounded-xl hover:border-indigo-500 transition group">
                                        <div class="flex justify-between items-start mb-3">
                                            <h3 class="font-bold text-lg text-white">${s.name}</h3>
                                            <span class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 border border-gray-700">æ¡£æ¡ˆç¼–å·: ${s.id}</span>
                                        </div>
                                        <div class="text-sm text-gray-400 space-y-1">
                                            <p><i class="fas fa-box w-4 opacity-50"></i> ä¸»è¥äº§å“: ${s.product || '-'}</p>
                                            <p><i class="fas fa-phone w-4 opacity-50"></i> è”ç³»æ–¹å¼: ${s.contact || '-'}</p>
                                            <p><i class="fas fa-calendar w-4 opacity-50"></i> åˆ›å»ºæ—¶é—´: ${window.WorkbenchUtils.formatDate(s.createdAt)}</p>
                                        </div>
                                    </div>
                                `).join('');
                            }
                        },

                        // æ”¯å‡ºæ¨¡å—
                        expenses: {
                            openAddModal: () => {
                                // é‡ç½®è¡¨å•é»˜è®¤å€¼
                                document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
                                document.getElementById('exp-category').selectedIndex = 0;
                                document.getElementById('exp-amount').value = '';
                                document.getElementById('exp-note').value = '';
                                document.getElementById('expense-modal').classList.remove('hidden');
                            },
                            closeModal: () => {
                                document.getElementById('expense-modal').classList.add('hidden');
                            },
                            save: async () => {
                                const date = document.getElementById('exp-date').value;
                                const category = document.getElementById('exp-category').value;
                                const amount = document.getElementById('exp-amount').value;
                                const note = document.getElementById('exp-note').value.trim();
                                
                                // è¡¨å•éªŒè¯
                                if (!window.WorkbenchUtils.isRequired(date)) {
                                    window.WorkbenchUtils.toast('è¯·é€‰æ‹©æ”¯å‡ºæ—¥æœŸ', 'error');
                                    return;
                                }
                                if (!window.WorkbenchUtils.isPositiveNumber(amount)) {
                                    window.WorkbenchUtils.toast('è¯·è¾“å…¥å¤§äº0çš„é‡‘é¢', 'error');
                                    return;
                                }
                                if (!window.WorkbenchUtils.isRequired(note)) {
                                    window.WorkbenchUtils.toast('è¯·å¡«å†™æ”¯å‡ºå¤‡æ³¨', 'error');
                                    return;
                                }
                                
                                const newExp = {
                                    id: 'EXP-' + Date.now(),
                                    date: date,
                                    category: category,
                                    amount: parseFloat(amount).toFixed(2),
                                    note: note,
                                    createdAt: new Date().toISOString()
                                };
                                
                                const key = 'v5_erp_expenses';
                                const list = await window.WorkbenchStorage.load(key, []);
                                list.push(newExp);
                                const saveResult = await window.WorkbenchStorage.save(key, list);
                                
                                if (saveResult) {
                                    app.expenses.closeModal();
                                    app.expenses.render();
                                    app.calculateKPI(); // æ›´æ–°KPI
                                    window.WorkbenchUtils.toast('æ”¯å‡ºè®°å½•å·²ä¿å­˜', 'success');
                                }
                            },
                            render: async () => {
                                const container = document.getElementById('expense-list');
                                if(!container) return;
                                const list = await window.WorkbenchStorage.load('v5_erp_expenses', []);
                                
                                if(list.length === 0) {
                                    container.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-receipt text-4xl mb-4 opacity-50"></i><p>æš‚æ— æ”¯å‡ºè®°å½•</p></td></tr>';
                                    return;
                                }
                                
                                // æŒ‰æ—¥æœŸå€’åºæ’åº
                                list.sort((a, b) => new Date(b.date) - new Date(a.date));
                                
                                container.innerHTML = list.map(exp => `
                                    <tr class="bg-gray-800 border-b border-gray-900 hover:bg-gray-700/50 transition">
                                        <td class="px-6 py-4">${exp.date}</td>
                                        <td class="px-6 py-4">${exp.category}</td>
                                        <td class="px-6 py-4">${exp.note}</td>
                                        <td class="px-6 py-4 text-right font-mono text-red-400">${window.WorkbenchUtils.formatAmount(exp.amount)}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button onclick="app.expenses.delete('${exp.id}')" class="text-red-500 hover:text-red-400">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('');
                            },
                            delete: async (id) => {
                                if (!confirm('ç¡®å®šåˆ é™¤è¯¥æ”¯å‡ºè®°å½•å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼')) return;
                                
                                const key = 'v5_erp_expenses';
                                const list = await window.WorkbenchStorage.load(key, []);
                                const newList = list.filter(exp => exp.id !== id);
                                const saveResult = await window.WorkbenchStorage.save(key, newList);
                                
                                if (saveResult) {
                                    app.expenses.render();
                                    app.calculateKPI(); // æ›´æ–°KPI
                                    window.WorkbenchUtils.toast('æ”¯å‡ºè®°å½•å·²åˆ é™¤', 'success');
                                }
                            }
                        },

                        // å®¢æˆ·æ¨¡å—
                        crm: {
                            openAddModal: () => {
                                // æ¸…ç©ºè¡¨å•
                                document.getElementById('crm-name').value = '';
                                document.getElementById('crm-contact').value = '';
                                document.getElementById('crm-country').selectedIndex = 0;
                                document.getElementById('crm-whatsapp').value = '';
                                document.getElementById('crm-address').value = '';
                                document.getElementById('customer-modal').classList.remove('hidden');
                            },
                            closeModal: () => {
                                document.getElementById('customer-modal').classList.add('hidden');
                            },
                            save: async () => {
                                const name = document.getElementById('crm-name').value.trim();
                                if(!window.WorkbenchUtils.isRequired(name)) {
                                    window.WorkbenchUtils.toast('å®¢æˆ·å…¬å¸åä¸èƒ½ä¸ºç©º', 'error');
                                    return;
                                }
                                
                                const newCust = {
                                    id: 'CUST-' + Date.now(),
                                    company: name,
                                    contact: document.getElementById('crm-contact').value.trim(),
                                    country: document.getElementById('crm-country').value,
                                    whatsapp: document.getElementById('crm-whatsapp').value.trim(),
                                    address: document.getElementById('crm-address').value.trim(),
                                    createdAt: new Date().toISOString()
                                };
                                
                                const key = 'v5_erp_customers';
                                const list = await window.WorkbenchStorage.load(key, []);
                                list.push(newCust);
                                const saveResult = await window.WorkbenchStorage.save(key, list);
                                
                                if (saveResult) {
                                    app.crm.closeModal();
                                    app.crm.render();
                                    window.WorkbenchUtils.toast('å®¢æˆ·æ¡£æ¡ˆå·²ä¿å­˜', 'success');
                                }
                            },
                            render: async () => {
                                const container = document.getElementById('customer-grid');
                                if(!container) return;
                                const list = await window.WorkbenchStorage.load('v5_erp_customers', []);
                                
                                if(list.length === 0) {
                                    container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i class="fas fa-users text-4xl mb-4 opacity-50"></i><p>æš‚æ— å®¢æˆ·æ¡£æ¡ˆ</p></div>';
                                    return;
                                }
                                
                                container.innerHTML = list.map(c => `
                                    <div class="bg-gray-900 border border-gray-800 p-5 rounded-xl hover:border-green-500 transition group">
                                        <div class="flex justify-between items-start mb-3">
                                            <h3 class="font-bold text-lg text-white">${c.company}</h3>
                                            <span class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 border border-gray-700">${c.country}</span>
                                        </div>
                                        <div class="text-sm text-gray-400 space-y-1">
                                            <p><i class="fas fa-user w-4 opacity-50"></i> ${c.contact || '-'}</p>
                                            <p><i class="fab fa-whatsapp w-4 opacity-50"></i> ${c.whatsapp || '-'}</p>
                                            <p class="truncate"><i class="fas fa-map-marker-alt w-4 opacity-50"></i> ${c.address || '-'}</p>
                                            <p><i class="fas fa-calendar w-4 opacity-50"></i> ${window.WorkbenchUtils.formatDate(c.createdAt)}</p>
                                        </div>
                                    </div>
                                `).join('');
                            }
                        },

                        // çœ‹æ¿/è®¢å•æ¨¡å—
                        kanban: {
                            openQuickAdd: () => {
                                // æ¸…ç©ºè¡¨å•
                                document.getElementById('kanban-title').value = '';
                                document.getElementById('kanban-customer').value = '';
                                document.getElementById('kanban-amount').value = '';
                                document.getElementById('kanban-note').value = '';
                                document.getElementById('kanban-quick-modal').classList.remove('hidden');
                            },
                            closeQuickModal: () => {
                                document.getElementById('kanban-quick-modal').classList.add('hidden');
                            },
                            saveQuickOrder: async () => {
                                const title = document.getElementById('kanban-title').value.trim();
                                const customer = document.getElementById('kanban-customer').value.trim();
                                const amount = document.getElementById('kanban-amount').value;
                                const note = document.getElementById('kanban-note').value.trim();
                                
                                // è¡¨å•éªŒè¯
                                if (!window.WorkbenchUtils.isRequired(title)) {
                                    window.WorkbenchUtils.toast('è®¢å•æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
                                    return;
                                }
                                if (!window.WorkbenchUtils.isPositiveNumber(amount)) {
                                    window.WorkbenchUtils.toast('è¯·è¾“å…¥å¤§äº0çš„è®¢å•é‡‘é¢', 'error');
                                    return;
                                }
                                
                                const newOrder = {
                                    id: 'ORDER-' + Date.now(),
                                    title: title,
                                    customer: customer,
                                    amount: parseFloat(amount).toFixed(2),
                                    note: note,
                                    status: 'inquiry', // åˆå§‹çŠ¶æ€ï¼šè¯¢ç›˜
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                };
                                
                                const key = 'v5_erp_orders';
                                const list = await window.WorkbenchStorage.load(key, []);
                                list.push(newOrder);
                                const saveResult = await window.WorkbenchStorage.save(key, list);
                                
                                if (saveResult) {
                                    app.kanban.closeQuickModal();
                                    app.kanban.render();
                                    app.calculateKPI(); // æ›´æ–°KPI
                                    window.WorkbenchUtils.toast('è®¢å•ç«‹é¡¹æˆåŠŸ', 'success');
                                }
                            },
                            render: async () => {
                                const key = 'v5_erp_orders';
                                const orders = await window.WorkbenchStorage.load(key, []);
                                
                                // æŒ‰çŠ¶æ€åˆ†ç±»è®¢å•
                                const statusMap = {
                                    inquiry: document.getElementById('kanban-inquiry'),
                                    pi: document.getElementById('kanban-pi'),
                                    production: document.getElementById('kanban-production'),
                                    shipped: document.getElementById('kanban-shipped'),
                                    paid: document.getElementById('kanban-paid')
                                };
                                
                                // æ¸…ç©ºæ‰€æœ‰åˆ—çš„å†…å®¹
                                Object.values(statusMap).forEach(el => {
                                    if (el) el.innerHTML = '';
                                });
                                
                                // æ¸²æŸ“è®¢å•å¡ç‰‡åˆ°å¯¹åº”åˆ—
                                orders.forEach(order => {
                                    const column = statusMap[order.status];
                                    if (!column) return;
                                    
                                    const card = document.createElement('div');
                                    card.className = 'kanban-card';
                                    card.dataset.id = order.id;
                                    card.dataset.status = order.status;
                                    
                                    card.innerHTML = `
                                        <div class="kanban-card__title">${order.title}</div>
                                        <div class="kanban-card__meta">
                                            <span>${order.customer || 'æœªçŸ¥å®¢æˆ·'}</span>
                                            <span>${window.WorkbenchUtils.formatAmount(order.amount)}</span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1 truncate">${order.note || 'æ— å¤‡æ³¨'}</div>
                                        <div class="kanban-card__actions">
                                            <button onclick="app.kanban.updateStatus('${order.id}', 'next')" class="kanban-card__btn bg-blue-900/50 text-blue-400 hover:bg-blue-900">
                                                <i class="fas fa-arrow-right"></i>
                                            </button>
                                            <button onclick="app.kanban.deleteOrder('${order.id}')" class="kanban-card__btn bg-red-900/50 text-red-400 hover:bg-red-900">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    `;
                                    
                                    column.appendChild(card);
                                });
                                
                                // æ›´æ–°å„åˆ—è®¡æ•°
                                const statusList = ['inquiry', 'pi', 'production', 'shipped', 'paid'];
                                statusList.forEach(status => {
                                    const count = orders.filter(order => order.status === status).length;
                                    const countEl = document.querySelector(`[data-count="${status}"]`);
                                    if (countEl) countEl.textContent = count;
                                });
                            },
                            updateStatus: async (id, direction) => {
                                const key = 'v5_erp_orders';
                                const orders = await window.WorkbenchStorage.load(key, []);
                                const orderIndex = orders.findIndex(o => o.id === id);
                                
                                if (orderIndex === -1) return;
                                
                                // çŠ¶æ€æµè½¬ï¼šinquiry â†’ pi â†’ production â†’ shipped â†’ paid
                                const statusFlow = ['inquiry', 'pi', 'production', 'shipped', 'paid'];
                                const currentStatus = orders[orderIndex].status;
                                const currentIndex = statusFlow.indexOf(currentStatus);
                                
                                // è®¡ç®—æ–°çŠ¶æ€
                                let newIndex;
                                if (direction === 'next') {
                                    newIndex = Math.min(currentIndex + 1, statusFlow.length - 1);
                                } else {
                                    newIndex = Math.max(currentIndex - 1, 0);
                                }
                                
                                const newStatus = statusFlow[newIndex];
                                orders[orderIndex].status = newStatus;
                                orders[orderIndex].updatedAt = new Date().toISOString();
                                
                                const saveResult = await window.WorkbenchStorage.save(key, orders);
                                if (saveResult) {
                                    app.kanban.render();
                                    app.calculateKPI(); // æ›´æ–°KPI
                                    window.WorkbenchUtils.toast(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${newStatus}`, 'info');
                                }
                            },
                            deleteOrder: async (id) => {
                                if (!confirm('ç¡®å®šåˆ é™¤è¯¥è®¢å•å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼')) return;
                                
                                const key = 'v5_erp_orders';
                                const orders = await window.WorkbenchStorage.load(key, []);
                                const newOrders = orders.filter(o => o.id !== id);
                                const saveResult = await window.WorkbenchStorage.save(key, newOrders);
                                
                                if (saveResult) {
                                    app.kanban.render();
                                    app.calculateKPI(); // æ›´æ–°KPI
                                    window.WorkbenchUtils.toast('è®¢å•å·²åˆ é™¤', 'success');
                                }
                            }
                        },

                        // é€€å‡ºç³»ç»Ÿ
                        logout: () => {
                            if(confirm('ç¡®å®šé€€å‡ºæˆ˜æ—¶æŒ‡æŒ¥å°å—ï¼Ÿ')) {
                                localStorage.removeItem('v5_erp_unlock_time');
                                localStorage.removeItem('v5_erp_emergency_time');
                                location.reload();
                            }
                        }
                    };

                    // å¯åŠ¨ App åˆå§‹åŒ–æµç¨‹
                    app.survival.initCheck();
                    app.calculateKPI(); // åˆå§‹åŒ–KPIæ•°æ®
                    app.suppliers.render(); // åˆå§‹åŒ–ä¾›åº”å•†åˆ—è¡¨
                    app.expenses.render(); // åˆå§‹åŒ–æ”¯å‡ºåˆ—è¡¨
                    app.crm.render(); // åˆå§‹åŒ–å®¢æˆ·åˆ—è¡¨
                    app.kanban.render(); // åˆå§‹åŒ–çœ‹æ¿
                    
                    // éšè—åŠ è½½ç•Œé¢
                    setTimeout(() => {
                        document.getElementById('system-loading').classList.add('hidden');
                        log('[System] Ready for battle.');
                    }, 300);

                }, 500); // ç¨å¾®å»¶æ—¶ä»¥ç¡®ä¿ DOM æ¸²æŸ“
            }

            // å¼€å§‹åŠ è½½æ¨¡å—
            moduleManifest.forEach(loadModule);
        })();
    </script>
</body>
</html>
