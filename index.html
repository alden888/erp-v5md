<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>æˆ˜æ—¶æŒ‡æŒ¥å° V14.2 PRO ERP EDITION Â· B2B ä¸“ç”¨</title>
    
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin>

    <script>
        const isProduction = !window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1');
        const log = isProduction ? () => {} : console.log;
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#1f2937',
                        darker: '#111827',
                        darkest: '#030712',
                        column: '#161b22' // Trello é£æ ¼åˆ—èƒŒæ™¯è‰²
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards'
                    }
                }
            }
        }
    </script>

    <style>
        /* åŸºç¡€é‡ç½® */
        html, body { 
            height: 100%; 
            overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ï¼Œäº¤ç»™å†…éƒ¨å®¹å™¨ */
        }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #030712;
            /* æˆ˜æœ¯é£æ ¼èƒŒæ™¯ */
            background-image: 
                linear-gradient(rgba(17, 24, 39, 0.9), rgba(17, 24, 39, 0.9)),
                url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            color: #e5e7eb;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– (Trello é£æ ¼) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #ef4444;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 0.8s linear infinite;
        }

        /* Tab åˆ‡æ¢ä¸å¸ƒå±€ */
        .tab-content { 
            display: none; 
            height: calc(100vh - 64px); /* å‡å» Header é«˜åº¦ */
            overflow-y: auto; /* é»˜è®¤å‚ç›´æ»šåŠ¨ */
            padding: 1.5rem;
        }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }

        /* ğŸ”¥ çœ‹æ¿ä¸“ç”¨å¸ƒå±€ (Trello Style) */
        #tab-kanban.active {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* çœ‹æ¿é¡µç¦æ­¢å¤–å±‚æ»šåŠ¨ */
            padding: 0; /* çœ‹æ¿å…¨å±é“ºæ»¡ */
        }
        .kanban-board-container {
            flex: 1;
            overflow-x: auto; /* å…è®¸æ¨ªå‘æ»šåŠ¨ */
            overflow-y: hidden;
            white-space: nowrap;
            padding: 1rem 1.5rem;
        }
        .kanban-column {
            display: inline-flex;
            flex-direction: column;
            width: 300px; /* å›ºå®šåˆ—å®½ */
            height: 100%;
            max-height: 100%;
            vertical-align: top;
            margin-right: 1rem;
            white-space: normal; /* å†…éƒ¨æ–‡å­—æ­£å¸¸æ¢è¡Œ */
            background-color: rgba(22, 27, 34, 0.85); /* åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        .kanban-cards-area {
            flex: 1;
            overflow-y: auto; /* åˆ—å†…éƒ¨å‚ç›´æ»šåŠ¨ */
            padding: 0.5rem;
            min-height: 100px;
        }

        /* ç§»åŠ¨ç«¯å¯¼èˆª */
        .mobile-nav {
            position: fixed; inset: 0; background: rgba(17, 24, 39, 0.98);
            z-index: 45; transform: translateX(100%); transition: transform 0.3s;
        }
        .mobile-nav.active { transform: translateX(0); }
        .nav-tab.active { color: #fff; border-bottom: 2px solid #ef4444; }
        
        @media (max-width: 768px) {
            .mobile-hide { display: none !important; }
            .tab-content { height: calc(100vh - 60px); padding: 1rem; }
            /* ç§»åŠ¨ç«¯çœ‹æ¿ä¼˜åŒ– */
            .kanban-column { width: 85vw; margin-right: 10px; } 
        }
    </style>

    <script>
        (function initBasePath() {
            window.WORKBENCH_BASE = window.location.pathname.includes('/workbench') ? '/workbench' : '';
            if (window.WORKBENCH_BASE) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = `${window.WORKBENCH_BASE}/css/workbench-v14.css`;
                document.head.appendChild(link);
            }
        })();
    </script>
</head>

<body>
    <div id="system-loading" class="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center">
        <div class="text-center max-w-md px-6">
            <div class="loading-spinner mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold text-red-500 mb-3 tracking-widest">SYSTEM INITIALIZING</h2>
            <p class="text-gray-400 text-sm mb-4">è¿æ¥æˆ˜æ—¶æŒ‡æŒ¥ä¸­æ¢...</p>
            
            <div class="w-full bg-gray-800 rounded-full h-1.5 mb-2 overflow-hidden">
                <div id="loading-bar" class="bg-red-600 h-full w-0 transition-all duration-300"></div>
            </div>
            <div id="loading-progress" class="text-xs text-gray-500 font-mono">0%</div>
            
            <div id="loading-error" class="hidden mt-4 p-3 bg-red-900/30 border border-red-800 rounded text-red-300 text-xs text-left"></div>
            <button id="retry-loading" class="hidden mt-4 text-xs text-white underline" onclick="location.reload()">é‡æ–°å°è¯•</button>
        </div>
    </div>

    <div id="iron-curtain" class="fixed inset-0 z-50 bg-black/98 hidden flex items-center justify-center">
        <div class="w-full max-w-lg p-8 animate-fade-in">
            <div class="text-center mb-10">
                <div class="text-5xl mb-4">ğŸ›¡ï¸</div>
                <h1 class="text-3xl font-black text-red-600 tracking-tighter uppercase">Survival Mode</h1>
                <p class="text-gray-500 text-sm mt-2">ç°é‡‘æµä¿å«æˆ˜ Â· èšç„¦æ ¸å¿ƒç›®æ ‡</p>
            </div>

            <div class="space-y-4 mb-8">
                <div class="relative">
                    <span class="absolute left-3 top-3 text-red-500 font-bold">1.</span>
                    <input id="action-1" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg py-3 pl-8 pr-4 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="ä»Šæ—¥æé’±åŠ¨ä½œ (å¿…å¡«)" oninput="app.survival.checkInputs()">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-red-500 font-bold">2.</span>
                    <input id="action-2" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg py-3 pl-8 pr-4 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="æ ¸å¿ƒæ¨è¿›äº‹é¡¹" oninput="app.survival.checkInputs()">
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-red-500 font-bold">3.</span>
                    <input id="action-3" type="text" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg py-3 pl-8 pr-4 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="å®¢æˆ·è·Ÿè¿›/ç»´æŠ¤" oninput="app.survival.checkInputs()">
                </div>
            </div>

            <button id="battle-start-btn" disabled onclick="app.survival.startBattle()" class="w-full bg-red-700 hover:bg-red-600 disabled:opacity-30 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-lg transition-all shadow-lg shadow-red-900/20 flex items-center justify-center gap-2">
                <i class="fas fa-power-off"></i> å¯åŠ¨ç³»ç»Ÿ
            </button>
            
            <div class="mt-6 text-center">
                <button onclick="app.survival.emergencyOverride()" class="text-xs text-gray-600 hover:text-red-400 transition underline">
                    âš¡ ç´§æ€¥æ¨¡å¼å…¥å£ (10min)
                </button>
            </div>
        </div>
    </div>

    <header class="h-16 bg-[#0d1117] border-b border-gray-800 flex items-center justify-between px-4 lg:px-6 fixed top-0 left-0 right-0 z-40">
        <div class="flex items-center gap-3">
            <div class="font-black text-lg tracking-tight text-white">
                <span class="text-red-600">V5</span> COMMANDER
            </div>
            <div id="emergency-mode-warning" class="hidden px-2 py-0.5 bg-red-900/40 border border-red-500/30 rounded text-red-400 text-[10px] font-bold animate-pulse">
                âš ï¸ EMERGENCY
            </div>
        </div>

        <nav class="hidden md:flex items-center gap-1">
            <button onclick="app.switchTab('dashboard')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="dashboard">
                <i class="fas fa-chart-pie mr-2"></i>ä»ªè¡¨ç›˜
            </button>
            <button onclick="app.switchTab('kanban')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="kanban">
                <i class="fas fa-columns mr-2"></i>è®¢å•æˆ˜åœº
            </button>
            <button onclick="app.switchTab('crm')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="crm">
                <i class="fas fa-address-book mr-2"></i>å®¢æˆ·
            </button>
            <button onclick="app.switchTab('suppliers')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="suppliers">
                <i class="fas fa-industry mr-2"></i>ä¾›åº”å•†
            </button>
            <button onclick="app.switchTab('expenses')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="expenses">
                <i class="fas fa-wallet mr-2"></i>æ”¯å‡º
            </button>
        </nav>

        <div class="flex items-center gap-3">
            <button class="md:hidden text-gray-400 p-2" onclick="document.querySelector('.mobile-nav').classList.add('active')">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="hidden md:flex items-center gap-2">
                <span id="sync-status" class="text-xs text-gray-500"><i class="fas fa-circle text-green-500 text-[8px] mr-1"></i>åœ¨çº¿</span>
                <button onclick="app.logout()" class="text-gray-500 hover:text-white p-2"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
    </header>

    <div class="mobile-nav flex flex-col p-6">
        <div class="flex justify-end mb-8">
            <button onclick="document.querySelector('.mobile-nav').classList.remove('active')" class="text-gray-400 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex flex-col gap-4">
            <button onclick="app.switchTab('dashboard')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800">ä»ªè¡¨ç›˜</button>
            <button onclick="app.switchTab('kanban')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800">è®¢å•æˆ˜åœº</button>
            <button onclick="app.switchTab('crm')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800">å®¢æˆ·æ¡£æ¡ˆ</button>
            <button onclick="app.switchTab('suppliers')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800">ä¾›åº”å•†</button>
            <button onclick="app.switchTab('expenses')" class="text-left text-lg text-gray-300 py-2 border-b border-gray-800">è¿è¥æ”¯å‡º</button>
        </div>
    </div>

    <main class="pt-16 h-full">
        
        <div id="tab-dashboard" class="tab-content active container mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-900/50 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-blue-500/30 transition">
                    <div class="text-xs text-gray-500 uppercase mb-1">Total Revenue</div>
                    <div class="text-2xl font-bold text-blue-400 font-mono" id="kpiRevenue">Â¥0</div>
                    <div class="text-xs text-gray-600 mt-2">æœ¬æœˆç´¯è®¡è¥æ”¶</div>
                </div>
                <div class="bg-gray-900/50 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-green-500/30 transition">
                    <div class="text-xs text-gray-500 uppercase mb-1">Gross Profit</div>
                    <div class="text-2xl font-bold text-green-400 font-mono" id="kpiGross">Â¥0</div>
                    <div class="text-xs text-gray-600 mt-2">çœŸå®æ¯›åˆ© (æ‰£é™¤é‡‡è´­)</div>
                </div>
                <div class="bg-gray-900/50 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-purple-500/30 transition">
                    <div class="text-xs text-gray-500 uppercase mb-1">Net Profit</div>
                    <div class="text-2xl font-bold text-purple-400 font-mono" id="kpiNet">Â¥0</div>
                    <div class="text-xs text-gray-600 mt-2">å‡€åˆ©æ¶¦ (æ‰£é™¤è¿è¥)</div>
                </div>
                <div class="bg-red-900/10 backdrop-blur border border-red-900/30 rounded-xl p-5 hover:border-red-500/50 transition relative overflow-hidden">
                    <div class="absolute -right-2 -top-2 text-6xl text-red-500/10"><i class="fas fa-hourglass-half"></i></div>
                    <div class="text-xs text-red-400 uppercase mb-1">Survival Status</div>
                    <div class="text-xl font-bold text-white">72h Safe</div>
                    <div class="text-xs text-red-400/70 mt-2">è·ä¸Šæ¬¡è¿›è´¦: <span id="hours-since-income">0</span>h</div>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-sm font-bold text-gray-400 uppercase mb-4 flex items-center gap-2">
                    <i class="fas fa-bullseye text-red-500"></i> Today's Focus
                </h3>
                <div id="actions-display" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="app.kanban.openQuickAdd()" class="p-4 bg-gray-800/50 rounded-lg hover:bg-blue-900/20 hover:text-blue-400 transition text-sm font-medium border border-transparent hover:border-blue-500/30">
                    <i class="fas fa-plus mb-2 block text-lg"></i> æ–°å¢è®¢å•
                </button>
                <button onclick="app.crm.openAddModal()" class="p-4 bg-gray-800/50 rounded-lg hover:bg-green-900/20 hover:text-green-400 transition text-sm font-medium border border-transparent hover:border-green-500/30">
                    <i class="fas fa-user-plus mb-2 block text-lg"></i> å½•å…¥å®¢æˆ·
                </button>
                <button onclick="app.expenses.openAddModal()" class="p-4 bg-gray-800/50 rounded-lg hover:bg-yellow-900/20 hover:text-yellow-400 transition text-sm font-medium border border-transparent hover:border-yellow-500/30">
                    <i class="fas fa-receipt mb-2 block text-lg"></i> è®°ä¸€ç¬”è´¦
                </button>
                <button onclick="alert('æ•°æ®å¤‡ä»½åŠŸèƒ½å³å°†ä¸Šçº¿')" class="p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700 transition text-sm font-medium border border-transparent hover:border-gray-600">
                    <i class="fas fa-download mb-2 block text-lg"></i> å¤‡ä»½æ•°æ®
                </button>
            </div>
        </div>

        <div id="tab-kanban" class="tab-content">
            <div class="h-14 px-6 flex items-center justify-between border-b border-gray-800 bg-[#0d1117]">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-columns text-blue-500"></i> ä½œæˆ˜æŒ‡æŒ¥æ¿
                </h2>
                <div class="flex gap-2">
                    <button onclick="app.kanban.openQuickAdd()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold transition shadow-lg shadow-blue-900/20">
                        <i class="fas fa-plus mr-1"></i> ç«‹é¡¹
                    </button>
                </div>
            </div>

            <div class="kanban-board-container" id="kanban-wrapper">
                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-blue-400 text-sm uppercase tracking-wide">New Inquiry</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="inquiry">0</span>
                    </div>
                    <div id="kanban-inquiry" class="kanban-cards-area custom-scrollbar space-y-2.5">
                        </div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-yellow-400 text-sm uppercase tracking-wide">PI Sent</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="pi">0</span>
                    </div>
                    <div id="kanban-pi" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-purple-400 text-sm uppercase tracking-wide">Production</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="production">0</span>
                    </div>
                    <div id="kanban-production" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-cyan-400 text-sm uppercase tracking-wide">Shipped</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="shipped">0</span>
                    </div>
                    <div id="kanban-shipped" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>

                <div class="kanban-column">
                    <div class="p-3 font-bold border-b border-gray-700/50 flex justify-between items-center bg-gray-800/50 rounded-t-lg">
                        <span class="text-green-400 text-sm uppercase tracking-wide">Paid & Done</span>
                        <span class="bg-gray-900 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" data-count="paid">0</span>
                    </div>
                    <div id="kanban-paid" class="kanban-cards-area custom-scrollbar space-y-2.5"></div>
                </div>
            </div>
        </div>

        <div id="tab-crm" class="tab-content container mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">å®¢æˆ·èµ„äº§åº“</h2>
                <button onclick="app.crm.openAddModal()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                    <i class="fas fa-user-plus mr-2"></i> å½•å…¥å®¢æˆ·
                </button>
            </div>
            <div id="customer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-suppliers" class="tab-content container mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">ä¾›åº”é“¾ç®¡ç†</h2>
                <button onclick="app.suppliers.openAddModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                    <i class="fas fa-plus mr-2"></i> æ–°å¢ä¾›åº”å•†
                </button>
            </div>
            <div id="supplierList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="tab-expenses" class="tab-content container mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">èµ„é‡‘æµæ°´</h2>
                <button onclick="app.expenses.openAddModal()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-bold">
                    <i class="fas fa-plus mr-2"></i> è®°ä¸€ç¬”
                </button>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="bg-gray-800 text-gray-200">
                        <tr>
                            <th class="px-6 py-4">æ—¥æœŸ</th>
                            <th class="px-6 py-4">ç±»åˆ«</th>
                            <th class="px-6 py-4">æ‘˜è¦</th>
                            <th class="px-6 py-4 text-right">é‡‘é¢ (CNY)</th>
                            <th class="px-6 py-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="supplier-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">æ–°å¢ä¾›åº”å•†</h3>
                <button onclick="app.suppliers.closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input id="supp-name" type="text" placeholder="ä¾›åº”å•†åç§° (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none">
                <input id="supp-product" type="text" placeholder="ä¸»è¥äº§å“" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none">
                <input id="supp-contact" type="text" placeholder="è”ç³»äºº/ç”µè¯" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none">
            </div>
            <button onclick="app.suppliers.save()" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">ä¿å­˜æ¡£æ¡ˆ</button>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">è®°å½•æ”¯å‡º</h3>
                <button onclick="app.expenses.closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input id="exp-date" type="date" class="w-full bg-black border border-gray-700 rounded p-3 text-white">
                <select id="exp-category" class="w-full bg-black border border-gray-700 rounded p-3 text-white">
                    <option value="å·®æ—…">âœˆï¸ å·®æ—…/äº¤é€š</option>
                    <option value="æ‹›å¾…">ğŸ· å®¢æˆ·æ‹›å¾…</option>
                    <option value="æˆ¿ç§Ÿ">ğŸ¢ æˆ¿ç§Ÿ/æ°´ç”µ</option>
                    <option value="è¥é”€">ğŸ“¢ å¹¿å‘Š/æ ·å“</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–æ‚é¡¹</option>
                </select>
                <input id="exp-amount" type="number" placeholder="é‡‘é¢ (CNY)" class="w-full bg-black border border-gray-700 rounded p-3 text-white font-mono">
                <input id="exp-note" type="text" placeholder="å¤‡æ³¨ (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white">
            </div>
            <button onclick="app.expenses.save()" class="w-full mt-6 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg">ç¡®è®¤æ”¯å‡º</button>
        </div>
    </div>

    <div id="customer-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">å½•å…¥å®¢æˆ·</h3>
                <button onclick="app.crm.closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <input id="crm-name" type="text" placeholder="å®¢æˆ·å…¬å¸å (å¿…å¡«)" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                <input id="crm-contact" type="text" placeholder="è”ç³»äºº" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                <select id="crm-country" class="w-full bg-black border border-gray-700 rounded p-3 text-white">
                    <option value="Philippines">ğŸ‡µğŸ‡­ è²å¾‹å®¾</option>
                    <option value="Turkey">ğŸ‡¹ğŸ‡· åœŸè€³å…¶</option>
                    <option value="UK">ğŸ‡¬ğŸ‡§ è‹±å›½</option>
                    <option value="Netherlands">ğŸ‡³ğŸ‡± è·å…°</option>
                    <option value="USA">ğŸ‡ºğŸ‡¸ ç¾å›½</option>
                    <option value="Other">ğŸŒ å…¶ä»–</option>
                </select>
                <input id="crm-whatsapp" type="text" placeholder="WhatsApp" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none">
                <textarea id="crm-address" rows="2" placeholder="å‘è´§åœ°å€..." class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-green-500 outline-none"></textarea>
            </div>
            <button onclick="app.crm.save()" class="w-full mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">ä¿å­˜æ¡£æ¡ˆ</button>
        </div>
    </div>

    <div id="toast" class="fixed top-4 right-4 bg-gray-800 border border-gray-700 text-white px-6 py-4 rounded-lg shadow-2xl transform translate-x-full transition-transform duration-300 z-[100] flex items-center gap-4">
        <i id="toast-icon" class="fas fa-info-circle text-blue-500 text-xl"></i>
        <span id="toast-message" class="font-medium">Notification</span>
    </div>

    <script>
        (function loadCoreModules() {
            const moduleManifest = [
                // 1. Firebase SDK (Remote)
                { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js', type: 'remote' },
                { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js', type: 'remote' },
                { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js', type: 'remote' },
                
                // 2. æœ¬åœ°æ ¸å¿ƒ (Local) - å¿…é¡»æŒ‰é¡ºåº
                { src: '/js/workbench-config.js', type: 'local' },
                { src: '/js/workbench-utils.js', type: 'local' },
                { src: '/js/workbench-firebase.js', type: 'local' },
                { src: '/js/workbench-storage.js', type: 'local' },
                { src: '/js/workbench-auth.js', type: 'local' },
                
                // 3. ä¸šåŠ¡æ¨¡å— (Local)
                { src: '/js/workbench-dashboard.js', type: 'local' },
                { src: '/js/workbench-orders.js', type: 'local' },
                { src: '/js/workbench-suppliers.js', type: 'local' },
                { src: '/js/workbench-finance.js', type: 'local' },
                // CRM é€»è¾‘ç›®å‰é›†æˆåœ¨ HTML å†…ï¼Œæœªæ¥å¯æ‹†åˆ†
            ];

            let loadedCount = 0;
            const totalModules = moduleManifest.length;
            const loadingBar = document.getElementById('loading-bar');
            const loadingProgress = document.getElementById('loading-progress');

            function loadModule(module) {
                const fullSrc = module.type === 'local' ? `${window.WORKBENCH_BASE}${module.src}` : module.src;
                const script = document.createElement('script');
                script.src = fullSrc;
                script.async = false; // ä¿è¯é¡ºåºæ‰§è¡Œ
                script.crossOrigin = "anonymous";

                script.onload = () => {
                    loadedCount++;
                    const percent = Math.round((loadedCount / totalModules) * 100);
                    if (loadingBar) loadingBar.style.width = `${percent}%`;
                    if (loadingProgress) loadingProgress.innerText = `${percent}%`;
                    
                    if (loadedCount === totalModules) {
                        initApp();
                    }
                };

                script.onerror = () => {
                    console.error('Failed to load:', fullSrc);
                    document.getElementById('loading-error').classList.remove('hidden');
                    document.getElementById('loading-error').innerText = `åŠ è½½å¤±è´¥: ${module.src.split('/').pop()}`;
                    document.getElementById('retry-loading').classList.remove('hidden');
                };

                document.body.appendChild(script);
            }

            // åˆå§‹åŒ– APP é€»è¾‘
            function initApp() {
                // å»¶æ—¶ä¸€ç‚¹è®© JS æ‰§è¡Œå®Œæ¯•
                setTimeout(async () => {
                    console.log('[System] All modules loaded.');
                    
                    // åˆå§‹åŒ–å„æ¨¡å—
                    if(window.WorkbenchConfig?.init) window.WorkbenchConfig.init();
                    if(window.WorkbenchDashboard?.init) await window.WorkbenchDashboard.init();
                    if(window.WorkbenchOrders?.init) window.WorkbenchOrders.init();
                    if(window.WorkbenchSuppliers?.init) window.WorkbenchSuppliers.init();
                    if(window.WorkbenchFinance?.init) window.WorkbenchFinance.init();

                    // æ„å»º App ä»£ç†
                    window.app = {
                        survival: {
                            checkInputs: () => {
                                const a1 = document.getElementById('action-1').value;
                                const a2 = document.getElementById('action-2').value;
                                const a3 = document.getElementById('action-3').value;
                                const btn = document.getElementById('battle-start-btn');
                                if(btn) {
                                    btn.disabled = !(a1 && a2 && a3);
                                    btn.style.opacity = (a1 && a2 && a3) ? '1' : '0.3';
                                    btn.style.cursor = (a1 && a2 && a3) ? 'pointer' : 'not-allowed';
                                }
                            },
                            startBattle: () => {
                                const actions = [
                                    document.getElementById('action-1').value,
                                    document.getElementById('action-2').value,
                                    document.getElementById('action-3').value
                                ];
                                localStorage.setItem('v5_erp_today_actions', JSON.stringify(actions));
                                localStorage.setItem('v5_erp_unlock_time', Date.now());
                                
                                document.getElementById('iron-curtain').classList.add('hidden');
                                if(window.WorkbenchDashboard) window.WorkbenchDashboard.renderTodayActions(actions);
                            },
                            emergencyOverride: () => {
                                if(confirm("å¯ç”¨10åˆ†é’Ÿç´§æ€¥æ¨¡å¼ï¼Ÿ")) {
                                    document.getElementById('iron-curtain').classList.add('hidden');
                                    document.getElementById('emergency-mode-warning').classList.remove('hidden');
                                    setTimeout(() => location.reload(), 600000);
                                }
                            },
                            initCheck: () => {
                                const lastUnlock = localStorage.getItem('v5_erp_unlock_time');
                                // 30åˆ†é’Ÿè¶…æ—¶
                                if (!lastUnlock || (Date.now() - lastUnlock > 30 * 60 * 1000)) {
                                    document.getElementById('iron-curtain').classList.remove('hidden');
                                } else {
                                    document.getElementById('iron-curtain').classList.add('hidden');
                                }
                            }
                        },
                        
                        // Tab åˆ‡æ¢é€»è¾‘
                        switchTab: (tabId) => {
                            // éšè—æ‰€æœ‰ Tab
                            document.querySelectorAll('.tab-content').forEach(el => {
                                el.classList.remove('active');
                                // ç‰¹æ®Šå¤„ç†ï¼šçœ‹æ¿é¡µåœ¨éæ¿€æ´»æ—¶å®Œå…¨éšè—ï¼Œé¿å…å¸ƒå±€é”™ä¹±
                                if (el.id === 'tab-kanban') el.style.display = 'none';
                                else el.style.display = 'none';
                            });
                            
                            // ç§»é™¤å¯¼èˆªé«˜äº®
                            document.querySelectorAll('.nav-tab').forEach(btn => {
                                btn.classList.remove('text-white', 'border-b-2', 'border-red-600');
                                btn.classList.add('text-gray-400');
                            });

                            // æ¿€æ´»ç›®æ ‡ Tab
                            const target = document.getElementById('tab-' + tabId);
                            if (target) {
                                if (tabId === 'kanban') {
                                    target.style.display = 'flex'; // çœ‹æ¿éœ€è¦ Flex å¸ƒå±€
                                    setTimeout(() => target.classList.add('active'), 10);
                                } else {
                                    target.style.display = 'block';
                                    setTimeout(() => target.classList.add('active'), 10);
                                }
                            }

                            // æ¿€æ´»å¯¼èˆªé«˜äº®
                            const btn = document.querySelector(`button[data-tab="${tabId}"]`);
                            if(btn) {
                                btn.classList.remove('text-gray-400');
                                btn.classList.add('text-white');
                            }

                            // è§¦å‘æ¨¡å—æ¸²æŸ“
                            if(tabId === 'kanban' && window.WorkbenchOrders) WorkbenchOrders.render();
                            if(tabId === 'suppliers' && window.WorkbenchSuppliers) WorkbenchSuppliers.render();
                            if(tabId === 'expenses' && window.WorkbenchFinance) WorkbenchFinance.render();
                            if(tabId === 'crm') app.crm.render();
                        },

                        // æ¨¡å—ä»£ç†
                        kanban: { openQuickAdd: () => window.WorkbenchOrders?.openQuickAdd() },
                        suppliers: {
                            openAddModal: () => window.WorkbenchSuppliers?.openAddModal(),
                            closeModal: () => window.WorkbenchSuppliers?.closeModal(),
                            save: () => window.WorkbenchSuppliers?.save()
                        },
                        expenses: {
                            openAddModal: () => window.WorkbenchFinance?.openAddModal(),
                            closeModal: () => window.WorkbenchFinance?.closeModal(),
                            save: () => window.WorkbenchFinance?.save()
                        },
                        crm: {
                            openAddModal: () => document.getElementById('customer-modal').classList.remove('hidden'),
                            closeModal: () => document.getElementById('customer-modal').classList.add('hidden'),
                            save: () => {
                                const name = document.getElementById('crm-name').value;
                                if(!name) return alert('å…¬å¸åå¿…å¡«');
                                const newCust = {
                                    id: 'CUST-' + Date.now(),
                                    company: name,
                                    contact: document.getElementById('crm-contact').value,
                                    country: document.getElementById('crm-country').value,
                                    whatsapp: document.getElementById('crm-whatsapp').value,
                                    address: document.getElementById('crm-address').value,
                                    createdAt: new Date().toISOString()
                                };
                                const key = 'v5_erp_customers';
                                window.WorkbenchStorage.load(key, []).then(list => {
                                    list.push(newCust);
                                    window.WorkbenchStorage.save(key, list);
                                    app.crm.closeModal();
                                    app.crm.render();
                                    if(window.WorkbenchUtils) WorkbenchUtils.toast('å®¢æˆ·å·²ä¿å­˜', 'success');
                                });
                            },
                            render: async () => {
                                const container = document.getElementById('customer-grid');
                                if(!container) return;
                                const list = await window.WorkbenchStorage.load('v5_erp_customers', []);
                                if(list.length === 0) {
                                    container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i class="fas fa-users text-4xl mb-4 opacity-50"></i><p>æš‚æ— å®¢æˆ·æ¡£æ¡ˆ</p></div>';
                                    return;
                                }
                                container.innerHTML = list.map(c => `
                                    <div class="bg-gray-900 border border-gray-800 p-5 rounded-xl hover:border-green-500 transition group">
                                        <div class="flex justify-between items-start mb-3">
                                            <h3 class="font-bold text-lg text-white">${c.company}</h3>
                                            <span class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 border border-gray-700">${c.country}</span>
                                        </div>
                                        <div class="text-sm text-gray-400 space-y-1">
                                            <p><i class="fas fa-user w-4 opacity-50"></i> ${c.contact || '-'}</p>
                                            <p><i class="fab fa-whatsapp w-4 opacity-50"></i> ${c.whatsapp || '-'}</p>
                                            <p class="truncate"><i class="fas fa-map-marker-alt w-4 opacity-50"></i> ${c.address || ''}</p>
                                        </div>
                                    </div>
                                `).join('');
                            }
                        },
                        logout: () => {
                            if(confirm('é€€å‡ºç³»ç»Ÿï¼Ÿ')) {
                                localStorage.removeItem('v5_erp_unlock_time');
                                location.reload();
                            }
                        }
                    };

                    // å¯åŠ¨ App
                    app.survival.initCheck();
                    document.getElementById('system-loading').classList.add('hidden');
                    console.log('[System] Ready.');

                }, 500); // ç¨å¾®å»¶æ—¶ä»¥ç¡®ä¿ DOM æ¸²æŸ“
            }

            // å¼€å§‹åŠ è½½
            moduleManifest.forEach(loadModule);
        })();
    </script>
</body>
</html>
