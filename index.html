<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V5 战时指挥台</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        /* 基础样式（保留核心，保证功能） */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0f0f0f; color: #fff; font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        .active { opacity: 1 !important; transform: translateY(0) !important; }
        .kanban-card { 
            background: #1f1f1f; border: 1px solid #2f2f2f; border-radius: 8px; 
            padding: 12px; margin-bottom: 8px; cursor: pointer;
        }
        .kanban-cardHover:hover { border-color: #3b82f6; }
        .kanban-card__title { font-weight: 600; margin-bottom: 8px; }
        .kanban-card__meta { display: flex; justify-content: space-between; font-size: 12px; color: #9ca3af; }
        .kanban-card__actions { margin-top: 8px; display: flex; gap: 4px; }
        .kanban-card__btn { 
            padding: 4px 8px; border-radius: 4px; border: none; 
            cursor: pointer; font-size: 12px;
        }
        #loading-bar { height: 4px; background: #3b82f6; width: 0%; transition: width 0.3s; }
        #toast { transition: transform 0.3s ease; }
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        #tab-kanban.active { display: flex; }
    </style>
</head>
<body>
    <!-- 加载界面 -->
    <div id="system-loading" class="fixed inset-0 bg-black flex flex-col items-center justify-center z-50">
        <div class="w-4/5 max-w-md">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">V5 战时指挥台</h2>
                <p class="text-gray-500" id="loading-progress">0%</p>
            </div>
            <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="loading-bar" class="h-full bg-blue-600"></div>
            </div>
            <div id="loading-error" class="hidden mt-4 text-red-500 text-sm text-center"></div>
            <button id="retry-loading" class="hidden mt-4 w-full bg-gray-800 text-white py-2 rounded">重试加载</button>
        </div>
    </div>

    <!-- 生存模式锁幕 -->
    <div id="iron-curtain" class="fixed inset-0 bg-black/95 flex items-center justify-center z-40 hidden">
        <div class="w-4/5 max-w-md bg-gray-900 border border-gray-800 rounded-xl p-8">
            <h3 class="text-xl font-bold mb-6 text-center">今日核心目标</h3>
            <div class="space-y-4 mb-6">
                <input id="action-1" type="text" placeholder="第1优先级（必填）" class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white" oninput="app.survival.checkInputs()">
                <input id="action-2" type="text" placeholder="第2优先级（必填）" class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white" oninput="app.survival.checkInputs()">
                <input id="action-3" type="text" placeholder="第3优先级（必填）" class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-white" oninput="app.survival.checkInputs()">
            </div>
            <button id="battle-start-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold disabled:opacity-30 disabled:cursor-not-allowed" onclick="app.survival.startBattle()" disabled>确认启动系统</button>
            <button class="w-full mt-3 bg-gray-800 text-gray-300 py-2 rounded-lg text-sm" onclick="app.survival.emergencyOverride()">10分钟紧急模式</button>
        </div>
    </div>

    <!-- 紧急模式提示 -->
    <div id="emergency-mode-warning" class="fixed top-4 left-4 bg-red-900/80 border border-red-800 text-white px-4 py-2 rounded-lg hidden z-30">
        <span>紧急模式剩余: <span id="emergency-timer">10:00</span></span>
    </div>

    <!-- 今日行动展示 -->
    <div id="actions-display" class="fixed top-4 left-4 grid grid-cols-3 gap-4 z-20 hidden lg:flex"></div>

    <!-- 导航栏 -->
    <nav class="bg-gray-900 border-b border-gray-800 p-4">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between">
            <h1 class="text-xl font-bold text-white">V5 战时指挥台</h1>
            <div class="hidden md:flex gap-6">
                <button class="nav-tab text-white border-b-2 border-red-600" data-tab="dashboard">仪表盘</button>
                <button class="nav-tab text-gray-400" data-tab="kanban">订单看板</button>
                <button class="nav-tab text-gray-400" data-tab="crm">客户管理</button>
                <button class="nav-tab text-gray-400" data-tab="suppliers">供应商</button>
                <button class="nav-tab text-gray-400" data-tab="expenses">支出管理</button>
            </div>
            <div class="flex gap-3">
                <button onclick="app.exportData()" class="bg-gray-800 text-white px-3 py-2 rounded text-sm"><i class="fas fa-download mr-1"></i> 备份</button>
                <button onclick="app.logout()" class="bg-red-900 text-white px-3 py-2 rounded text-sm"><i class="fas fa-sign-out-alt mr-1"></i> 退出</button>
            </div>
        </div>
    </nav>

    <!-- 移动端导航 -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 p-3 z-10">
        <div class="grid grid-cols-5 gap-2">
            <button data-mobile-tab="dashboard" class="flex flex-col items-center text-sm text-red-500"><i class="fas fa-tachometer-alt text-lg mb-1"></i> 仪表盘</button>
            <button data-mobile-tab="kanban" class="flex flex-col items-center text-sm text-gray-400"><i class="fas fa-columns text-lg mb-1"></i> 看板</button>
            <button data-mobile-tab="crm" class="flex flex-col items-center text-sm text-gray-400"><i class="fas fa-users text-lg mb-1"></i> 客户</button>
            <button data-mobile-tab="suppliers" class="flex flex-col items-center text-sm text-gray-400"><i class="fas fa-industry text-lg mb-1"></i> 供应商</button>
            <button data-mobile-tab="expenses" class="flex flex-col items-center text-sm text-gray-400"><i class="fas fa-receipt text-lg mb-1"></i> 支出</button>
        </div>
    </div>

    <!-- 核心内容区 -->
    <main class="max-w-7xl mx-auto p-4 pb-20">
        <!-- 仪表盘 Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
                    <h3 class="text-gray-400 text-sm mb-2">本月营收</h3>
                    <p class="text-2xl font-bold text-white" id="dashboard-month-income">¥0.00</p>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
                    <h3 class="text-gray-400 text-sm mb-2">净利润</h3>
                    <p class="text-2xl font-bold text-white" id="dashboard-net-profit">¥0.00</p>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
                    <h3 class="text-gray-400 text-sm mb-2">距上次进账</h3>
                    <p class="text-2xl font-bold text-white"><span id="hours-since-income">0</span> 小时</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
                    <h3 class="text-lg font-bold mb-4">订单统计</h3>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="text-gray-400 text-sm">总订单</p>
                            <p class="text-xl font-bold" id="dashboard-total-orders">0</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">待收款</p>
                            <p class="text-xl font-bold text-yellow-500" id="dashboard-pending-orders">0</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">已收款</p>
                            <p class="text-xl font-bold text-green-500" id="dashboard-completed-orders">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-5">
                    <h3 class="text-lg font-bold mb-4">供应商统计</h3>
                    <p class="text-xl font-bold" id="dashboard-total-suppliers">0</p>
                    <p class="text-gray-400 text-sm">总供应商数量</p>
                </div>
            </div>
        </div>

        <!-- 订单看板 Tab -->
        <div id="tab-kanban" class="tab-content hidden flex gap-4 overflow-x-auto pb-4">
            <!-- 询价中 -->
            <div class="w-64 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold">询价中 <span data-count="inquiry" class="text-gray-400 text-sm">0</span></h3>
                    <button onclick="app.kanban.openQuickAdd()" class="bg-blue-600 text-white p-1 rounded text-xs"><i class="fas fa-plus"></i></button>
                </div>
                <div id="kanban-inquiry" class="min-h-[400px] bg-gray-900/50 rounded-lg p-2 border border-gray-800"></div>
            </div>
            <!-- PI阶段 -->
            <div class="w-64 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold">PI阶段 <span data-count="pi" class="text-gray-400 text-sm">0</span></h3>
                </div>
                <div id="kanban-pi" class="min-h-[400px] bg-gray-900/50 rounded-lg p-2 border border-gray-800"></div>
            </div>
            <!-- 生产中 -->
            <div class="w-64 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold">生产中 <span data-count="production" class="text-gray-400 text-sm">0</span></h3>
                </div>
                <div id="kanban-production" class="min-h-[400px] bg-gray-900/50 rounded-lg p-2 border border-gray-800"></div>
            </div>
            <!-- 已发货 -->
            <div class="w-64 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold">已发货 <span data-count="shipped" class="text-gray-400 text-sm">0</span></h3>
                </div>
                <div id="kanban-shipped" class="min-h-[400px] bg-gray-900/50 rounded-lg p-2 border border-gray-800"></div>
            </div>
            <!-- 已收款 -->
            <div class="w-64 flex-shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold">已收款 <span data-count="paid" class="text-gray-400 text-sm">0</span></h3>
                </div>
                <div id="kanban-paid" class="min-h-[400px] bg-gray-900/50 rounded-lg p-2 border border-gray-800"></div>
            </div>
        </div>

        <!-- 客户管理 Tab -->
        <div id="tab-crm" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">客户档案</h2>
                <button onclick="app.crm.openAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i> 添加客户</button>
            </div>
            <div id="customer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- 供应商 Tab -->
        <div id="tab-suppliers" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">供应商档案</h2>
                <button onclick="app.suppliers.openAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i> 添加供应商</button>
            </div>
            <div id="supplierList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- 支出管理 Tab -->
        <div id="tab-expenses" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">支出记录</h2>
                <button onclick="app.expenses.openAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-plus mr-2"></i> 添加支出</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full bg-gray-900 rounded-lg border border-gray-800">
                    <thead>
                        <tr class="bg-gray-800">
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">日期</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">分类</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-300">备注</th>
                            <th class="px-6 py-3 text-right text-sm font-medium text-gray-300">金额</th>
                            <th class="px-6 py-3 text-center text-sm font-medium text-gray-300">操作</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 看板快速添加订单模态框 -->
    <div id="kanban-quick-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="w-4/5 max-w-md bg-gray-900 border border-gray-800 rounded-xl p-8">
            <h3 class="text-xl font-bold mb-6">快速创建订单</h3>
            <div class="space-y-4">
                <input id="kanban-title" type="text" placeholder="订单标题 (必填)" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-blue-500 outline-none" aria-label="订单标题">
                <input id="kanban-customer" type="text" placeholder="客户名称" class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-blue-500 outline-none" aria-label="客户名称">
                <input id="kanban-amount" type="number" step="0.01" placeholder="订单金额 (必填)" class="w-full bg-black border border-gray-700 rounded p-3 text-white font-mono focus:border-blue-500 outline-none" aria-label="订单金额">
                <textarea id="kanban-note" rows="2" placeholder="订单备注..." class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-blue-500 outline-none" aria-label="订单备注"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="app.kanban.closeQuickModal()" class="w-1/2 bg-gray-800 text-white py-3 rounded-lg">取消</button>
                <button onclick="app.kanban.saveQuickOrder()" class="w-1/2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg" aria-label="创建订单">创建订单</button>
            </div>
        </div>
    </div>

    <!-- 供应商添加模态框 -->
    <div id="supplier-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="w-4/5 max-w-md bg-gray-900 border border-gray-800 rounded-xl p-8">
            <h3 class="text-xl font-bold mb-6">添加供应商</h3>
            <div class="space-y-4">
                <input id="supp-name" type="text" placeholder="供应商名称 (必填)" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                <input id="supp-product" type="text" placeholder="主营产品" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                <input id="supp-contact" type="text" placeholder="联系方式" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="app.suppliers.closeModal()" class="w-1/2 bg-gray-800 text-white py-3 rounded-lg">取消</button>
                <button onclick="app.suppliers.save()" class="w-1/2 bg-blue-600 text-white py-3 rounded-lg">保存</button>
            </div>
        </div>
    </div>

    <!-- 支出添加模态框 -->
    <div id="expense-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="w-4/5 max-w-md bg-gray-900 border border-gray-800 rounded-xl p-8">
            <h3 class="text-xl font-bold mb-6">添加支出</h3>
            <div class="space-y-4">
                <input id="exp-date" type="date" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                <select id="exp-category" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                    <option value="采购成本">采购成本</option>
                    <option value="物流费用">物流费用</option>
                    <option value="办公开销">办公开销</option>
                    <option value="其他支出">其他支出</option>
                </select>
                <input id="exp-amount" type="number" step="0.01" placeholder="支出金额 (必填)" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                <textarea id="exp-note" rows="2" placeholder="支出备注 (必填)" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="app.expenses.closeModal()" class="w-1/2 bg-gray-800 text-white py-3 rounded-lg">取消</button>
                <button onclick="app.expenses.save()" class="w-1/2 bg-blue-600 text-white py-3 rounded-lg">保存</button>
            </div>
        </div>
    </div>

    <!-- 客户添加模态框 -->
    <div id="customer-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="w-4/5 max-w-md bg-gray-900 border border-gray-800 rounded-xl p-8">
            <h3 class="text-xl font-bold mb-6">添加客户</h3>
            <div class="space-y-4">
                <input id="crm-name" type="text" placeholder="客户公司名 (必填)" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                <input id="crm-contact" type="text" placeholder="联系人" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                <select id="crm-country" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                    <option value="阿联酋">阿联酋</option>
                    <option value="沙特阿拉伯">沙特阿拉伯</option>
                    <option value="卡塔尔">卡塔尔</option>
                    <option value="其他">其他</option>
                </select>
                <input id="crm-whatsapp" type="text" placeholder="WhatsApp号码" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none">
                <textarea id="crm-address" rows="2" placeholder="地址" class="w-full bg-black border border-gray-700 rounded p-3 text-white outline-none"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="app.crm.closeModal()" class="w-1/2 bg-gray-800 text-white py-3 rounded-lg">取消</button>
                <button onclick="app.crm.save()" class="w-1/2 bg-blue-600 text-white py-3 rounded-lg">保存</button>
            </div>
        </div>
    </div>

    <!-- Toast 提示组件 -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 border border-gray-700 text-white px-6 py-4 rounded-lg shadow-2xl transform translate-x-full transition-transform duration-300 z-[100] flex items-center gap-4">
        <i id="toast-icon" class="fas fa-info-circle text-blue-500 text-xl"></i>
        <span id="toast-message" class="font-medium">Notification</span>
    </div>

    <!-- 核心脚本 -->
    <script>
        // 全局基础配置
        window.WORKBENCH_BASE = ''; // 本地部署时可修改为基础路径
        window.log = (msg, err) => err ? console.error(`[V5] ${msg}`, err) : console.log(`[V5] ${msg}`);

        // 工具函数（抽离公共方法）
        window.WorkbenchUtils = {
            // 验证必填项
            isRequired: (val) => {
                if (!val || val.trim() === '') {
                    return false;
                }
                return true;
            },
            // 验证正数
            isPositiveNumber: (val) => {
                const num = parseFloat(val);
                if (isNaN(num) || num <= 0) {
                    return false;
                }
                return true;
            },
            // 格式化金额
            formatAmount: (amount) => {
                const num = parseFloat(amount);
                return `¥${num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
            },
            // 格式化日期
            formatDate: (isoStr) => {
                const date = new Date(isoStr);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            },
            // Toast提示
            toast: (message, type = 'info') => {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toast-icon');
                const msg = document.getElementById('toast-message');
                
                // 设置图标和颜色
                const iconMap = {
                    success: { icon: 'fa-check-circle', color: 'text-green-500' },
                    error: { icon: 'fa-exclamation-circle', color: 'text-red-500' },
                    warning: { icon: 'fa-exclamation-triangle', color: 'text-yellow-500' },
                    info: { icon: 'fa-info-circle', color: 'text-blue-500' }
                };
                const config = iconMap[type] || iconMap.info;
                
                icon.className = `fas ${config.icon} ${config.color} text-xl`;
                msg.textContent = message;
                
                // 显示Toast
                toast.style.transform = 'translateX(0)';
                
                // 3秒后隐藏
                setTimeout(() => {
                    toast.style.transform = 'translateX(full)';
                }, 3000);
            }
        };

        // 本地存储工具
        window.WorkbenchStorage = {
            // 加载数据
            async load(key, defaultValue = []) {
                try {
                    const data = localStorage.getItem(`v5_erp_${key}`);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (err) {
                    log(`加载${key}失败`, err);
                    return defaultValue;
                }
            },
            // 保存数据
            async save(key, data) {
                try {
                    localStorage.setItem(`v5_erp_${key}`, JSON.stringify(data));
                    return true;
                } catch (err) {
                    log(`保存${key}失败`, err);
                    return false;
                }
            }
        };

        // 核心应用逻辑
        (function initApp() {
            // Tab切换绑定
            document.querySelectorAll('[data-tab], [data-mobile-tab]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab || btn.dataset.mobileTab;
                    app.switchTab(tabId);
                });
            });

            // 重试加载按钮绑定
            document.getElementById('retry-loading')?.addEventListener('click', () => {
                location.reload();
            });

            // 初始化日期输入框默认值
            const expDate = document.getElementById('exp-date');
            if (expDate) expDate.value = new Date().toISOString().split('T')[0];

            // 全局APP对象
            window.app = {
                // Tab切换逻辑
                switchTab: (tabId) => {
                    // 隐藏所有Tab
                    document.querySelectorAll('.tab-content').forEach(el => {
                        el.classList.remove('active');
                        el.style.display = 'none';
                    });
                    
                    // 移除所有导航高亮
                    document.querySelectorAll('.nav-tab, [data-mobile-tab]').forEach(btn => {
                        btn.classList.remove('text-white', 'border-b-2', 'border-red-600', 'text-red-500');
                        btn.classList.add('text-gray-400');
                    });

                    // 激活目标Tab
                    const target = document.getElementById(`tab-${tabId}`);
                    if (target) {
                        target.style.display = tabId === 'kanban' ? 'flex' : 'block';
                        setTimeout(() => target.classList.add('active'), 10);
                    }

                    // 激活导航高亮
                    const desktopBtn = document.querySelector(`button[data-tab="${tabId}"]`);
                    const mobileBtn = document.querySelector(`[data-mobile-tab="${tabId}"]`);
                    
                    if (desktopBtn) {
                        desktopBtn.classList.remove('text-gray-400');
                        desktopBtn.classList.add('text-white', 'border-b-2', 'border-red-600');
                    }
                    if (mobileBtn) {
                        mobileBtn.classList.remove('text-gray-400');
                        mobileBtn.classList.add('text-white', 'text-red-500');
                    }

                    // 触发模块渲染
                    if (tabId === 'kanban' && app.kanban.render) app.kanban.render();
                    if (tabId === 'suppliers' && app.suppliers.render) app.suppliers.render();
                    if (tabId === 'expenses' && app.expenses.render) app.expenses.render();
                    if (tabId === 'crm' && app.crm.render) app.crm.render();
                    if (tabId === 'dashboard' && app.calculateKPI) app.calculateKPI();
                },

                // 计算KPI数据
                calculateKPI: async () => {
                    try {
                        const orders = await WorkbenchStorage.load('orders', []);
                        const expenses = await WorkbenchStorage.load('expenses', []);
                        const currentMonth = new Date().getMonth();
                        const currentYear = new Date().getFullYear();
                        
                        // 本月营收（已收款订单）
                        const monthlyPaidOrders = orders.filter(order => {
                            if (order.status !== 'paid') return false;
                            const orderDate = new Date(order.createdAt);
                            return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
                        });
                        
                        const totalRevenue = monthlyPaidOrders.reduce((sum, order) => sum + parseFloat(order.amount || 0), 0);
                        const totalExpenses = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                        const netProfit = totalRevenue - totalExpenses;
                        
                        // 更新仪表盘数据
                        document.getElementById('dashboard-month-income').textContent = WorkbenchUtils.formatAmount(totalRevenue);
                        document.getElementById('dashboard-net-profit').textContent = WorkbenchUtils.formatAmount(netProfit);
                        document.getElementById('dashboard-total-orders').textContent = orders.length;
                        document.getElementById('dashboard-pending-orders').textContent = orders.filter(o => o.status !== 'paid').length;
                        document.getElementById('dashboard-completed-orders').textContent = orders.filter(o => o.status === 'paid').length;
                        
                        // 供应商统计
                        const suppliers = await WorkbenchStorage.load('suppliers', []);
                        document.getElementById('dashboard-total-suppliers').textContent = suppliers.length;
                        
                        // 距上次进账时间
                        const paidOrders = orders.filter(o => o.status === 'paid').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        if (paidOrders.length > 0) {
                            const lastPaidDate = new Date(paidOrders[0].createdAt);
                            const hoursSince = Math.floor((Date.now() - lastPaidDate.getTime()) / (1000 * 60 * 60));
                            document.getElementById('hours-since-income').textContent = hoursSince;
                        } else {
                            document.getElementById('hours-since-income').textContent = '∞';
                        }
                    } catch (err) {
                        log('计算KPI失败', err);
                        WorkbenchUtils.toast('数据统计失败', 'error');
                    }
                },

                // 数据导出备份
                exportData: async () => {
                    try {
                        const exportData = {
                            timestamp: new Date().toISOString(),
                            customers: await WorkbenchStorage.load('customers', []),
                            suppliers: await WorkbenchStorage.load('suppliers', []),
                            orders: await WorkbenchStorage.load('orders', []),
                            expenses: await WorkbenchStorage.load('expenses', []),
                            todayActions: JSON.parse(localStorage.getItem('v5_erp_today_actions') || '[]')
                        };
                        
                        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `V5_COMMANDER_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        WorkbenchUtils.toast('数据备份成功', 'success');
                    } catch (error) {
                        log('数据导出失败', error);
                        WorkbenchUtils.toast('数据备份失败', 'error');
                    }
                },

                // 退出系统
                logout: () => {
                    if (confirm('确定退出战时指挥台吗？')) {
                        localStorage.removeItem('v5_erp_unlock_time');
                        localStorage.removeItem('v5_erp_emergency_time');
                        location.reload();
                    }
                },

                // 生存模式
                survival: {
                    // 检查输入是否完整
                    checkInputs: () => {
                        const a1 = document.getElementById('action-1').value.trim();
                        const a2 = document.getElementById('action-2').value.trim();
                        const a3 = document.getElementById('action-3').value.trim();
                        const btn = document.getElementById('battle-start-btn');
                        
                        if (btn) {
                            const isComplete = a1 && a2 && a3;
                            btn.disabled = !isComplete;
                            btn.style.opacity = isComplete ? '1' : '0.3';
                            btn.style.cursor = isComplete ? 'pointer' : 'not-allowed';
                        }
                    },
                    // 启动系统
                    startBattle: () => {
                        const actions = [
                            document.getElementById('action-1').value.trim(),
                            document.getElementById('action-2').value.trim(),
                            document.getElementById('action-3').value.trim()
                        ];
                        localStorage.setItem('v5_erp_today_actions', JSON.stringify(actions));
                        localStorage.setItem('v5_erp_unlock_time', Date.now());
                        localStorage.removeItem('v5_erp_emergency_time');
                        
                        document.getElementById('iron-curtain').classList.add('hidden');
                        app.renderTodayActions(actions);
                        WorkbenchUtils.toast('系统启动成功，今日聚焦核心目标！', 'success');
                    },
                    // 紧急模式
                    emergencyOverride: () => {
                        if (confirm("启用10分钟紧急模式？超时后将自动退出！")) {
                            const emergencyTime = Date.now();
                            localStorage.setItem('v5_erp_emergency_time', emergencyTime);
                            localStorage.setItem('v5_erp_unlock_time', emergencyTime);
                            
                            document.getElementById('iron-curtain').classList.add('hidden');
                            document.getElementById('emergency-mode-warning').classList.remove('hidden');
                            
                            app.startEmergencyTimer();
                            WorkbenchUtils.toast('紧急模式已激活，剩余10分钟', 'warning');
                        }
                    },
                    // 初始化检查
                    initCheck: () => {
                        const lastUnlock = localStorage.getItem('v5_erp_unlock_time');
                        const emergencyTime = localStorage.getItem('v5_erp_emergency_time');
                        const isExpired = !lastUnlock || (Date.now() - lastUnlock > 30 * 60 * 1000);
                        
                        if (isExpired && !emergencyTime) {
                            document.getElementById('iron-curtain').classList.remove('hidden');
                        } else {
                            document.getElementById('iron-curtain').classList.add('hidden');
                            const actions = JSON.parse(localStorage.getItem('v5_erp_today_actions') || '[]');
                            if (actions.length === 3) app.renderTodayActions(actions);
                            if (emergencyTime) {
                                document.getElementById('emergency-mode-warning').classList.remove('hidden');
                                app.startEmergencyTimer();
                            }
                        }
                    }
                },

                // 渲染今日行动
                renderTodayActions: (actions) => {
                    const container = document.getElementById('actions-display');
                    if (!container || actions.length !== 3) return;
                    
                    const actionTemplates = [
                        { icon: 'fa-bullseye', color: 'text-red-500' },
                        { icon: 'fa-rocket', color: 'text-blue-500' },
                        { icon: 'fa-shield-alt', color: 'text-green-500' }
                    ];
                    
                    container.innerHTML = actions.map((action, index) => {
                        const template = actionTemplates[index];
                        return `
                            <div class="bg-gray-900/70 backdrop-blur border border-gray-800 rounded-xl p-5 hover:border-gray-700 transition">
                                <div class="flex items-center gap-3 mb-3">
                                    <i class="fas ${template.icon} ${template.color} text-xl"></i>
                                    <h4 class="font-bold text-white">第${index+1}优先级</h4>
                                </div>
                                <p class="text-gray-300 text-sm">${action}</p>
                            </div>
                        `;
                    }).join('');
                    container.classList.remove('hidden');
                },

                // 紧急模式倒计时
                startEmergencyTimer: () => {
                    const updateTimer = () => {
                        const emergencyTime = parseInt(localStorage.getItem('v5_erp_emergency_time') || '0');
                        const remainingMs = 10 * 60 * 1000 - (Date.now() - emergencyTime);
                        
                        if (remainingMs <= 0) {
                            localStorage.removeItem('v5_erp_emergency_time');
                            localStorage.removeItem('v5_erp_unlock_time');
                            location.reload();
                            return;
                        }
                        
                        const remainingMin = Math.floor(remainingMs / 60000);
                        const remainingSec = Math.floor((remainingMs % 60000) / 1000);
                        document.getElementById('emergency-timer').textContent = `${remainingMin}:${String(remainingSec).padStart(2, '0')}`;
                    };
                    
                    updateTimer();
                    setInterval(updateTimer, 1000);
                },

                // 供应商模块
                suppliers: {
                    openAddModal: () => {
                        document.getElementById('supp-name').value = '';
                        document.getElementById('supp-product').value = '';
                        document.getElementById('supp-contact').value = '';
                        document.getElementById('supplier-modal').classList.remove('hidden');
                    },
                    closeModal: () => {
                        document.getElementById('supplier-modal').classList.add('hidden');
                    },
                    save: async () => {
                        const name = document.getElementById('supp-name').value.trim();
                        if (!WorkbenchUtils.isRequired(name)) {
                            WorkbenchUtils.toast('供应商名称不能为空', 'error');
                            return;
                        }
                        
                        const newSupp = {
                            id: 'SUPP-' + Date.now(),
                            name: name,
                            product: document.getElementById('supp-product').value.trim(),
                            contact: document.getElementById('supp-contact').value.trim(),
                            createdAt: new Date().toISOString()
                        };
                        
                        const list = await WorkbenchStorage.load('suppliers', []);
                        list.push(newSupp);
                        const saveResult = await WorkbenchStorage.save('suppliers', list);
                        
                        if (saveResult) {
                            app.suppliers.closeModal();
                            app.suppliers.render();
                            app.calculateKPI();
                            WorkbenchUtils.toast('供应商已保存', 'success');
                        } else {
                            WorkbenchUtils.toast('保存失败，请重试', 'error');
                        }
                    },
                    render: async () => {
                        const container = document.getElementById('supplierList');
                        if (!container) return;
                        const list = await WorkbenchStorage.load('suppliers', []);
                        
                        if (list.length === 0) {
                            container.innerHTML = `
                                <div class="col-span-full text-center py-12 text-gray-500">
                                    <i class="fas fa-industry text-4xl mb-4 opacity-50"></i>
                                    <p>暂无供应商档案</p>
                                </div>
                            `;
                            return;
                        }
                        
                        container.innerHTML = list.map(s => `
                            <div class="bg-gray-900 border border-gray-800 p-5 rounded-xl hover:border-indigo-500 transition group">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="font-bold text-lg text-white">${s.name}</h3>
                                    <span class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 border border-gray-700">档案编号: ${s.id}</span>
                                </div>
                                <div class="text-sm text-gray-400 space-y-1">
                                    <p><i class="fas fa-box w-4 opacity-50"></i> 主营产品: ${s.product || '-'}</p>
                                    <p><i class="fas fa-phone w-4 opacity-50"></i> 联系方式: ${s.contact || '-'}</p>
                                    <p><i class="fas fa-calendar w-4 opacity-50"></i> 创建时间: ${WorkbenchUtils.formatDate(s.createdAt)}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                },

                // 支出模块
                expenses: {
                    openAddModal: () => {
                        document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
                        document.getElementById('exp-category').selectedIndex = 0;
                        document.getElementById('exp-amount').value = '';
                        document.getElementById('exp-note').value = '';
                        document.getElementById('expense-modal').classList.remove('hidden');
                    },
                    closeModal: () => {
                        document.getElementById('expense-modal').classList.add('hidden');
                    },
                    save: async () => {
                        const date = document.getElementById('exp-date').value;
                        const category = document.getElementById('exp-category').value;
                        const amount = document.getElementById('exp-amount').value;
                        const note = document.getElementById('exp-note').value.trim();
                        
                        // 表单验证
                        if (!WorkbenchUtils.isRequired(date)) return WorkbenchUtils.toast('请选择支出日期', 'error');
                        if (!WorkbenchUtils.isPositiveNumber(amount)) return WorkbenchUtils.toast('请输入大于0的金额', 'error');
                        if (!WorkbenchUtils.isRequired(note)) return WorkbenchUtils.toast('请填写支出备注', 'error');
                        
                        const newExp = {
                            id: 'EXP-' + Date.now(),
                            date: date,
                            category: category,
                            amount: parseFloat(amount).toFixed(2),
                            note: note,
                            createdAt: new Date().toISOString()
                        };
                        
                        const list = await WorkbenchStorage.load('expenses', []);
                        list.push(newExp);
                        const saveResult = await WorkbenchStorage.save('expenses', list);
                        
                        if (saveResult) {
                            app.expenses.closeModal();
                            app.expenses.render();
                            app.calculateKPI();
                            WorkbenchUtils.toast('支出记录已保存', 'success');
                        } else {
                            WorkbenchUtils.toast('保存失败，请重试', 'error');
                        }
                    },
                    render: async () => {
                        const container = document.getElementById('expense-list');
                        if (!container) return;
                        const list = await WorkbenchStorage.load('expenses', []);
                        
                        if (list.length === 0) {
                            container.innerHTML = `
                                <tr>
                                    <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                        <i class="fas fa-receipt text-4xl mb-4 opacity-50"></i>
                                        <p>暂无支出记录</p>
                                    </td>
                                </tr>
                            `;
                            return;
                        }
                        
                        // 按日期倒序排序
                        list.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        container.innerHTML = list.map(exp => `
                            <tr class="bg-gray-800 border-b border-gray-900 hover:bg-gray-700/50 transition">
                                <td class="px-6 py-4">${exp.date}</td>
                                <td class="px-6 py-4">${exp.category}</td>
                                <td class="px-6 py-4">${exp.note}</td>
                                <td class="px-6 py-4 text-right font-mono text-red-400">${WorkbenchUtils.formatAmount(exp.amount)}</td>
                                <td class="px-6 py-4 text-center">
                                    <button onclick="app.expenses.delete('${exp.id}')" class="text-red-500 hover:text-red-400" aria-label="删除支出记录">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    },
                    delete: async (id) => {
                        if (!confirm('确定删除该支出记录吗？删除后不可恢复！')) return;
                        
                        const list = await WorkbenchStorage.load('expenses', []);
                        const newList = list.filter(exp => exp.id !== id);
                        const saveResult = await WorkbenchStorage.save('expenses', newList);
                        
                        if (saveResult) {
                            app.expenses.render();
                            app.calculateKPI();
                            WorkbenchUtils.toast('支出记录已删除', 'success');
                        } else {
                            WorkbenchUtils.toast('删除失败，请重试', 'error');
                        }
                    }
                },

                // 客户模块
                crm: {
                    openAddModal: () => {
                        document.getElementById('crm-name').value = '';
                        document.getElementById('crm-contact').value = '';
                        document.getElementById('crm-country').selectedIndex = 0;
                        document.getElementById('crm-whatsapp').value = '';
                        document.getElementById('crm-address').value = '';
                        document.getElementById('customer-modal').classList.remove('hidden');
                    },
                    closeModal: () => {
                        document.getElementById('customer-modal').classList.add('hidden');
                    },
                    save: async () => {
                        const name = document.getElementById('crm-name').value.trim();
                        if (!WorkbenchUtils.isRequired(name)) return WorkbenchUtils.toast('客户公司名不能为空', 'error');
                        
                        const newCust = {
                            id: 'CUST-' + Date.now(),
                            company: name,
                            contact: document.getElementById('crm-contact').value.trim(),
                            country: document.getElementById('crm-country').value,
                            whatsapp: document.getElementById('crm-whatsapp').value.trim(),
                            address: document.getElementById('crm-address').value.trim(),
                            createdAt: new Date().toISOString()
                        };
                        
                        const list = await WorkbenchStorage.load('customers', []);
                        list.push(newCust);
                        const saveResult = await WorkbenchStorage.save('customers', list);
                        
                        if (saveResult) {
                            app.crm.closeModal();
                            app.crm.render();
                            WorkbenchUtils.toast('客户档案已保存', 'success');
                        } else {
                            WorkbenchUtils.toast('保存失败，请重试', 'error');
                        }
                    },
                    render: async () => {
                        const container = document.getElementById('customer-grid');
                        if (!container) return;
                        const list = await WorkbenchStorage.load('customers', []);
                        
                        if (list.length === 0) {
                            container.innerHTML = `
                                <div class="col-span-full text-center py-12 text-gray-500">
                                    <i class="fas fa-users text-4xl mb-4 opacity-50"></i>
                                    <p>暂无客户档案</p>
                                </div>
                            `;
                            return;
                        }
                        
                        container.innerHTML = list.map(c => `
                            <div class="bg-gray-900 border border-gray-800 p-5 rounded-xl hover:border-green-500 transition group">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="font-bold text-lg text-white">${c.company}</h3>
                                    <span class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-300 border border-gray-700">${c.country}</span>
                                </div>
                                <div class="text-sm text-gray-400 space-y-1">
                                    <p><i class="fas fa-user w-4 opacity-50"></i> ${c.contact || '-'}</p>
                                    <p><i class="fab fa-whatsapp w-4 opacity-50"></i> ${c.whatsapp || '-'}</p>
                                    <p class="truncate"><i class="fas fa-map-marker-alt w-4 opacity-50"></i> ${c.address || '-'}</p>
                                    <p><i class="fas fa-calendar w-4 opacity-50"></i> ${WorkbenchUtils.formatDate(c.createdAt)}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                },

                // 看板/订单模块
                kanban: {
                    openQuickAdd: () => {
                        document.getElementById('kanban-title').value = '';
                        document.getElementById('kanban-customer').value = '';
                        document.getElementById('kanban-amount').value = '';
                        document.getElementById('kanban-note').value = '';
                        document.getElementById('kanban-quick-modal').classList.remove('hidden');
                    },
                    closeQuickModal: () => {
                        document.getElementById('kanban-quick-modal').classList.add('hidden');
                    },
                    saveQuickOrder: async () => {
                        const title = document.getElementById('kanban-title').value.trim();
                        const customer = document.getElementById('kanban-customer').value.trim();
                        const amount = document.getElementById('kanban-amount').value;
                        const note = document.getElementById('kanban-note').value.trim();
                        
                        if (!WorkbenchUtils.isRequired(title)) return WorkbenchUtils.toast('订单标题不能为空', 'error');
                        if (!WorkbenchUtils.isPositiveNumber(amount)) return WorkbenchUtils.toast('请输入大于0的订单金额', 'error');
                        
                        const newOrder = {
                            id: 'ORDER-' + Date.now(),
                            title: title,
                            customer: customer,
                            amount: parseFloat(amount).toFixed(2),
                            note: note,
                            status: 'inquiry',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        const list = await WorkbenchStorage.load('orders', []);
                        list.push(newOrder);
                        const saveResult = await WorkbenchStorage.save('orders', list);
                        
                        if (saveResult) {
                            app.kanban.closeQuickModal();
                            app.kanban.render();
                            app.calculateKPI();
                            WorkbenchUtils.toast('订单立项成功', 'success');
                        } else {
                            WorkbenchUtils.toast('保存失败，请重试', 'error');
                        }
                    },
                    render: async () => {
                        const orders = await WorkbenchStorage.load('orders', []);
                        const statusMap = {
                            inquiry: document.getElementById('kanban-inquiry'),
                            pi: document.getElementById('kanban-pi'),
                            production: document.getElementById('kanban-production'),
                            shipped: document.getElementById('kanban-shipped'),
                            paid: document.getElementById('kanban-paid')
                        };
                        
                        // 清空所有列
                        Object.values(statusMap).forEach(el => el && (el.innerHTML = ''));
                        
                        // 渲染订单卡片
                        orders.forEach(order => {
                            const column = statusMap[order.status];
                            if (!column) return;
                            
                            const card = document.createElement('div');
                            card.className = 'kanban-card kanbanCardHover';
                            card.dataset.id = order.id;
                            card.dataset.status = order.status;
                            
                            card.innerHTML = `
                                <div class="kanban-card__title">${order.title}</div>
                                <div class="kanban-card__meta">
                                    <span>${order.customer || '未知客户'}</span>
                                    <span>${WorkbenchUtils.formatAmount(order.amount)}</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 truncate">${order.note || '无备注'}</div>
                                <div class="kanban-card__actions">
                                    <button onclick="app.kanban.updateStatus('${order.id}', 'next')" class="kanban-card__btn bg-blue-900/50 text-blue-400 hover:bg-blue-900" aria-label="推进订单状态">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button onclick="app.kanban.deleteOrder('${order.id}')" class="kanban-card__btn bg-red-900/50 text-red-400 hover:bg-red-900" aria-label="删除订单">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            
                            column.appendChild(card);
                        });
                        
                        // 更新列计数
                        ['inquiry', 'pi', 'production', 'shipped', 'paid'].forEach(status => {
                            const count = orders.filter(order => order.status === status).length;
                            const countEl = document.querySelector(`[data-count="${status}"]`);
                            if (countEl) countEl.textContent = count;
                        });
                    },
                    updateStatus: async (id, direction) => {
                        const orders = await WorkbenchStorage.load('orders', []);
                        const orderIndex = orders.findIndex(o => o.id === id);
                        if (orderIndex === -1) return WorkbenchUtils.toast('订单不存在', 'error');
                        
                        const statusFlow = ['inquiry', 'pi', 'production', 'shipped', 'paid'];
                        const currentIndex = statusFlow.indexOf(orders[orderIndex].status);
                        const newIndex = direction === 'next' 
                            ? Math.min(currentIndex + 1, statusFlow.length - 1) 
                            : Math.max(currentIndex - 1, 0);
                        
                        orders[orderIndex].status = statusFlow[newIndex];
                        orders[orderIndex].updatedAt = new Date().toISOString();
                        
                        const saveResult = await WorkbenchStorage.save('orders', orders);
                        if (saveResult) {
                            app.kanban.render();
                            app.calculateKPI();
                            WorkbenchUtils.toast(`订单状态已更新为：${statusFlow[newIndex]}`, 'info');
                        } else {
                            WorkbenchUtils.toast('状态更新失败', 'error');
                        }
                    },
                    deleteOrder: async (id) => {
                        if (!confirm('确定删除该订单吗？删除后不可恢复！')) return;
                        
                        const orders = await WorkbenchStorage.load('orders', []);
                        const newOrders = orders.filter(o => o.id !== id);
                        const saveResult = await WorkbenchStorage.save('orders', newOrders);
                        
                        if (saveResult) {
                            app.kanban.render();
                            app.calculateKPI();
                            WorkbenchUtils.toast('订单已删除', 'success');
                        } else {
                            WorkbenchUtils.toast('删除失败，请重试', 'error');
                        }
                    }
                }
            };

            // 初始化应用
            setTimeout(async () => {
                // 隐藏加载界面
                document.getElementById('system-loading').classList.add('hidden');
                
                // 初始化各模块
                app.survival.initCheck();
                await app.calculateKPI();
                app.suppliers.render();
                app.expenses.render();
                app.crm.render();
                app.kanban.render();
                
                log('应用初始化完成');
            }, 500);
        })();
    </script>
</body>
</html>
