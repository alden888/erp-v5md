<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>æˆ˜æ—¶æŒ‡æŒ¥å° V14.3 PRO ERP EDITION Â· B2B ä¸“ç”¨</title>
    
    <!-- é¢„è¿æ¥ä¼˜åŒ– -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin>
    
    <!-- Google Fonts - æ›´ç‹¬ç‰¹çš„å­—ä½“é€‰æ‹© -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // ç”Ÿäº§ç¯å¢ƒæ—¥å¿—æ§åˆ¶
        const isDev = window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1');
        const log = isDev ? console.log.bind(console) : () => {};
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 1: '#0a0a0a', 2: '#141414', 3: '#1e1e1e', 4: '#282828' },
                        accent: { red: '#dc2626', orange: '#ea580c', yellow: '#ca8a04', green: '#16a34a', blue: '#2563eb', purple: '#9333ea' },
                        column: '#0d1117'
                    },
                    fontFamily: {
                        sans: ['Space Grotesk', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 2s linear infinite'
                    }
                }
            }
        }
    </script>

    <style>
        /* åŸºç¡€é‡ç½® */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; margin: 0; padding: 0; }
        
        body {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #141414 50%, #0d1117 100%);
            color: #e5e7eb;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(220,38,38,0.4); border-radius: 3px; transition: background 0.2s; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(220,38,38,0.6); }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .loading-spinner {
            border: 3px solid rgba(220, 38, 38, 0.1);
            border-top-color: #dc2626;
            border-radius: 50%;
            width: 48px; height: 48px;
            animation: spin 0.8s linear infinite;
        }

        /* Tab åˆ‡æ¢ */
        .tab-content { display: none; height: calc(100vh - 64px); overflow-y: auto; }
        .tab-content.active { display: block; animation: fadeIn 0.25s ease-out; }
        
        /* çœ‹æ¿ä¸“ç”¨å¸ƒå±€ */
        #tab-kanban.active { display: flex; flex-direction: column; overflow: hidden; }
        .kanban-board { flex: 1; display: flex; gap: 1rem; overflow-x: auto; overflow-y: hidden; padding: 1rem 1.5rem; scroll-behavior: smooth; }
        .kanban-column { flex: 0 0 300px; display: flex; flex-direction: column; max-height: 100%; background: rgba(13,17,23,0.9); backdrop-filter: blur(12px); border-radius: 0.75rem; border: 1px solid rgba(75,85,99,0.3); }
        .kanban-column-header { padding: 1rem; border-bottom: 1px solid rgba(75,85,99,0.2); }
        .kanban-cards { flex: 1; overflow-y: auto; padding: 0.75rem; min-height: 100px; }
        
        /* çœ‹æ¿å¡ç‰‡ */
        .kanban-card {
            background: rgba(20,20,20,0.95);
            border: 1px solid rgba(75,85,99,0.3);
            border-radius: 0.5rem;
            padding: 0.875rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kanban-card:hover {
            border-color: rgba(220,38,38,0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* ç§»åŠ¨ç«¯å¯¼èˆª */
        .mobile-nav {
            position: fixed; inset: 0; background: rgba(10,10,10,0.98);
            z-index: 45; transform: translateX(100%); transition: transform 0.3s ease;
        }
        .mobile-nav.active { transform: translateX(0); }
        
        /* å¯¼èˆªæ¿€æ´»çŠ¶æ€ */
        .nav-tab { position: relative; transition: all 0.2s ease; }
        .nav-tab.active { color: #fff; }
        .nav-tab.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60%; height: 2px; background: #dc2626; border-radius: 1px; }

        /* Toast æç¤º */
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .toast.success { background: linear-gradient(135deg, #16a34a, #15803d); }
        .toast.error { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .toast.warning { background: linear-gradient(135deg, #ca8a04, #a16207); }
        .toast.info { background: linear-gradient(135deg, #2563eb, #1d4ed8); }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .mobile-hide { display: none !important; }
            .tab-content { height: calc(100vh - 60px); }
            .kanban-column { flex: 0 0 85vw; }
        }

        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        
        /* æ•°å­—å­—ä½“ */
        .font-mono { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>

<body>
    <!-- ==================== ç³»ç»ŸåŠ è½½ç•Œé¢ ==================== -->
    <div id="system-loading" class="fixed inset-0 z-[60] bg-dark-1 flex items-center justify-center">
        <div class="text-center max-w-md px-6">
            <div class="loading-spinner mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold text-red-500 mb-3 tracking-widest uppercase">System Initializing</h2>
            <p class="text-gray-400 text-sm mb-6">æ­£åœ¨è¿æ¥æˆ˜æ—¶æŒ‡æŒ¥ä¸­æ¢...</p>
            
            <div class="w-full bg-dark-3 rounded-full h-1.5 mb-3 overflow-hidden">
                <div id="loading-bar" class="bg-gradient-to-r from-red-600 to-orange-500 h-full w-0 transition-all duration-300 ease-out"></div>
            </div>
            <div id="loading-progress" class="text-xs text-gray-500 font-mono">0%</div>
            
            <div id="loading-error" class="hidden mt-6 p-4 bg-red-900/30 border border-red-800 rounded-lg text-red-300 text-sm text-left"></div>
        </div>
    </div>

    <!-- ==================== ç”Ÿå­˜æ¨¡å¼ç™»å½•ç•Œé¢ ==================== -->
    <div id="iron-curtain" class="fixed inset-0 z-50 bg-dark-1/98 hidden flex items-center justify-center">
        <div class="w-full max-w-lg p-8 animate-fade-in">
            <div class="text-center mb-10">
                <div class="text-6xl mb-4">ğŸ›¡ï¸</div>
                <h1 class="text-3xl font-black text-red-500 tracking-tight uppercase">Survival Mode</h1>
                <p class="text-gray-500 text-sm mt-2">ç°é‡‘æµä¿å«æˆ˜ Â· èšç„¦æ ¸å¿ƒç›®æ ‡</p>
            </div>

            <div class="space-y-4 mb-8">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-red-500 font-bold text-sm">01</span>
                    <input id="action-1" type="text" class="w-full bg-dark-2 border border-dark-4 rounded-lg py-3.5 pl-12 pr-4 text-white placeholder-gray-500 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="ä»Šæ—¥æé’±åŠ¨ä½œ (å¿…å¡«)" oninput="app.survival.checkInputs()">
                </div>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-red-500 font-bold text-sm">02</span>
                    <input id="action-2" type="text" class="w-full bg-dark-2 border border-dark-4 rounded-lg py-3.5 pl-12 pr-4 text-white placeholder-gray-500 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="æ ¸å¿ƒæ¨è¿›äº‹é¡¹ (å¿…å¡«)" oninput="app.survival.checkInputs()">
                </div>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-red-500 font-bold text-sm">03</span>
                    <input id="action-3" type="text" class="w-full bg-dark-2 border border-dark-4 rounded-lg py-3.5 pl-12 pr-4 text-white placeholder-gray-500 focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition" placeholder="å®¢æˆ·è·Ÿè¿›/ç»´æŠ¤ (å¿…å¡«)" oninput="app.survival.checkInputs()">
                </div>
            </div>

            <button id="battle-start-btn" disabled onclick="app.survival.startBattle()" class="w-full bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 disabled:opacity-30 disabled:cursor-not-allowed text-white font-bold py-4 rounded-lg transition-all shadow-lg shadow-red-900/30 flex items-center justify-center gap-3">
                <i class="fas fa-power-off"></i> å¯åŠ¨ç³»ç»Ÿ
            </button>
            
            <div class="mt-6 text-center">
                <button onclick="app.survival.emergencyOverride()" class="text-xs text-gray-600 hover:text-red-400 transition underline underline-offset-2">
                    âš¡ ç´§æ€¥æ¨¡å¼å…¥å£ (10åˆ†é’Ÿ)
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== é¡¶éƒ¨å¯¼èˆªæ  ==================== -->
    <header class="h-16 bg-dark-1/95 backdrop-blur-md border-b border-dark-4/50 flex items-center justify-between px-4 lg:px-6 fixed top-0 left-0 right-0 z-40">
        <div class="flex items-center gap-4">
            <div class="font-black text-lg tracking-tight text-white">
                <span class="text-red-500">V5</span> COMMANDER
            </div>
            <div id="emergency-warning" class="hidden px-2.5 py-1 bg-red-900/40 border border-red-500/30 rounded text-red-400 text-[10px] font-bold animate-pulse-slow">
                âš ï¸ EMERGENCY <span id="emergency-timer">10:00</span>
            </div>
        </div>

        <nav class="hidden md:flex items-center gap-1">
            <button onclick="app.switchTab('dashboard')" class="nav-tab active px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="dashboard">
                <i class="fas fa-chart-pie mr-2"></i>ä»ªè¡¨ç›˜
            </button>
            <button onclick="app.switchTab('kanban')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="kanban">
                <i class="fas fa-columns mr-2"></i>è®¢å•æˆ˜åœº
            </button>
            <button onclick="app.switchTab('crm')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="crm">
                <i class="fas fa-address-book mr-2"></i>å®¢æˆ·
            </button>
            <button onclick="app.switchTab('suppliers')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="suppliers">
                <i class="fas fa-industry mr-2"></i>ä¾›åº”å•†
            </button>
            <button onclick="app.switchTab('expenses')" class="nav-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition rounded-md" data-tab="expenses">
                <i class="fas fa-wallet mr-2"></i>æ”¯å‡º
            </button>
        </nav>

        <div class="flex items-center gap-3">
            <button class="md:hidden text-gray-400 hover:text-white p-2 transition" onclick="document.querySelector('.mobile-nav').classList.add('active')">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <div class="hidden md:flex items-center gap-3">
                <span id="sync-status" class="text-xs text-gray-500 flex items-center gap-1.5">
                    <i class="fas fa-circle text-green-500 text-[8px]"></i>åœ¨çº¿
                </span>
                <button onclick="app.logout()" class="text-gray-500 hover:text-red-400 p-2 transition" title="é€€å‡ºç³»ç»Ÿ">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ==================== ç§»åŠ¨ç«¯å¯¼èˆª ==================== -->
    <div class="mobile-nav flex flex-col p-6">
        <div class="flex justify-end mb-8">
            <button onclick="document.querySelector('.mobile-nav').classList.remove('active')" class="text-gray-400 hover:text-white text-2xl transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex flex-col gap-2">
            <button onclick="app.switchTab('dashboard'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition" data-mobile-tab="dashboard">
                <i class="fas fa-chart-pie mr-3 w-6"></i>ä»ªè¡¨ç›˜
            </button>
            <button onclick="app.switchTab('kanban'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition" data-mobile-tab="kanban">
                <i class="fas fa-columns mr-3 w-6"></i>è®¢å•æˆ˜åœº
            </button>
            <button onclick="app.switchTab('crm'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition" data-mobile-tab="crm">
                <i class="fas fa-address-book mr-3 w-6"></i>å®¢æˆ·æ¡£æ¡ˆ
            </button>
            <button onclick="app.switchTab('suppliers'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition" data-mobile-tab="suppliers">
                <i class="fas fa-industry mr-3 w-6"></i>ä¾›åº”å•†
            </button>
            <button onclick="app.switchTab('expenses'); document.querySelector('.mobile-nav').classList.remove('active')" class="text-left text-lg text-gray-300 hover:text-white py-3 px-4 rounded-lg hover:bg-dark-3 transition" data-mobile-tab="expenses">
                <i class="fas fa-wallet mr-3 w-6"></i>è¿è¥æ”¯å‡º
            </button>
        </div>
        <div class="mt-auto pt-6 border-t border-dark-4">
            <button onclick="app.logout()" class="w-full text-left text-gray-500 hover:text-red-400 py-3 px-4 rounded-lg hover:bg-dark-3 transition">
                <i class="fas fa-power-off mr-3 w-6"></i>é€€å‡ºç³»ç»Ÿ
            </button>
        </div>
    </div>

    <!-- ==================== ä¸»å†…å®¹åŒº ==================== -->
    <main class="pt-16 h-full">
        
        <!-- ä»ªè¡¨ç›˜ Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="container mx-auto p-6">
                <!-- KPI å¡ç‰‡ -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="glass rounded-xl p-5 hover:border-blue-500/30 transition group">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-chart-line text-blue-500"></i> Total Revenue
                        </div>
                        <div class="text-2xl font-bold text-blue-400 font-mono" id="kpi-revenue">Â¥0.00</div>
                        <div class="text-xs text-gray-600 mt-2">æœ¬æœˆç´¯è®¡è¥æ”¶</div>
                    </div>
                    <div class="glass rounded-xl p-5 hover:border-green-500/30 transition group">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-coins text-green-500"></i> Gross Profit
                        </div>
                        <div class="text-2xl font-bold text-green-400 font-mono" id="kpi-gross">Â¥0.00</div>
                        <div class="text-xs text-gray-600 mt-2">çœŸå®æ¯›åˆ© (æ‰£é™¤é‡‡è´­)</div>
                    </div>
                    <div class="glass rounded-xl p-5 hover:border-purple-500/30 transition group">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-piggy-bank text-purple-500"></i> Net Profit
                        </div>
                        <div class="text-2xl font-bold text-purple-400 font-mono" id="kpi-net">Â¥0.00</div>
                        <div class="text-xs text-gray-600 mt-2">å‡€åˆ©æ¶¦ (æ‰£é™¤è¿è¥)</div>
                    </div>
                    <div class="glass rounded-xl p-5 hover:border-red-500/30 transition relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 text-7xl text-red-500/10 group-hover:text-red-500/20 transition">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="text-xs text-red-400 uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-heartbeat text-red-500"></i> Survival Status
                        </div>
                        <div class="text-xl font-bold text-white">72h Safe</div>
                        <div class="text-xs text-red-400/70 mt-2">è·ä¸Šæ¬¡è¿›è´¦: <span id="hours-since-income" class="font-mono">0</span>h</div>
                    </div>
                </div>

                <!-- ä»Šæ—¥è¡ŒåŠ¨ -->
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-4 flex items-center gap-2">
                        <i class="fas fa-bullseye text-red-500"></i> Today's Focus
                    </h3>
                    <div id="actions-display" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass rounded-xl p-5 text-center text-gray-500">
                            <i class="fas fa-clipboard-list text-3xl mb-3 opacity-30"></i>
                            <p class="text-sm">å®Œæˆç”Ÿå­˜æ¨¡å¼ç™»å½•åæ˜¾ç¤ºä»Šæ—¥è¡ŒåŠ¨</p>
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·æ“ä½œ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="app.kanban.openQuickAdd()" class="glass p-5 rounded-xl hover:bg-blue-900/20 hover:border-blue-500/30 transition text-sm font-medium group">
                        <i class="fas fa-plus mb-3 block text-xl text-blue-500 group-hover:scale-110 transition-transform"></i> æ–°å¢è®¢å•
                    </button>
                    <button onclick="app.crm.openAddModal()" class="glass p-5 rounded-xl hover:bg-green-900/20 hover:border-green-500/30 transition text-sm font-medium group">
                        <i class="fas fa-user-plus mb-3 block text-xl text-green-500 group-hover:scale-110 transition-transform"></i> å½•å…¥å®¢æˆ·
                    </button>
                    <button onclick="app.expenses.openAddModal()" class="glass p-5 rounded-xl hover:bg-yellow-900/20 hover:border-yellow-500/30 transition text-sm font-medium group">
                        <i class="fas fa-receipt mb-3 block text-xl text-yellow-500 group-hover:scale-110 transition-transform"></i> è®°ä¸€ç¬”è´¦
                    </button>
                    <button onclick="app.exportData()" class="glass p-5 rounded-xl hover:bg-gray-700/30 hover:border-gray-500/30 transition text-sm font-medium group">
                        <i class="fas fa-download mb-3 block text-xl text-gray-400 group-hover:scale-110 transition-transform"></i> å¤‡ä»½æ•°æ®
                    </button>
                </div>
            </div>
        </div>

        <!-- çœ‹æ¿ Tab -->
        <div id="tab-kanban" class="tab-content">
            <div class="h-14 px-6 flex items-center justify-between border-b border-dark-4/50 bg-dark-1/80 backdrop-blur-sm">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-columns text-blue-500"></i> ä½œæˆ˜æŒ‡æŒ¥æ¿
                </h2>
                <button onclick="app.kanban.openQuickAdd()" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-blue-900/20 flex items-center gap-2">
                    <i class="fas fa-plus"></i> ç«‹é¡¹
                </button>
            </div>

            <div class="kanban-board" id="kanban-wrapper">
                <!-- è¯¢ç›˜åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-400 text-sm font-bold uppercase tracking-wide">New Inquiry</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-inquiry">0</span>
                        </div>
                    </div>
                    <div id="kanban-inquiry" class="kanban-cards"></div>
                </div>

                <!-- PIå·²å‘åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-yellow-400 text-sm font-bold uppercase tracking-wide">PI Sent</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-pi">0</span>
                        </div>
                    </div>
                    <div id="kanban-pi" class="kanban-cards"></div>
                </div>

                <!-- ç”Ÿäº§ä¸­åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-purple-400 text-sm font-bold uppercase tracking-wide">Production</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-production">0</span>
                        </div>
                    </div>
                    <div id="kanban-production" class="kanban-cards"></div>
                </div>

                <!-- å·²å‘è´§åˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-cyan-400 text-sm font-bold uppercase tracking-wide">Shipped</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-shipped">0</span>
                        </div>
                    </div>
                    <div id="kanban-shipped" class="kanban-cards"></div>
                </div>

                <!-- å·²å®Œæˆåˆ— -->
                <div class="kanban-column">
                    <div class="kanban-column-header">
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 text-sm font-bold uppercase tracking-wide">Paid & Done</span>
                            <span class="bg-dark-3 px-2 py-0.5 rounded text-xs text-gray-400 font-mono" id="count-paid">0</span>
                        </div>
                    </div>
                    <div id="kanban-paid" class="kanban-cards"></div>
                </div>
            </div>
        </div>

        <!-- å®¢æˆ· Tab -->
        <div id="tab-crm" class="tab-content">
            <div class="container mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">å®¢æˆ·èµ„äº§åº“</h2>
                    <button onclick="app.crm.openAddModal()" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-green-900/20">
                        <i class="fas fa-user-plus mr-2"></i> å½•å…¥å®¢æˆ·
                    </button>
                </div>
                <div id="customer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- ä¾›åº”å•† Tab -->
        <div id="tab-suppliers" class="tab-content">
            <div class="container mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">ä¾›åº”é“¾ç®¡ç†</h2>
                    <button onclick="app.suppliers.openAddModal()" class="bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-indigo-900/20">
                        <i class="fas fa-plus mr-2"></i> æ–°å¢ä¾›åº”å•†
                    </button>
                </div>
                <div id="supplier-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- æ”¯å‡º Tab -->
        <div id="tab-expenses" class="tab-content">
            <div class="container mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">èµ„é‡‘æµæ°´</h2>
                    <button onclick="app.expenses.openAddModal()" class="bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-yellow-900/20">
                        <i class="fas fa-plus mr-2"></i> è®°ä¸€ç¬”
                    </button>
                </div>
                <div class="glass rounded-xl overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="bg-dark-3/50 text-gray-300">
                            <tr>
                                <th class="px-6 py-4 font-semibold">æ—¥æœŸ</th>
                                <th class="px-6 py-4 font-semibold">ç±»åˆ«</th>
                                <th class="px-6 py-4 font-semibold">æ‘˜è¦</th>
                                <th class="px-6 py-4 text-right font-semibold">é‡‘é¢ (CNY)</th>
                                <th class="px-6 py-4 text-center font-semibold">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="expense-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- ==================== æ¨¡æ€æ¡†åŒºåŸŸ ==================== -->
    
    <!-- ä¾›åº”å•†æ¨¡æ€æ¡† -->
    <div id="supplier-modal" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-dark-2 border border-dark-4 p-6 rounded-xl w-full max-w-md shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-white">æ–°å¢ä¾›åº”å•†</h3>
                <button onclick="app.suppliers.closeModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="supp-name" type="text" placeholder="ä¾›åº”å•†åç§° (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition">
                <input id="supp-product" type="text" placeholder="ä¸»è¥äº§å“" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-indigo-500 outline-none transition">
                <input id="supp-contact" type="text" placeholder="è”ç³»äºº/ç”µè¯" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-indigo-500 outline-none transition">
            </div>
            <button onclick="app.suppliers.save()" class="w-full mt-6 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                ä¿å­˜æ¡£æ¡ˆ
            </button>
        </div>
    </div>

    <!-- æ”¯å‡ºæ¨¡æ€æ¡† -->
    <div id="expense-modal" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-dark-2 border border-dark-4 p-6 rounded-xl w-full max-w-md shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-white">è®°å½•æ”¯å‡º</h3>
                <button onclick="app.expenses.closeModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="exp-date" type="date" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white focus:border-yellow-500 outline-none transition">
                <select id="exp-category" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white focus:border-yellow-500 outline-none transition">
                    <option value="å·®æ—…">âœˆï¸ å·®æ—…/äº¤é€š</option>
                    <option value="æ‹›å¾…">ğŸ· å®¢æˆ·æ‹›å¾…</option>
                    <option value="æˆ¿ç§Ÿ">ğŸ¢ æˆ¿ç§Ÿ/æ°´ç”µ</option>
                    <option value="è¥é”€">ğŸ“¢ å¹¿å‘Š/æ ·å“</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–æ‚é¡¹</option>
                </select>
                <input id="exp-amount" type="number" step="0.01" min="0" placeholder="é‡‘é¢ (CNY)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white font-mono placeholder-gray-500 focus:border-yellow-500 outline-none transition">
                <input id="exp-note" type="text" placeholder="å¤‡æ³¨ (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-yellow-500 outline-none transition">
            </div>
            <button onclick="app.expenses.save()" class="w-full mt-6 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                ç¡®è®¤æ”¯å‡º
            </button>
        </div>
    </div>

    <!-- å®¢æˆ·æ¨¡æ€æ¡† -->
    <div id="customer-modal" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-dark-2 border border-dark-4 p-6 rounded-xl w-full max-w-md shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-white">å½•å…¥å®¢æˆ·</h3>
                <button onclick="app.crm.closeModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="crm-name" type="text" placeholder="å®¢æˆ·å…¬å¸å (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition">
                <input id="crm-contact" type="text" placeholder="è”ç³»äºº" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition">
                <select id="crm-country" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white focus:border-green-500 outline-none transition">
                    <option value="Philippines">ğŸ‡µğŸ‡­ è²å¾‹å®¾</option>
                    <option value="Turkey">ğŸ‡¹ğŸ‡· åœŸè€³å…¶</option>
                    <option value="UK">ğŸ‡¬ğŸ‡§ è‹±å›½</option>
                    <option value="Netherlands">ğŸ‡³ğŸ‡± è·å…°</option>
                    <option value="USA">ğŸ‡ºğŸ‡¸ ç¾å›½</option>
                    <option value="Germany">ğŸ‡©ğŸ‡ª å¾·å›½</option>
                    <option value="Other">ğŸŒ å…¶ä»–</option>
                </select>
                <input id="crm-whatsapp" type="text" placeholder="WhatsApp" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition">
                <textarea id="crm-address" rows="2" placeholder="å‘è´§åœ°å€..." class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-green-500 outline-none transition resize-none"></textarea>
            </div>
            <button onclick="app.crm.save()" class="w-full mt-6 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                ä¿å­˜æ¡£æ¡ˆ
            </button>
        </div>
    </div>

    <!-- è®¢å•å¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡† -->
    <div id="kanban-quick-modal" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-dark-2 border border-dark-4 p-6 rounded-xl w-full max-w-md shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-white">æ–°å¢è®¢å•ç«‹é¡¹</h3>
                <button onclick="app.kanban.closeQuickModal()" class="text-gray-500 hover:text-white transition text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <input id="kanban-title" type="text" placeholder="è®¢å•æ ‡é¢˜ (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none transition">
                <input id="kanban-customer" type="text" placeholder="å®¢æˆ·åç§°" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none transition">
                <input id="kanban-amount" type="number" step="0.01" min="0" placeholder="è®¢å•é‡‘é¢ (å¿…å¡«)" class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white font-mono placeholder-gray-500 focus:border-blue-500 outline-none transition">
                <textarea id="kanban-note" rows="2" placeholder="è®¢å•å¤‡æ³¨..." class="w-full bg-dark-1 border border-dark-4 rounded-lg p-3 text-white placeholder-gray-500 focus:border-blue-500 outline-none transition resize-none"></textarea>
            </div>
            <button onclick="app.kanban.saveQuickOrder()" class="w-full mt-6 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 rounded-lg transition shadow-lg">
                åˆ›å»ºè®¢å•
            </button>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container"></div>

    <!-- ==================== æ ¸å¿ƒ JavaScript ==================== -->
    <script>
    /**
     * V14.3 PRO - æ ¸å¿ƒåº”ç”¨æ¨¡å—
     * ç»Ÿä¸€çš„å­˜å‚¨å’Œåº”ç”¨é€»è¾‘ï¼Œä¿®å¤æ‰€æœ‰ç©ºå€¼ä¿æŠ¤é—®é¢˜
     */
    (function() {
        'use strict';

        // ==================== é…ç½®å¸¸é‡ ====================
        const CONFIG = {
            STORAGE_PREFIX: 'v5_erp_',
            KEYS: {
                ORDERS: 'v5_erp_orders',
                CUSTOMERS: 'v5_erp_customers',
                SUPPLIERS: 'v5_erp_suppliers',
                EXPENSES: 'v5_erp_expenses',
                TODAY_ACTIONS: 'v5_erp_today_actions',
                UNLOCK_TIME: 'v5_erp_unlock_time',
                EMERGENCY_TIME: 'v5_erp_emergency_time'
            },
            KANBAN_STATUS: ['inquiry', 'pi', 'production', 'shipped', 'paid'],
            UNLOCK_DURATION: 30 * 60 * 1000, // 30åˆ†é’Ÿ
            EMERGENCY_DURATION: 10 * 60 * 1000 // 10åˆ†é’Ÿ
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        const Utils = {
            // å®‰å…¨è·å– DOM å…ƒç´ 
            $(id) {
                return document.getElementById(id);
            },

            // å®‰å…¨è¯»å– localStorageï¼ˆæ°¸è¿œè¿”å›æ•°ç»„æˆ–å¯¹è±¡ï¼‰
            loadData(key, defaultValue = []) {
                try {
                    const data = localStorage.getItem(key);
                    if (!data) return defaultValue;
                    const parsed = JSON.parse(data);
                    // ç¡®ä¿è¿”å›æ­£ç¡®ç±»å‹
                    if (Array.isArray(defaultValue)) {
                        return Array.isArray(parsed) ? parsed : defaultValue;
                    }
                    return parsed || defaultValue;
                } catch (e) {
                    log('[Utils] æ•°æ®è¯»å–å¤±è´¥:', key, e);
                    return defaultValue;
                }
            },

            // å®‰å…¨å†™å…¥ localStorage
            saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    log('[Utils] æ•°æ®ä¿å­˜å¤±è´¥:', key, e);
                    return false;
                }
            },

            // HTML è½¬ä¹‰
            escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            // æ ¼å¼åŒ–é‡‘é¢
            formatAmount(amount) {
                const num = parseFloat(amount) || 0;
                return `Â¥${num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            },

            // æ ¼å¼åŒ–æ—¥æœŸ
            formatDate(dateStr) {
                if (!dateStr) return 'æœªçŸ¥';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('zh-CN');
                } catch {
                    return 'æœªçŸ¥';
                }
            },

            // ç”Ÿæˆå”¯ä¸€ ID
            generateId(prefix = 'item') {
                return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
            },

            // æ˜¾ç¤º Toast
            toast(message, type = 'info', duration = 3000) {
                const container = Utils.$('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
                toast.innerHTML = `
                    <span class="text-xl">${icons[type] || icons.info}</span>
                    <span class="font-medium">${Utils.escapeHtml(message)}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        };

        // ==================== ä¸»åº”ç”¨å¯¹è±¡ ====================
        window.app = {
            state: {
                emergencyTimer: null
            },

            // ========== ç”Ÿå­˜æ¨¡å¼ ==========
            survival: {
                checkInputs() {
                    const a1 = Utils.$('action-1')?.value?.trim();
                    const a2 = Utils.$('action-2')?.value?.trim();
                    const a3 = Utils.$('action-3')?.value?.trim();
                    const btn = Utils.$('battle-start-btn');
                    if (btn) {
                        btn.disabled = !(a1 && a2 && a3);
                    }
                },

                startBattle() {
                    const actions = [
                        Utils.$('action-1')?.value?.trim() || '',
                        Utils.$('action-2')?.value?.trim() || '',
                        Utils.$('action-3')?.value?.trim() || ''
                    ].filter(Boolean);

                    if (actions.length !== 3) {
                        Utils.toast('è¯·å¡«å†™å®Œæ•´çš„ä»Šæ—¥ä¸‰ä»¶äº‹', 'warning');
                        return;
                    }

                    Utils.saveData(CONFIG.KEYS.TODAY_ACTIONS, actions);
                    Utils.saveData(CONFIG.KEYS.UNLOCK_TIME, Date.now());
                    localStorage.removeItem(CONFIG.KEYS.EMERGENCY_TIME);

                    const curtain = Utils.$('iron-curtain');
                    if (curtain) curtain.classList.add('hidden');

                    app.renderTodayActions(actions);
                    Utils.toast('ç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼Œèšç„¦ä»Šæ—¥ç›®æ ‡ï¼', 'success');
                },

                emergencyOverride() {
                    if (!confirm('å¯ç”¨10åˆ†é’Ÿç´§æ€¥æ¨¡å¼ï¼Ÿè¶…æ—¶åå°†è‡ªåŠ¨é€€å‡ºï¼')) return;

                    const now = Date.now();
                    Utils.saveData(CONFIG.KEYS.EMERGENCY_TIME, now);
                    Utils.saveData(CONFIG.KEYS.UNLOCK_TIME, now);

                    const curtain = Utils.$('iron-curtain');
                    if (curtain) curtain.classList.add('hidden');

                    const warning = Utils.$('emergency-warning');
                    if (warning) warning.classList.remove('hidden');

                    app.startEmergencyTimer();
                    Utils.toast('ç´§æ€¥æ¨¡å¼å·²æ¿€æ´»ï¼Œå‰©ä½™10åˆ†é’Ÿ', 'warning');
                },

                initCheck() {
                    const lastUnlock = Utils.loadData(CONFIG.KEYS.UNLOCK_TIME, null);
                    const emergencyTime = Utils.loadData(CONFIG.KEYS.EMERGENCY_TIME, null);
                    const curtain = Utils.$('iron-curtain');

                    if (!curtain) return;

                    // æ£€æŸ¥ç´§æ€¥æ¨¡å¼
                    if (emergencyTime) {
                        const elapsed = Date.now() - emergencyTime;
                        if (elapsed < CONFIG.EMERGENCY_DURATION) {
                            curtain.classList.add('hidden');
                            const warning = Utils.$('emergency-warning');
                            if (warning) warning.classList.remove('hidden');
                            app.startEmergencyTimer();
                            return;
                        } else {
                            localStorage.removeItem(CONFIG.KEYS.EMERGENCY_TIME);
                        }
                    }

                    // æ£€æŸ¥æ­£å¸¸è§£é”
                    if (lastUnlock && (Date.now() - lastUnlock < CONFIG.UNLOCK_DURATION)) {
                        curtain.classList.add('hidden');
                        const actions = Utils.loadData(CONFIG.KEYS.TODAY_ACTIONS, []);
                        if (actions.length === 3) {
                            app.renderTodayActions(actions);
                        }
                    } else {
                        curtain.classList.remove('hidden');
                        localStorage.removeItem(CONFIG.KEYS.TODAY_ACTIONS);
                        localStorage.removeItem(CONFIG.KEYS.UNLOCK_TIME);
                    }
                }
            },

            // ç´§æ€¥æ¨¡å¼å€’è®¡æ—¶
            startEmergencyTimer() {
                if (app.state.emergencyTimer) {
                    clearInterval(app.state.emergencyTimer);
                }

                const timerEl = Utils.$('emergency-timer');
                const emergencyTime = Utils.loadData(CONFIG.KEYS.EMERGENCY_TIME, 0);

                app.state.emergencyTimer = setInterval(() => {
                    const remaining = CONFIG.EMERGENCY_DURATION - (Date.now() - emergencyTime);
                    
                    if (remaining <= 0) {
                        clearInterval(app.state.emergencyTimer);
                        localStorage.removeItem(CONFIG.KEYS.EMERGENCY_TIME);
                        localStorage.removeItem(CONFIG.KEYS.UNLOCK_TIME);
                        location.reload();
                        return;
                    }

                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    if (timerEl) {
                        timerEl.textContent = `${mins}:${String(secs).padStart(2, '0')}`;
                    }
                }, 1000);
            },

            // æ¸²æŸ“ä»Šæ—¥è¡ŒåŠ¨
            renderTodayActions(actions) {
                const container = Utils.$('actions-display');
                if (!container || !Array.isArray(actions) || actions.length === 0) return;

                const templates = [
                    { icon: 'fa-bullseye', color: 'text-red-500', bg: 'hover:border-red-500/30' },
                    { icon: 'fa-rocket', color: 'text-blue-500', bg: 'hover:border-blue-500/30' },
                    { icon: 'fa-shield-alt', color: 'text-green-500', bg: 'hover:border-green-500/30' }
                ];

                container.innerHTML = actions.map((action, i) => {
                    const t = templates[i] || templates[0];
                    return `
                        <div class="glass rounded-xl p-5 ${t.bg} transition">
                            <div class="flex items-center gap-3 mb-3">
                                <i class="fas ${t.icon} ${t.color} text-xl"></i>
                                <span class="text-xs text-gray-500 uppercase tracking-wider">ä¼˜å…ˆçº§ ${i + 1}</span>
                            </div>
                            <p class="text-gray-200 font-medium">${Utils.escapeHtml(action)}</p>
                        </div>
                    `;
                }).join('');
            },

            // ========== Tab åˆ‡æ¢ ==========
            switchTab(tabId) {
                // éšè—æ‰€æœ‰ Tab
                document.querySelectorAll('.tab-content').forEach(el => {
                    el.classList.remove('active');
                });

                // ç§»é™¤æ‰€æœ‰å¯¼èˆªé«˜äº®
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    btn.classList.remove('active');
                });

                // æ¿€æ´»ç›®æ ‡ Tab
                const target = Utils.$('tab-' + tabId);
                if (target) {
                    target.classList.add('active');
                }

                // æ¿€æ´»å¯¼èˆª
                const navBtn = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
                if (navBtn) {
                    navBtn.classList.add('active');
                }

                // è§¦å‘æ¨¡å—æ¸²æŸ“
                switch(tabId) {
                    case 'dashboard': app.calculateKPI(); break;
                    case 'kanban': app.kanban.render(); break;
                    case 'crm': app.crm.render(); break;
                    case 'suppliers': app.suppliers.render(); break;
                    case 'expenses': app.expenses.render(); break;
                }
            },

            // ========== KPI è®¡ç®— ==========
            calculateKPI() {
                const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                const expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // æœ¬æœˆå·²ä»˜æ¬¾è®¢å•
                const paidOrders = orders.filter(o => {
                    if (o.status !== 'paid') return false;
                    const d = new Date(o.createdAt);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const totalRevenue = paidOrders.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
                const totalExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const grossProfit = totalRevenue;
                const netProfit = grossProfit - totalExpenses;

                // æ›´æ–° DOM
                const revenueEl = Utils.$('kpi-revenue');
                const grossEl = Utils.$('kpi-gross');
                const netEl = Utils.$('kpi-net');
                
                if (revenueEl) revenueEl.textContent = Utils.formatAmount(totalRevenue);
                if (grossEl) grossEl.textContent = Utils.formatAmount(grossProfit);
                if (netEl) netEl.textContent = Utils.formatAmount(netProfit);

                // è®¡ç®—è·ä¸Šæ¬¡è¿›è´¦æ—¶é—´
                const lastPaid = orders
                    .filter(o => o.status === 'paid')
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

                const hoursEl = Utils.$('hours-since-income');
                if (hoursEl && lastPaid) {
                    const hours = Math.floor((Date.now() - new Date(lastPaid.createdAt)) / 3600000);
                    hoursEl.textContent = hours;
                }
            },

            // ========== çœ‹æ¿æ¨¡å— ==========
            kanban: {
                openQuickAdd() {
                    Utils.$('kanban-title').value = '';
                    Utils.$('kanban-customer').value = '';
                    Utils.$('kanban-amount').value = '';
                    Utils.$('kanban-note').value = '';
                    Utils.$('kanban-quick-modal')?.classList.remove('hidden');
                    Utils.$('kanban-title')?.focus();
                },

                closeQuickModal() {
                    Utils.$('kanban-quick-modal')?.classList.add('hidden');
                },

                saveQuickOrder() {
                    const title = Utils.$('kanban-title')?.value?.trim();
                    const customer = Utils.$('kanban-customer')?.value?.trim();
                    const amount = parseFloat(Utils.$('kanban-amount')?.value) || 0;
                    const note = Utils.$('kanban-note')?.value?.trim();

                    if (!title) {
                        Utils.toast('è¯·è¾“å…¥è®¢å•æ ‡é¢˜', 'warning');
                        return;
                    }
                    if (amount <= 0) {
                        Utils.toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'warning');
                        return;
                    }

                    const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                    orders.push({
                        id: Utils.generateId('ORDER'),
                        title,
                        customer: customer || 'æœªçŸ¥å®¢æˆ·',
                        amount: amount.toFixed(2),
                        note,
                        status: 'inquiry',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.ORDERS, orders);
                    app.kanban.closeQuickModal();
                    app.kanban.render();
                    app.calculateKPI();
                    Utils.toast('è®¢å•åˆ›å»ºæˆåŠŸ', 'success');
                },

                render() {
                    const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);

                    // æŒ‰çŠ¶æ€åˆ†ç»„
                    const grouped = {
                        inquiry: [],
                        pi: [],
                        production: [],
                        shipped: [],
                        paid: []
                    };

                    orders.forEach(order => {
                        const status = order.status || 'inquiry';
                        if (grouped[status]) {
                            grouped[status].push(order);
                        }
                    });

                    // æ¸²æŸ“æ¯åˆ—
                    CONFIG.KANBAN_STATUS.forEach(status => {
                        const container = Utils.$(`kanban-${status}`);
                        const countEl = Utils.$(`count-${status}`);
                        const list = grouped[status] || [];

                        if (countEl) countEl.textContent = list.length;

                        if (container) {
                            if (list.length === 0) {
                                container.innerHTML = '<div class="text-center text-gray-600 py-8 text-sm">æš‚æ— è®¢å•</div>';
                            } else {
                                container.innerHTML = list.map(order => app.kanban.renderCard(order)).join('');
                            }
                        }
                    });
                },

                renderCard(order) {
                    return `
                        <div class="kanban-card" data-id="${order.id}">
                            <div class="font-semibold text-white mb-1 truncate">${Utils.escapeHtml(order.title)}</div>
                            <div class="flex justify-between items-center text-xs text-gray-400 mb-2">
                                <span>${Utils.escapeHtml(order.customer)}</span>
                                <span class="font-mono text-green-400">${Utils.formatAmount(order.amount)}</span>
                            </div>
                            ${order.note ? `<div class="text-xs text-gray-500 truncate mb-2">${Utils.escapeHtml(order.note)}</div>` : ''}
                            <div class="flex justify-end gap-2 pt-2 border-t border-dark-4/50">
                                <button onclick="app.kanban.updateStatus('${order.id}', 'next')" class="text-xs px-2 py-1 bg-blue-900/50 text-blue-400 rounded hover:bg-blue-900 transition">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                                <button onclick="app.kanban.deleteOrder('${order.id}')" class="text-xs px-2 py-1 bg-red-900/50 text-red-400 rounded hover:bg-red-900 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                },

                updateStatus(id, direction) {
                    const orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                    const order = orders.find(o => o.id === id);
                    if (!order) return;

                    const currentIdx = CONFIG.KANBAN_STATUS.indexOf(order.status);
                    let newIdx = direction === 'next' 
                        ? Math.min(currentIdx + 1, CONFIG.KANBAN_STATUS.length - 1)
                        : Math.max(currentIdx - 1, 0);

                    order.status = CONFIG.KANBAN_STATUS[newIdx];
                    order.updatedAt = new Date().toISOString();

                    Utils.saveData(CONFIG.KEYS.ORDERS, orders);
                    app.kanban.render();
                    app.calculateKPI();
                    Utils.toast(`è®¢å•çŠ¶æ€å·²æ›´æ–°`, 'info');
                },

                deleteOrder(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®¢å•å—ï¼Ÿ')) return;

                    let orders = Utils.loadData(CONFIG.KEYS.ORDERS, []);
                    orders = orders.filter(o => o.id !== id);
                    Utils.saveData(CONFIG.KEYS.ORDERS, orders);
                    app.kanban.render();
                    app.calculateKPI();
                    Utils.toast('è®¢å•å·²åˆ é™¤', 'success');
                }
            },

            // ========== å®¢æˆ·æ¨¡å— ==========
            crm: {
                openAddModal() {
                    Utils.$('crm-name').value = '';
                    Utils.$('crm-contact').value = '';
                    Utils.$('crm-whatsapp').value = '';
                    Utils.$('crm-address').value = '';
                    Utils.$('customer-modal')?.classList.remove('hidden');
                    Utils.$('crm-name')?.focus();
                },

                closeModal() {
                    Utils.$('customer-modal')?.classList.add('hidden');
                },

                save() {
                    const name = Utils.$('crm-name')?.value?.trim();
                    if (!name) {
                        Utils.toast('è¯·è¾“å…¥å®¢æˆ·å…¬å¸å', 'warning');
                        return;
                    }

                    const customers = Utils.loadData(CONFIG.KEYS.CUSTOMERS, []);
                    customers.unshift({
                        id: Utils.generateId('CUST'),
                        company: name,
                        contact: Utils.$('crm-contact')?.value?.trim() || '',
                        country: Utils.$('crm-country')?.value || 'Other',
                        whatsapp: Utils.$('crm-whatsapp')?.value?.trim() || '',
                        address: Utils.$('crm-address')?.value?.trim() || '',
                        createdAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.CUSTOMERS, customers);
                    app.crm.closeModal();
                    app.crm.render();
                    Utils.toast('å®¢æˆ·æ¡£æ¡ˆå·²ä¿å­˜', 'success');
                },

                render() {
                    const container = Utils.$('customer-grid');
                    if (!container) return;

                    const customers = Utils.loadData(CONFIG.KEYS.CUSTOMERS, []);

                    if (customers.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full text-center py-12 text-gray-500">
                                <i class="fas fa-users text-4xl mb-4 opacity-30"></i>
                                <p>æš‚æ— å®¢æˆ·æ¡£æ¡ˆ</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = customers.map(c => `
                        <div class="glass rounded-xl p-5 hover:border-green-500/30 transition group">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-bold text-white text-lg">${Utils.escapeHtml(c.company)}</h3>
                                <span class="text-xs bg-dark-3 px-2 py-1 rounded text-gray-300">${Utils.escapeHtml(c.country)}</span>
                            </div>
                            <div class="text-sm text-gray-400 space-y-1.5">
                                <p><i class="fas fa-user w-4 opacity-50"></i> ${Utils.escapeHtml(c.contact) || '-'}</p>
                                <p><i class="fab fa-whatsapp w-4 opacity-50"></i> ${Utils.escapeHtml(c.whatsapp) || '-'}</p>
                                <p class="truncate"><i class="fas fa-map-marker-alt w-4 opacity-50"></i> ${Utils.escapeHtml(c.address) || '-'}</p>
                            </div>
                            <div class="flex justify-between items-center mt-4 pt-3 border-t border-dark-4/50 text-xs text-gray-500">
                                <span>${Utils.formatDate(c.createdAt)}</span>
                                <button onclick="app.crm.delete('${c.id}')" class="text-gray-600 hover:text-red-400 transition opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                },

                delete(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤å®¢æˆ·æ¡£æ¡ˆå—ï¼Ÿ')) return;
                    let customers = Utils.loadData(CONFIG.KEYS.CUSTOMERS, []);
                    customers = customers.filter(c => c.id !== id);
                    Utils.saveData(CONFIG.KEYS.CUSTOMERS, customers);
                    app.crm.render();
                    Utils.toast('å®¢æˆ·æ¡£æ¡ˆå·²åˆ é™¤', 'success');
                }
            },

            // ========== ä¾›åº”å•†æ¨¡å— ==========
            suppliers: {
                openAddModal() {
                    Utils.$('supp-name').value = '';
                    Utils.$('supp-product').value = '';
                    Utils.$('supp-contact').value = '';
                    Utils.$('supplier-modal')?.classList.remove('hidden');
                    Utils.$('supp-name')?.focus();
                },

                closeModal() {
                    Utils.$('supplier-modal')?.classList.add('hidden');
                },

                save() {
                    const name = Utils.$('supp-name')?.value?.trim();
                    if (!name) {
                        Utils.toast('è¯·è¾“å…¥ä¾›åº”å•†åç§°', 'warning');
                        return;
                    }

                    const suppliers = Utils.loadData(CONFIG.KEYS.SUPPLIERS, []);
                    suppliers.unshift({
                        id: Utils.generateId('SUPP'),
                        name,
                        product: Utils.$('supp-product')?.value?.trim() || '',
                        contact: Utils.$('supp-contact')?.value?.trim() || '',
                        createdAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.SUPPLIERS, suppliers);
                    app.suppliers.closeModal();
                    app.suppliers.render();
                    Utils.toast('ä¾›åº”å•†å·²ä¿å­˜', 'success');
                },

                render() {
                    const container = Utils.$('supplier-list');
                    if (!container) return;

                    const suppliers = Utils.loadData(CONFIG.KEYS.SUPPLIERS, []);

                    if (suppliers.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-full text-center py-12 text-gray-500">
                                <i class="fas fa-industry text-4xl mb-4 opacity-30"></i>
                                <p>æš‚æ— ä¾›åº”å•†æ¡£æ¡ˆ</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = suppliers.map(s => `
                        <div class="glass rounded-xl p-5 hover:border-indigo-500/30 transition group">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-bold text-white text-lg">${Utils.escapeHtml(s.name)}</h3>
                                <span class="text-xs bg-indigo-900/50 text-indigo-300 px-2 py-1 rounded border border-indigo-800/50">
                                    ${Utils.escapeHtml(s.product) || 'ç»¼åˆç±»'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-400 space-y-1.5">
                                <p><i class="fas fa-phone w-4 opacity-50"></i> ${Utils.escapeHtml(s.contact) || '-'}</p>
                                <p><i class="fas fa-calendar w-4 opacity-50"></i> ${Utils.formatDate(s.createdAt)}</p>
                            </div>
                            <div class="flex justify-end mt-4 pt-3 border-t border-dark-4/50">
                                <button onclick="app.suppliers.delete('${s.id}')" class="text-gray-600 hover:text-red-400 transition opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                },

                delete(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤ä¾›åº”å•†å—ï¼Ÿ')) return;
                    let suppliers = Utils.loadData(CONFIG.KEYS.SUPPLIERS, []);
                    suppliers = suppliers.filter(s => s.id !== id);
                    Utils.saveData(CONFIG.KEYS.SUPPLIERS, suppliers);
                    app.suppliers.render();
                    Utils.toast('ä¾›åº”å•†å·²åˆ é™¤', 'success');
                }
            },

            // ========== æ”¯å‡ºæ¨¡å— ==========
            expenses: {
                openAddModal() {
                    Utils.$('exp-date').value = new Date().toISOString().split('T')[0];
                    Utils.$('exp-amount').value = '';
                    Utils.$('exp-note').value = '';
                    Utils.$('expense-modal')?.classList.remove('hidden');
                    Utils.$('exp-amount')?.focus();
                },

                closeModal() {
                    Utils.$('expense-modal')?.classList.add('hidden');
                },

                save() {
                    const date = Utils.$('exp-date')?.value;
                    const category = Utils.$('exp-category')?.value;
                    const amount = parseFloat(Utils.$('exp-amount')?.value) || 0;
                    const note = Utils.$('exp-note')?.value?.trim();

                    if (!date) {
                        Utils.toast('è¯·é€‰æ‹©æ—¥æœŸ', 'warning');
                        return;
                    }
                    if (amount <= 0) {
                        Utils.toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'warning');
                        return;
                    }
                    if (!note) {
                        Utils.toast('è¯·å¡«å†™å¤‡æ³¨', 'warning');
                        return;
                    }

                    const expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);
                    expenses.unshift({
                        id: Utils.generateId('EXP'),
                        date,
                        category,
                        amount: amount.toFixed(2),
                        note,
                        createdAt: new Date().toISOString()
                    });

                    Utils.saveData(CONFIG.KEYS.EXPENSES, expenses);
                    app.expenses.closeModal();
                    app.expenses.render();
                    app.calculateKPI();
                    Utils.toast('æ”¯å‡ºè®°å½•å·²ä¿å­˜', 'success');
                },

                render() {
                    const container = Utils.$('expense-list');
                    if (!container) return;

                    const expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);

                    if (expenses.length === 0) {
                        container.innerHTML = `
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                    <i class="fas fa-receipt text-4xl mb-4 opacity-30"></i>
                                    <p>æš‚æ— æ”¯å‡ºè®°å½•</p>
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    // æŒ‰æ—¥æœŸå€’åº
                    const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

                    container.innerHTML = sorted.map(e => `
                        <tr class="bg-dark-2/50 border-b border-dark-4/30 hover:bg-dark-3/50 transition">
                            <td class="px-6 py-4 font-mono text-sm">${Utils.escapeHtml(e.date)}</td>
                            <td class="px-6 py-4">${Utils.escapeHtml(e.category)}</td>
                            <td class="px-6 py-4">${Utils.escapeHtml(e.note)}</td>
                            <td class="px-6 py-4 text-right font-mono text-red-400">${Utils.formatAmount(e.amount)}</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="app.expenses.delete('${e.id}')" class="text-gray-600 hover:text-red-400 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                },

                delete(id) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ”¯å‡ºè®°å½•å—ï¼Ÿ')) return;
                    let expenses = Utils.loadData(CONFIG.KEYS.EXPENSES, []);
                    expenses = expenses.filter(e => e.id !== id);
                    Utils.saveData(CONFIG.KEYS.EXPENSES, expenses);
                    app.expenses.render();
                    app.calculateKPI();
                    Utils.toast('æ”¯å‡ºè®°å½•å·²åˆ é™¤', 'success');
                }
            },

            // ========== æ•°æ®å¯¼å‡º ==========
            exportData() {
                try {
                    const exportData = {
                        version: 'V14.3-PRO',
                        timestamp: new Date().toISOString(),
                        orders: Utils.loadData(CONFIG.KEYS.ORDERS, []),
                        customers: Utils.loadData(CONFIG.KEYS.CUSTOMERS, []),
                        suppliers: Utils.loadData(CONFIG.KEYS.SUPPLIERS, []),
                        expenses: Utils.loadData(CONFIG.KEYS.EXPENSES, []),
                        todayActions: Utils.loadData(CONFIG.KEYS.TODAY_ACTIONS, [])
                    };

                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `V5_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    Utils.toast('æ•°æ®å¤‡ä»½æˆåŠŸ', 'success');
                } catch (e) {
                    Utils.toast('æ•°æ®å¤‡ä»½å¤±è´¥', 'error');
                }
            },

            // ========== é€€å‡ºç³»ç»Ÿ ==========
            logout() {
                if (!confirm('ç¡®å®šé€€å‡ºæˆ˜æ—¶æŒ‡æŒ¥å°å—ï¼Ÿ')) return;
                localStorage.removeItem(CONFIG.KEYS.UNLOCK_TIME);
                localStorage.removeItem(CONFIG.KEYS.EMERGENCY_TIME);
                location.reload();
            },

            // ========== åˆå§‹åŒ– ==========
            init() {
                log('[App] åˆå§‹åŒ–å¼€å§‹...');

                // åˆå§‹åŒ–æ”¯å‡ºæ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼
                const expDate = Utils.$('exp-date');
                if (expDate) {
                    expDate.value = new Date().toISOString().split('T')[0];
                }

                // æ£€æŸ¥ç”Ÿå­˜æ¨¡å¼
                app.survival.initCheck();

                // åˆå§‹åŒ–å„æ¨¡å—
                app.calculateKPI();
                app.kanban.render();
                app.crm.render();
                app.suppliers.render();
                app.expenses.render();

                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    const loading = Utils.$('system-loading');
                    if (loading) {
                        loading.style.opacity = '0';
                        setTimeout(() => loading.style.display = 'none', 300);
                    }
                }, 500);

                log('[App] âœ… åˆå§‹åŒ–å®Œæˆ');
            }
        };

        // ==================== åŠ è½½è¿›åº¦æ¨¡æ‹Ÿ ====================
        function simulateLoading() {
            const bar = Utils.$('loading-bar');
            const progress = Utils.$('loading-progress');
            let percent = 0;

            const interval = setInterval(() => {
                percent += Math.random() * 15 + 5;
                if (percent > 95) percent = 95;

                if (bar) bar.style.width = `${percent}%`;
                if (progress) progress.textContent = `${Math.floor(percent)}%`;

                if (percent >= 95) {
                    clearInterval(interval);
                    // å®ŒæˆåŠ è½½
                    setTimeout(() => {
                        if (bar) bar.style.width = '100%';
                        if (progress) progress.textContent = '100%';
                        // åˆå§‹åŒ–åº”ç”¨
                        app.init();
                    }, 200);
                }
            }, 100);
        }

        // ==================== é¡µé¢å¸è½½æ¸…ç† ====================
        window.addEventListener('beforeunload', () => {
            if (app.state.emergencyTimer) {
                clearInterval(app.state.emergencyTimer);
            }
        });

        // ==================== DOM åŠ è½½å®Œæˆåå¯åŠ¨ ====================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', simulateLoading);
        } else {
            simulateLoading();
        }

    })();
    </script>
</body>
</html>
